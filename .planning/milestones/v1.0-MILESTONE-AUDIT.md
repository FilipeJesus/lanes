---
milestone: v1.0
audited: 2026-02-10T15:15:00Z
status: tech_debt
scores:
  requirements: 20/20
  phases: 5/5
  integration: 23/23
  flows: 5/5
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 02-agent-abstraction-enhancement
    items:
      - "isCliAvailable() should add regex validation on cliCommand parameter for defense-in-depth (execFile mitigates injection but validation adds safety)"
      - "parseStatus() does not validate status values against getValidStatusStates() in both CodexAgent and ClaudeCodeAgent"
      - "hooklessTerminals Map not cleared on extension deactivation"
  - phase: 03-codex-cli-integration
    items:
      - "Duplicate escapeForSingleQuotes() in both CodexAgent and ClaudeCodeAgent — extract to base class"
      - "Duplicate validateSessionId() in both agent classes — extract to base class"
      - "Duplicate SESSION_ID_PATTERN regex (3 copies) — consolidate"
      - "No unit tests for captureSessionId() (fs mocking complexity with ES modules)"
      - "Date comparison uses > on Date objects — use .getTime() for explicitness"
      - ".js extension in dynamic import of CodexAgent — remove for consistency"
  - phase: 04-ui-integration
    items:
      - "Duplicate window.addEventListener('message') handlers in webview JavaScript"
      - "'active' state falls through to default in getIconForStatus — no visual differentiation for active sessions"
  - phase: 05-testing-validation
    items:
      - "Source-reading tests (verifying factory.ts source) are fragile — prefer behavior-based tests when ES module stubbing is resolved"
      - "MockWebviewView uses unsafe Partial<> pattern with double-cast"
      - "Private method access via unknown cast lacks compile-time safety"
      - "Fixed setTimeout(10) in async tests is flaky"
      - "1 pre-existing test failure in Git Base Branch test (worktree detection) — not caused by this milestone"
  - phase: general
    items:
      - "getWorkflowOrchestratorInstructions duplicated in 3 files (one is dead code in SessionService.ts)"
      - "REQUIREMENTS.md traceability table not updated for phases 3-5 (still shows Pending)"
---

# Milestone v1.0 Audit Report: Codex CLI Support

**Milestone:** v1.0 — Add Codex CLI Support to Lanes
**Audited:** 2026-02-10T15:15:00Z
**Status:** tech_debt (all requirements met, no critical blockers, accumulated tech debt)

## Executive Summary

All 20 requirements satisfied across 5 phases. All 5 E2E user flows verified. Cross-phase integration fully wired with no broken connections, orphaned exports, or dead code paths. 705 tests passing (57 new). The milestone has accumulated 17 tech debt items across phases, none of which are blockers.

## Requirements Coverage

| Requirement | Phase | Status | Evidence |
|-------------|-------|--------|----------|
| REQ-F1: Eliminate hardcoded Claude assumptions | Phase 1 | SATISFIED | Zero Claude strings outside codeAgents/. All paths use agent methods. |
| REQ-F2: Agent-agnostic service naming | Phase 1 | SATISFIED | AgentSessionProvider, AgentSessionData, getAgentStatus. Zero Claude names in shared code. |
| REQ-F3: Clean abstraction boundary | Phase 1 | SATISFIED | CodeAgent via DI everywhere. Single factory instantiation point. |
| REQ-A1: Agent factory with VS Code setting | Phase 2 | SATISFIED | Factory with hardcoded map, `lanes.defaultAgent` setting, claude/codex enum. |
| REQ-A2: Per-session agent selection | Phase 2+4 | SATISFIED | agentName in session metadata, dropdown in form, persists across restarts. |
| REQ-A3: Agent-specific session tracking | Phase 2 | SATISFIED | supportsHooks() distinguishes strategies. Hookless agents get active/idle via terminal lifecycle. |
| REQ-A4: Format-agnostic settings service | Phase 2 | SATISFIED | SettingsFormatService with JSON and TOML. Format determined by agent. |
| REQ-C1: CodexCodeAgent implementation | Phase 3 | SATISFIED | Extends CodeAgent, all 17 abstract methods implemented, CLI command: codex. |
| REQ-C2: Codex start command building | Phase 3 | SATISFIED | Generates `codex [--sandbox <mode> --ask-for-approval <mode>] ['<prompt>']`. |
| REQ-C3: Codex resume command building | Phase 3 | SATISFIED | Generates `codex resume <UUID>`. Strict UUID validation, no --last fallback. |
| REQ-C4: Codex permission mode mapping | Phase 3 | SATISFIED | 2 modes: acceptEdits (workspace-write/on-failure), bypassPermissions (danger-full-access/never). |
| REQ-C5: Codex session tracking | Phase 3 | SATISFIED | captureSessionId polls ~/.codex/sessions/ filesystem. Strict error on failure. |
| REQ-C6: Codex terminal identification | Phase 3 | SATISFIED | "Codex: <name>" terminal title, blue robot icon (vs Claude green). |
| REQ-U1: Agent selector in session form | Phase 4 | SATISFIED | Dropdown defaults to lanes.defaultAgent, hidden when 1 agent, disabled for unavailable. |
| REQ-U2: Agent-specific permission UI | Phase 4 | SATISFIED | Permission toggle works for both agents. CodexAgent maps to Codex flags via getPermissionFlag(). |
| REQ-U3: Terminal differentiation | Phase 3+4 | SATISFIED | Agent-specific names and icons via getTerminalName()/getTerminalIcon(). |
| REQ-T1: CodexCodeAgent unit tests | Phase 5 | SATISFIED | 26 tests covering commands, permissions, configuration. |
| REQ-T2: Agent factory tests | Phase 5 | SATISFIED | 12 tests covering creation, singleton, unknown names, CLI availability. |
| REQ-T3: Session form agent selection tests | Phase 5 | SATISFIED | 10 tests covering dropdown, permissions per agent, callback integration. |
| REQ-T4: Backward compatibility tests | Phase 5 | SATISFIED | 9 tests for legacy commands, session data, hook configs, agent coexistence. 705 total passing. |

**Score: 20/20 requirements satisfied**

## Phase Verification Summary

| Phase | Status | Score | Verifier | Date |
|-------|--------|-------|----------|------|
| 1. Foundation Refactoring | PASSED | 4/4 | gsd-verifier | 2026-02-10 |
| 2. Agent Abstraction Enhancement | PASSED | 4/4 | gsd-verifier | 2026-02-10 |
| 3. Codex CLI Integration | PASSED | 5/5 | gsd-verifier | 2026-02-10 |
| 4. UI Integration | PASSED | 8/8 | gsd-verifier | 2026-02-10 |
| 5. Testing & Validation | PASSED | 4/4 | gsd-verifier | 2026-02-10 |

**Score: 5/5 phases passed**

## Cross-Phase Integration

| From | To | Connections | Status |
|------|----|-------------|--------|
| Phase 1 → Phase 2 | Agent-neutral architecture, DI, lanes.* commands | WIRED |
| Phase 2 → Phase 3 | Factory, CodexAgent stub, supportsHooks(), settings format | WIRED |
| Phase 3 → Phase 4 | Codex commands, permission modes, session capture, terminal icons | WIRED |
| Phase 4 → Phase 5 | Agent dropdown, callback signature, CLI availability | WIRED |

**Score: 23/23 exports connected, 0 orphaned**

## E2E Flow Verification

| Flow | Status | Key Path |
|------|--------|----------|
| Create Codex Session | COMPLETE | Form → Callback → Factory → Agent → Terminal → Capture |
| Create Claude Session (backward compat) | COMPLETE | Form → Callback → Factory → ClaudeAgent → Terminal |
| Resume Codex Session | COMPLETE | Session file → Resume command → UUID validation → Terminal |
| Mixed Agent Availability | COMPLETE | Activation → CLI checks → Dropdown visibility → Fallback |
| Legacy Command Compatibility | COMPLETE | claudeWorktrees.* → lanes.* forwarding (15 aliases) |

**Score: 5/5 flows complete**

## Tech Debt Summary

### By Phase

**Phase 2: Agent Abstraction Enhancement (3 items)**
- `isCliAvailable()` should add regex validation on `cliCommand` for defense-in-depth
- `parseStatus()` does not validate status values against `getValidStatusStates()`
- `hooklessTerminals` Map not cleared on extension deactivation

**Phase 3: Codex CLI Integration (6 items)**
- Duplicate `escapeForSingleQuotes()` in both agent classes — extract to base
- Duplicate `validateSessionId()` in both agent classes — extract to base
- Duplicate `SESSION_ID_PATTERN` regex (3 copies) — consolidate
- No unit tests for `captureSessionId()` (ES module stubbing complexity)
- Date comparison uses `>` on Date objects — use `.getTime()`
- `.js` extension in dynamic import of CodexAgent

**Phase 4: UI Integration (2 items)**
- Duplicate `window.addEventListener('message')` handlers in webview JS
- `'active'` status state has no visual differentiation in `getIconForStatus`

**Phase 5: Testing & Validation (5 items)**
- Source-reading tests are fragile (verify source text not behavior)
- `MockWebviewView` uses unsafe `Partial<>` with double-cast
- Private method access via `unknown` cast
- Fixed `setTimeout(10)` in async tests is flaky
- 1 pre-existing test failure in git worktree detection (not caused by milestone)

**General (2 items)**
- `getWorkflowOrchestratorInstructions` duplicated in 3 files (one is dead code)
- REQUIREMENTS.md traceability table not updated for phases 3-5

### Total: 18 items across 5 categories

**Severity Breakdown:**
- Critical blockers: 0
- Important (should fix before next milestone): 3 (parseStatus validation, regex validation, duplicate utilities)
- Minor (cleanup): 15

## Test Results

```
705 passing (6s)
4 pending
1 failing (pre-existing, unrelated to milestone)
```

- 57 new tests added across 4 test files
- Zero regressions introduced
- TypeScript compilation clean (0 errors)
- ESLint clean

## Conclusion

Milestone v1.0 achieves its definition of done: users can create, open, resume, and delete Codex sessions via the Lanes sidebar with the same reliability and isolation as Claude Code sessions. All 20 requirements are satisfied, all 5 E2E flows work end-to-end, and cross-phase integration is fully wired. Accumulated tech debt (18 items) is non-blocking and can be addressed in a future cleanup phase or next milestone.

---

_Audited: 2026-02-10T15:15:00Z_
_Auditor: GSD Milestone Audit_
