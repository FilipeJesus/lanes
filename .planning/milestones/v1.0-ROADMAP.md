# Milestone v1.0: Codex CLI Support

**Status:** SHIPPED 2026-02-10
**Phases:** 1-5
**Total Plans:** 12

## Overview

Added OpenAI Codex CLI as a second supported agent in Lanes. Eliminated hardcoded Claude assumptions, enhanced the CodeAgent abstraction to support agents without hook systems, implemented the CodexCodeAgent with CLI command building and filesystem-based session capture, integrated agent selection UI, and validated the multi-agent system with comprehensive tests.

## Phases

### Phase 1: Foundation Refactoring

**Goal**: Codebase is agent-agnostic with no hardcoded Claude assumptions outside agent classes
**Depends on**: Nothing (first phase)
**Requirements**: REQ-F1, REQ-F2, REQ-F3
**Plans**: 4 plans

Plans:
- [x] 01-01: Replace hardcoded file paths, watch patterns, terminal names with CodeAgent method calls
- [x] 01-02: Generalize localSettings.ts to be agent-aware; fix tests for signature changes
- [x] 01-03: Rename ClaudeSessionProvider to AgentSessionProvider, update all production imports
- [x] 01-04: Update command/view IDs to lanes.*, add backward-compatible aliases, update all test files

**Details:**
- All file paths use agent method calls instead of string literals
- Services have agent-neutral names (AgentSessionProvider, AgentSessionData)
- All services receive CodeAgent via dependency injection
- 15 backward-compatible command aliases registered for legacy claudeWorktrees.* commands

### Phase 2: Agent Abstraction Enhancement

**Goal**: Infrastructure supports multiple agents with different capabilities (hooks vs polling, JSON vs TOML)
**Depends on**: Phase 1
**Requirements**: REQ-A1, REQ-A2, REQ-A3, REQ-A4
**Plans**: 3 plans

Plans:
- [x] 02-01: Agent factory with hardcoded map, singleton lifecycle, CLI validation, lanes.defaultAgent setting, stub CodexAgent
- [x] 02-02: Session metadata agentName field, hookless terminal lifecycle tracking, session file writing for hookless agents
- [x] 02-03: Format-agnostic settings service with JSON and TOML support via @iarna/toml

**Details:**
- Factory pattern with singleton caching via Map
- CLI availability check using execFile with args array
- supportsHooks() method distinguishes hook-based vs hookless agents
- SettingsFormatService abstracts JSON/TOML format differences
- Lazy TOML import for performance

### Phase 3: Codex CLI Integration

**Goal**: CodexCodeAgent fully implements CodeAgent interface with proper CLI commands, permission mapping, and session ID capture
**Depends on**: Phase 2
**Requirements**: REQ-C1, REQ-C2, REQ-C3, REQ-C4, REQ-C5, REQ-C6
**Plans**: 2 plans

Plans:
- [x] 03-01: Implement command building, permission mode mapping, shell escaping, and UUID validation in CodexAgent
- [x] 03-02: Session ID capture via filesystem polling and integration into TerminalService post-start flow

**Details:**
- Dual-flag permission modes: acceptEdits (workspace-write/on-failure), bypassPermissions (danger-full-access/never)
- Shell escaping via escapeForSingleQuotes for prompt safety
- UUID validation for session IDs with strict error on capture failure
- Filesystem polling of ~/.codex/sessions/ with 10-second timeout
- Fire-and-forget integration into terminal startup flow

### Phase 4: UI Integration

**Goal**: Users can select agent during session creation and distinguish agent types visually in terminals
**Depends on**: Phase 3
**Requirements**: REQ-U1, REQ-U2, REQ-U3
**Plans**: 1 plan

Plans:
- [x] 04-01: Agent dropdown in session form with CLI availability checks, callback wiring, and test updates

**Details:**
- Agent dropdown defaults to lanes.defaultAgent VS Code setting
- Dropdown hidden when only one agent available
- Disabled option for unavailable agents (not installed)
- Permission toggle state preserved when switching agents
- CLI availability cached at extension activation

### Phase 5: Testing & Validation

**Goal**: Multi-agent system verified with comprehensive tests and backward compatibility confirmed
**Depends on**: Phase 4
**Requirements**: REQ-T1, REQ-T2, REQ-T3, REQ-T4
**Plans**: 2 plans

Plans:
- [x] 05-01: Fix 4 carried-over security/correctness issues + CodexAgent and factory unit tests
- [x] 05-02: Session form agent selection tests and backward compatibility validation

**Details:**
- Security fixes: execFile for injection prevention, shell:true for cross-platform, path traversal protection, 'active' type state
- 57 new tests across 4 test files
- 705 total tests passing, zero regressions
- All 15 legacy command aliases verified

---

## Milestone Summary

**Key Decisions:**
- Agent-prefixed generic naming (AgentSessionProvider) for shared code
- Hardcoded factory map (not plugin registry) for agent creation
- .claude-session filename kept for ALL agents (pragmatic choice)
- Hookless session tracking via terminal open/close events only
- Two permission modes only matching Claude's pattern for simplicity
- Strict error on session ID capture failure (no --last fallback)
- No TOML config file generation (inline CLI flags only)
- Agent dropdown hidden when only one agent available

**Issues Resolved:**
- Command injection vulnerability in isCliAvailable() — fixed with execFile + args array
- Hardcoded /bin/sh shell path — fixed with shell:true for cross-platform
- Missing 'active' type in AgentStatusState — added to type union
- Path traversal risk in captureSessionId — added resolve + prefix validation

**Issues Deferred:**
- Workflow/MCP support for Codex (different config mechanism)
- Codex Cloud integration
- Cross-agent session migration
- Codex authentication management

**Technical Debt Incurred:**
- Duplicate utilities (escapeForSingleQuotes, validateSessionId, SESSION_ID_PATTERN) across agent classes
- No unit tests for captureSessionId (ES module stubbing complexity)
- parseStatus() lacks validation against valid status states
- hooklessTerminals Map not cleared on deactivation
- getWorkflowOrchestratorInstructions duplicated in 3 files
- Source-reading tests fragile (verify source text not behavior)

---

_For current project status, see .planning/PROJECT.md_
