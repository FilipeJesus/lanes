---
phase: 03-codex-cli-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/codeAgents/CodexAgent.ts
autonomous: true

must_haves:
  truths:
    - "CodexAgent.buildStartCommand() generates 'codex --sandbox workspace-write --ask-for-approval on-failure' for acceptEdits mode"
    - "CodexAgent.buildStartCommand() generates 'codex --sandbox danger-full-access --ask-for-approval never' for bypassPermissions mode"
    - "CodexAgent.buildStartCommand() appends shell-escaped prompt in single quotes"
    - "CodexAgent.buildResumeCommand() generates 'codex resume <UUID>' and throws on invalid session ID"
    - "CodexAgent.getPermissionModes() returns exactly 2 modes with correct IDs, labels, and flags"
    - "CodexAgent ignores settingsPath and mcpConfigPath in command building (no --settings, no --mcp-config)"
    - "CodexAgent.getLocalSettingsFiles() returns empty array (no propagation in this phase)"
  artifacts:
    - path: "src/codeAgents/CodexAgent.ts"
      provides: "Fully implemented CodexAgent with command building, permission mapping, and shell escaping"
      contains: "escapeForSingleQuotes"
  key_links:
    - from: "src/codeAgents/CodexAgent.ts"
      to: "src/services/TerminalService.ts"
      via: "buildStartCommand/buildResumeCommand called by openAgentTerminal"
      pattern: "buildStartCommand|buildResumeCommand"
---

<objective>
Implement CodexAgent command building, permission mode mapping, and shell escaping

Purpose: Transform the Phase 2 stub into a fully functional agent that generates correct Codex CLI commands. This is the core of Phase 3 -- without correct command building, no Codex session can start or resume.

Output: Updated `src/codeAgents/CodexAgent.ts` with all command-related methods implemented
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-codex-cli-integration/03-CONTEXT.md
@.planning/phases/03-codex-cli-integration/03-RESEARCH.md
@src/codeAgents/CodexAgent.ts
@src/codeAgents/ClaudeCodeAgent.ts
@src/codeAgents/CodeAgent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement permission modes, command building, and shell escaping</name>
  <files>src/codeAgents/CodexAgent.ts</files>
  <action>
Update the CodexAgent stub to implement all command-related methods. Follow ClaudeCodeAgent patterns closely.

**Add private helper methods (copy from ClaudeCodeAgent pattern):**
- `private escapeForSingleQuotes(str: string): string` -- replaces `'` with `'\''`
- `private validateSessionId(sessionId: string): void` -- validates UUID format, throws Error on invalid
- `private static readonly SESSION_ID_PATTERN` -- UUID regex (same as ClaudeCodeAgent)

**Update `getPermissionModes()` (LOCKED DECISION -- implement exactly):**
Replace the 3 stub modes with exactly 2 modes:
```typescript
return [
    { id: 'acceptEdits', label: 'Accept Edits', flag: '--sandbox workspace-write --ask-for-approval on-failure' },
    { id: 'bypassPermissions', label: 'Bypass Permissions', flag: '--sandbox danger-full-access --ask-for-approval never' }
];
```

**Update `getPermissionFlag(mode: string)`:**
```typescript
const permissionMode = this.getPermissionModes().find(m => m.id === mode);
return permissionMode?.flag || '';
```

**Implement `buildStartCommand(options: StartCommandOptions)`:**
- Start with `[this.config.cliCommand]` ("codex")
- Do NOT add --settings or --mcp-config flags (Codex doesn't support them, per user decision: inline flags only)
- If `options.permissionMode` provided, add `this.getPermissionFlag(options.permissionMode)` (the combined dual-flag string)
- If `options.prompt` provided, escape with `escapeForSingleQuotes()` and wrap in single quotes
- Join with spaces and return

**Implement `buildResumeCommand(sessionId: string, options: ResumeCommandOptions)`:**
- Call `this.validateSessionId(sessionId)` first (throws on invalid -- LOCKED: strict, no fallback)
- Build parts: `[this.config.cliCommand, 'resume', sessionId]`
- Do NOT add --settings or --mcp-config flags
- Join with spaces and return
- Note: `options` parameter is accepted but Codex doesn't use settingsPath/mcpConfigPath

**Update `parseSessionData(content: string)`:**
- Add UUID validation using SESSION_ID_PATTERN (same as ClaudeCodeAgent)
- Return null if sessionId doesn't match UUID format

**Update `getLocalSettingsFiles()`:**
- Return empty array `[]` instead of `[{ dir: '.codex', file: 'config.toml' }]`
- Add comment: "No local settings propagation for Codex in this phase (user decision)"

**Keep unchanged:** Terminal config (name, icon), file naming methods, status parsing, hooks (empty), MCP (false). These are already correct from Phase 2 stub.
  </action>
  <verify>
Run `npm run compile` to verify TypeScript compilation succeeds with no errors. Verify the file has no lint issues with `npm run lint`. Run `npm test` to ensure existing tests still pass.
  </verify>
  <done>
CodexAgent.ts compiles without errors. `buildStartCommand({permissionMode: 'acceptEdits'})` would produce `codex --sandbox workspace-write --ask-for-approval on-failure`. `buildStartCommand({permissionMode: 'bypassPermissions', prompt: "Fix it"})` would produce `codex --sandbox danger-full-access --ask-for-approval never 'Fix it'`. `buildResumeCommand('7f9f9a2e-1b3c-4c7a-9b0e-8d2f1e4b5c6a', {})` would produce `codex resume 7f9f9a2e-1b3c-4c7a-9b0e-8d2f1e4b5c6a`. `buildResumeCommand('invalid', {})` would throw Error. `getPermissionModes()` returns exactly 2 modes. `getLocalSettingsFiles()` returns empty array.
  </done>
</task>

</tasks>

<verification>
- `npm run compile` passes
- `npm run lint` passes
- `npm test` passes (no regression)
- CodexAgent.ts contains `escapeForSingleQuotes`, `validateSessionId`, `SESSION_ID_PATTERN`
- `getPermissionModes()` returns 2 modes with IDs 'acceptEdits' and 'bypassPermissions'
- `buildStartCommand` does NOT include '--settings' or '--mcp-config' flags
- `buildResumeCommand` format is 'codex resume {uuid}'
- `getLocalSettingsFiles()` returns empty array
</verification>

<success_criteria>
CodexAgent command building matches locked decisions exactly. Permission modes use dual-flag system. Shell escaping follows ClaudeCodeAgent pattern. Resume validates UUID. No config file generation. All existing tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/03-codex-cli-integration/03-01-SUMMARY.md`
</output>
