---
phase: 04-security-auditing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.planning/phases/04-security-auditing/SECURITY-AUDIT-REPORT.md]
autonomous: true

must_haves:
  truths:
    - "All file system operations are documented in the audit report"
    - "All command execution points are documented in the audit report"
    - "Each operation is classified with security status (SECURE/ACCEPTABLE/NEEDS_REVIEW/VULNERABLE)"
    - "Any vulnerable findings are identified for remediation"
  artifacts:
    - path: ".planning/phases/04-security-auditing/SECURITY-AUDIT-REPORT.md"
      provides: "Complete security audit documentation of file system and command operations"
      contains: ["## File System Operations Audit", "## Command Execution Audit", "SEC-04", "SEC-05"]
  key_links:
    - from: "SECURITY-AUDIT-REPORT.md"
      to: "src/validation/pathSanitizer.ts"
      via: "References existing safeResolve() function as security baseline"
      pattern: "safeResolve"
    - from: "SECURITY-AUDIT-REPORT.md"
      to: "src/gitService.ts"
      via: "Documents secure spawn() pattern for command execution"
      pattern: "spawn.*args"
---

<objective>
Conduct a comprehensive security audit of file system operations (SEC-04) and external command execution (SEC-05), documenting all operations and their security properties.

Purpose: Phase 3 established security infrastructure (validation, safeResolve). Phase 4 verifies that all operations in the codebase use these protections consistently.

Output: SECURITY-AUDIT-REPORT.md documenting every file system operation and command execution point with security classification.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-security-auditing/04-RESEARCH.md

# Only reference prior plan SUMMARYs if genuinely needed
@.planning/phases/03-input-validation/03-01-SUMMARY.md

# Security infrastructure from Phase 3
@src/validation/pathSanitizer.ts
@src/validation/validators.ts
@src/gitService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit file system operations (SEC-04)</name>
  <files>.planning/phases/04-security-auditing/SECURITY-AUDIT-REPORT.md</files>
  <action>
Create SECURITY-AUDIT-REPORT.md with "## File System Operations Audit (SEC-04)" section.

Audit methodology: Use grep to find all fs.* and path.* operations, then examine each location for security properties.

For each file system operation, document:
- File path and line number
- Operation type (readFile, writeFile, mkdir, exists, etc.)
- Input source (user-provided, config, constant)
- Security classification using this rubric:

  | Classification | Criteria |
  |----------------|----------|
  | **SECURE** | Uses safeResolve() OR input validated before use OR constant/known-safe path |
  | **ACCEPTABLE** | Path constructed with path.join() but input comes from trusted source (VS Code API, config) |
  | **NEEDS_REVIEW** | Potential concern requiring investigation (e.g., unvalidated path from user input) |
  | **VULNERABLE** | Clear security issue (path traversal possible, no validation) |

Files to audit (use grep patterns from research):
- src/extension.ts (many fs operations)
- src/ClaudeSessionProvider.ts (read/write session data)
- src/mcp/tools.ts (state file operations, session creation)
- src/localSettings.ts (file copy/symlink)
- src/PreviousSessionProvider.ts (exists checks)
- src/workflow/discovery.ts (readFile, readdir)
- src/workflow/loader.ts (readFile)
- src/workflow/state.ts (exists check)

Key audit questions for each operation:
1. Is the path derived from user input?
2. If user input, is it validated before use?
3. Does it use safeResolve() from Phase 3?
4. Could path traversal occur?

DO NOT fix any issues found - only document and classify.
  </action>
  <verify>SECURITY-AUDIT-REPORT.md exists with "## File System Operations Audit (SEC-04)" section containing at least 20 operations documented with classifications</verify>
  <done>All fs.* and path.* operations in src/ are documented with security classifications</done>
</task>

<task type="auto">
  <name>Task 2: Audit command execution (SEC-05)</name>
  <files>.planning/phases/04-security-auditing/SECURITY-AUDIT-REPORT.md</files>
  <action>
Add "## Command Execution Audit (SEC-05)" section to SECURITY-AUDIT-REPORT.md.

Audit methodology: Search for all spawn(), exec(), execSync() usage in the codebase.

For each command execution point, document:
- File path and line number
- Command type (spawn, exec, execSync)
- Shell usage (shell: true/false, or absent)
- Argument construction (array vs string concatenation)
- Input validation (if user-provided arguments)

Security classification:
- **SECURE**: spawn() with array args, no shell option, validated inputs
- **ACCEPTABLE**: spawn() with array args, inputs from trusted sources
- **NEEDS_REVIEW**: Potential concern (e.g., dynamic args without validation)
- **VULNERABLE**: exec() with user input, shell: true, string concatenation

Known findings (document these):
- src/gitService.ts:79 - spawn(gitPath, args, spawnOptions) - SECURE (array args, no shell)

DO NOT fix any issues found - only document and classify.
  </action>
  <verify>SECURITY-AUDIT-REPORT.md has "## Command Execution Audit (SEC-05)" section documenting all spawn/exec calls with classifications</verify>
  <done>All command execution points documented with security classifications</done>
</task>

<task type="auto">
  <name>Task 3: Summarize findings and recommendations</name>
  <files>.planning/phases/04-security-auditing/SECURITY-AUDIT-REPORT.md</files>
  <action>
Add summary sections to SECURITY-AUDIT-REPORT.md:

## Summary
Total operations audited, breakdown by classification

## Findings by Severity
- **VULNERABLE**: [count] operations requiring immediate remediation
- **NEEDS_REVIEW**: [count] operations requiring investigation
- **ACCEPTABLE**: [count] operations with minor issues
- **SECURE**: [count] operations with no issues

## Recommendations
1. For VULNERABLE findings: List specific files/lines requiring fixes
2. For NEEDS_REVIEW: List items requiring investigation
3. For ACCEPTABLE: Document any improvements to consider

## Security Infrastructure Inventory
Document existing security mechanisms from Phase 3:
- safeResolve() in src/validation/pathSanitizer.ts
- validateSessionName() in src/validation/validators.ts
- execGit() secure pattern in src/gitService.ts

## Conclusion
Overall security posture assessment and whether Phase 4 objectives are met.

Note: Based on research, gitService.ts is already secure (spawn with array args, no shell). Most file operations use either validated inputs or trusted sources (VS Code API, config). The audit is verification, not remediation.
  </action>
  <verify>SECURITY-AUDIT-REPORT.md has Summary, Findings by Severity, Recommendations, Security Infrastructure Inventory, and Conclusion sections</verify>
  <done>Complete audit report with summary, findings, and recommendations</done>
</task>

</tasks>

<verification>
- SECURITY-AUDIT-REPORT.md exists in .planning/phases/04-security-auditing/
- Report contains both SEC-04 and SEC-05 audit sections
- Each operation documented with: file, line, type, input source, classification
- Summary section provides totals and breakdown
- Any VULNERABLE or NEEDS_REVIEW findings are clearly identified
- Existing security infrastructure from Phase 3 is documented
</verification>

<success_criteria>
1. All file system operations (fs.*, path.*) in src/ are audited and documented
2. All command execution points (spawn, exec) are audited and documented
3. Each operation has a security classification (SECURE/ACCEPTABLE/NEEDS_REVIEW/VULNERABLE)
4. Report includes summary of findings and actionable recommendations
5. Existing security infrastructure from Phase 3 is documented as baseline
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-auditing/04-01-SUMMARY.md`
</output>
