---
phase: 05-testing-validation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/test/codeAgents/session-form-agent.test.ts
  - src/test/integration/backward-compat.test.ts
autonomous: true

must_haves:
  truths:
    - "Agent dropdown renders when multiple agents are available"
    - "Agent dropdown is hidden when only one agent CLI is installed"
    - "Agent selection is passed through callback to session creation"
    - "Permission toggle updates options when agent changes"
    - "Old claudeWorktrees.* command IDs are all registered as aliases"
    - "Session files without agentName field default to 'claude'"
    - "All existing Claude Code tests pass unchanged"
  artifacts:
    - path: "src/test/codeAgents/session-form-agent.test.ts"
      provides: "Session form agent dropdown and permission toggle tests"
      min_lines: 50
    - path: "src/test/integration/backward-compat.test.ts"
      provides: "Command alias and legacy data compatibility tests"
      min_lines: 40
  key_links:
    - from: "src/test/codeAgents/session-form-agent.test.ts"
      to: "src/SessionFormProvider.ts"
      via: "import and method calls"
      pattern: "import.*SessionFormProvider"
    - from: "src/test/integration/backward-compat.test.ts"
      to: "vscode.commands"
      via: "getCommands API"
      pattern: "vscode\\.commands\\.getCommands"
---

<objective>
Write integration tests for session form agent selection and backward compatibility validation.

Purpose: Verify the UI integration layer (agent dropdown, permission toggle) and confirm the full system maintains backward compatibility with legacy command IDs and session data formats.
Output: 2 new test files covering session form agent behavior and backward compatibility.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-validation/05-01-SUMMARY.md

@src/SessionFormProvider.ts
@src/extension.ts
@src/test/session/session-form.test.ts
@src/codeAgents/CodeAgent.ts
@src/codeAgents/ClaudeCodeAgent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Session form agent selection tests</name>
  <files>
    src/test/codeAgents/session-form-agent.test.ts
  </files>
  <action>
    Create `src/test/codeAgents/session-form-agent.test.ts` testing agent-specific behavior in the session form. Follow the same patterns used in `src/test/session/session-form.test.ts` (MockWebview, MockWebviewView, getFormHtml helper). Do NOT duplicate existing tests from session-form.test.ts -- only test agent-specific behavior.

    Import SessionFormProvider, SessionFormSubmitCallback, PermissionMode from `../../SessionFormProvider`.

    Suite: "Session Form Agent Selection"

    Sub-suite: "Agent Dropdown Rendering"
    - Test form includes agent dropdown when setAgentAvailability is called with multiple available agents (Map [claude:true, codex:true]). Call `provider.setAgentAvailability(availability, 'claude')`. Assert HTML includes `id="agent"`, includes option values for both 'claude' and 'codex'.
    - Test form hides agent dropdown when only one agent has CLI available (Map [claude:true, codex:false]). Assert HTML does NOT include `id="agent"`.
    - Test default agent is pre-selected. Call setAgentAvailability with defaultAgent='codex'. Assert the codex option has `selected` attribute.

    Sub-suite: "Permission Toggle Per Agent"
    - Test form JavaScript includes agent-permission mapping logic. Get HTML, assert it includes reference to permission modes changing when agent changes (look for `updatePermissions` or `agentChanged` or similar function name in the HTML JS). The exact function depends on what Phase 04 implemented -- read the HTML output to find the right assertion targets.
    - Test form shows bypass permissions toggle (existing from session-form.test.ts pattern). This confirms Claude-style permissions render. Just verify the toggle exists when agent is claude.

    Sub-suite: "Agent Callback Integration"
    - Test form submission with codex agent passes 'codex' through callback. Use MockWebview/MockWebviewView pattern from session-form.test.ts. simulateMessage with agent: 'codex'. Assert callback receives 'codex'.
    - Test form submission without agent field defaults to 'claude' in callback. simulateMessage without agent property. Assert callback receives 'claude'.
    - Test form clears agent selection to default after submission. Get HTML, assert clearForm function resets agent dropdown (look for agent reset in JS).

    Note: These tests focus on individual components as per user decision ("Test individual components separately -- not full flow"). The MockWebview pattern is already established in the codebase.
  </action>
  <verify>
    Run `npm test` and verify the "Session Form Agent Selection" suite appears in output with all tests passing. Verify no test duplication with existing session-form.test.ts tests.
  </verify>
  <done>
    Session form agent tests cover: dropdown rendering with multiple/single agents, default agent pre-selection, permission toggle presence, agent callback passthrough, default agent fallback, and form clear behavior. ~7 tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Backward compatibility and regression validation</name>
  <files>
    src/test/integration/backward-compat.test.ts
  </files>
  <action>
    Create `src/test/integration/backward-compat.test.ts` validating backward compatibility of the multi-agent system. Follow existing integration test patterns from `src/test/integration/`.

    Import vscode, ClaudeCodeAgent from `../../codeAgents/ClaudeCodeAgent`, CodexAgent from `../../codeAgents/CodexAgent`.

    Suite: "Backward Compatibility"

    Sub-suite: "Legacy Command Aliases"
    - Test all old claudeWorktrees.* command IDs are registered. Call `vscode.commands.getCommands(true)` to get full command list. Assert each of the following legacy commands is present:
      - claudeWorktrees.createSession
      - claudeWorktrees.deleteSession
      - claudeWorktrees.openSession
      - claudeWorktrees.setupStatusHooks
      - claudeWorktrees.showGitChanges
      - claudeWorktrees.openInNewWindow
      - claudeWorktrees.openPreviousSessionPrompt
      - claudeWorktrees.enableChime
      - claudeWorktrees.disableChime
      - claudeWorktrees.testChime
      - claudeWorktrees.clearSession
      - claudeWorktrees.createTerminal
      - claudeWorktrees.searchInWorktree
      - claudeWorktrees.openWorkflowState
      - claudeWorktrees.playChime
    - Test all new lanes.* command IDs are registered. Assert each corresponding lanes.* command exists in the commands list.

    Sub-suite: "Legacy Session Data"
    - Test ClaudeCodeAgent parseSessionData handles legacy data without agentName field. Create JSON string with `{ "sessionId": "abc123", "timestamp": "2026-01-01T00:00:00Z" }` (no agentName). Parse with ClaudeCodeAgent.parseSessionData(). Assert result is not null, result.sessionId equals 'abc123', and result.agentName equals 'claude' (the agent sets it from config.name).
    - Test CodexAgent parseSessionData handles data without agentName. Create JSON with valid UUID sessionId. Parse with CodexAgent.parseSessionData(). Assert result.agentName equals 'codex'.
    - Test CodexAgent parseSessionData rejects non-UUID sessionId. Create JSON with `{ "sessionId": "not-a-uuid" }`. Assert returns null.
    - Test ClaudeCodeAgent still produces correct hook configs (regression). Create a ClaudeCodeAgent, call generateHooksConfig with temp paths. Assert it returns non-empty array with SessionStart hook. This validates hook-based agents weren't broken by the abstraction changes.

    Sub-suite: "Agent Coexistence"
    - Test Claude and Codex agents have distinct terminal names. Create both agents, call getTerminalName('test'). Assert Claude returns 'Claude: test' and Codex returns 'Codex: test'.
    - Test Claude and Codex agents have distinct terminal icons. Call getTerminalIcon() on both. Assert different icon colors (Claude uses green, Codex uses blue).
    - Test supportsHooks() returns true for Claude and false for Codex. Validates the hookless abstraction works correctly.

    No explicit regression step needed per user decision ("Trust CI -- pre-commit hook runs full test suite"). The fact that `npm test` passes with ALL tests (existing + new) IS the regression validation.
  </action>
  <verify>
    Run `npm test` and verify the "Backward Compatibility" suite appears with all tests passing. Verify total test count includes both new and all existing tests. The pre-commit hook will enforce compile + lint + test before any commit.
  </verify>
  <done>
    Backward compatibility tests cover: all 15 legacy command aliases registered, all corresponding lanes.* commands registered, legacy session data parsing defaults to correct agent, CodexAgent rejects invalid UUIDs, Claude hooks still work, agents have distinct terminal names/icons/hook support. ~10 tests. Full `npm test` passes confirming zero regression.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes with all existing tests unchanged (backward compatibility confirmed)
2. New test suites appear in output: "Session Form Agent Selection", "Backward Compatibility"
3. Total new test count for this plan: ~17 tests
4. Combined with Plan 01: ~39 new tests total for Phase 5
5. All 4 requirements (REQ-T1 through REQ-T4) have test coverage:
   - REQ-T1: CodexAgent unit tests (Plan 01, codex-agent.test.ts)
   - REQ-T2: Factory tests (Plan 01, agent-factory.test.ts)
   - REQ-T3: Session form agent tests (Plan 02, session-form-agent.test.ts)
   - REQ-T4: Backward compatibility tests (Plan 02, backward-compat.test.ts) + full suite passes
</verification>

<success_criteria>
- Session form agent selection tests verify dropdown rendering, permission toggle, and callback behavior
- Backward compatibility tests confirm all 15 legacy command aliases plus legacy session data handling
- Agent coexistence tests confirm Claude and Codex have distinct identities
- Full `npm test` passes with zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-validation/05-02-SUMMARY.md`
</output>
