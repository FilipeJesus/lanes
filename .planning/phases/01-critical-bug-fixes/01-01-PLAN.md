---
phase: 01-critical-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/AsyncQueue.ts
  - src/extension.ts
  - src/utils.ts
  - src/test/asyncQueue.test.ts
  - src/test/branchValidation.test.ts
  - src/test/mergeBaseHandling.test.ts
autonomous: true

must_haves:
  truths:
    - "User can create multiple sessions rapidly without 'worktree already exists' errors"
    - "User sees clear error message when creating session from Git-invalid branch name (e.g., 'feature/.')"
    - "User can view Git changes for remote branches without merge-base errors"
    - "Remote branch changes show with auto-fetch before merge-base computation"
  artifacts:
    - path: "src/AsyncQueue.ts"
      provides: "Async queue with timeout support for serializing session creation"
      exports: ["AsyncQueue"]
      min_lines: 50
    - path: "src/utils.ts"
      provides: "Branch name validation function"
      exports: ["validateBranchName"]
    - path: "src/extension.ts"
      provides: "Session creation with queue and branch validation"
      contains: "sessionCreationQueue"
  key_links:
    - from: "src/extension.ts"
      to: "src/AsyncQueue.ts"
      via: "import { AsyncQueue } from './AsyncQueue'"
      pattern: "import.*AsyncQueue.*from"
    - from: "src/extension.ts"
      to: "src/utils.ts"
      via: "validateBranchName function call before git operations"
      pattern: "validateBranchName\\("
---

<objective>
Eliminate race conditions in session creation and fix Git instability when viewing changes for branches with non-standard names and remote branches.

**Purpose:** Users can create sessions rapidly without errors and can reliably view Git changes for any valid branch.

**Output:** Async queue for session serialization, branch name validation with clear errors, and improved merge-base handling with auto-fetch.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-critical-bug-fixes/01-CONTEXT.md
@.planning/phases/01-critical-bug-fixes/01-RESEARCH.md

@/Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/extension.ts
@/Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/utils.ts
@/Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/gitService.ts
@/Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/sanitization.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AsyncQueue for session serialization</name>
  <files>src/AsyncQueue.ts</files>
  <action>
Create `src/AsyncQueue.ts` with a simple async queue implementation:

1. Create `AsyncQueue` class with:
   - `private queue: Array&lt;() => Promise&lt;any&gt;&gt;` for pending tasks
   - `private processing = false` flag
   - `add&lt;T&gt;(task: () => Promise&lt;T&gt;, timeoutMs?: number): Promise&lt;T&gt;` method
   - `private process()` method for sequential execution

2. Timeout implementation using `Promise.race`:
   - Wrap task in timeout promise that rejects after timeoutMs
   - Default timeout: 30000ms (30 seconds)
   - On timeout: reject with clear error message

3. Error handling:
   - Catch task errors and reject the promise
   - Continue processing next task even if current fails
   - Log errors to console for debugging

DO NOT use external packages (async-mutex, p-queue) - implement zero-dep solution per research recommendation.

Key pattern:
```typescript
class AsyncQueue {
    private queue: Array<() => Promise<any>> = [];
    private processing = false;

    async add<T>(task: () => Promise<T>, timeoutMs = 30000): Promise<T> {
        return new Promise((resolve, reject) => {
            const wrappedTask = async () => {
                try {
                    const result = await Promise.race([
                        task(),
                        new Promise<never>((_, rej) =>
                            setTimeout(() => rej(new Error('Operation timed out after 30s')), timeoutMs)
                        )
                    ]);
                    resolve(result);
                } catch (err) {
                    reject(err);
                }
            };
            this.queue.push(wrappedTask);
            this.process();
        });
    }

    private async process() {
        if (this.processing || this.queue.length === 0) return;
        this.processing = true;
        while (this.queue.length > 0) {
            const task = this.queue.shift()!;
            await task();
        }
        this.processing = false;
    }
}
```
  </action>
  <verify>npm run compile && grep -q "class AsyncQueue" out/AsyncQueue.js</verify>
  <done>AsyncQueue class exists with timeout support and sequential execution</done>
</task>

<task type="auto">
  <name>Task 2: Add branch name validation to utils.ts</name>
  <files>src/utils.ts</files>
  <action>
Add `validateBranchName` function to `src/utils.ts`:

1. Create `ValidationResult` interface:
```typescript
export interface ValidationResult {
    valid: boolean;
    error?: string;
}
```

2. Implement `validateBranchName(branch: string): ValidationResult`:
   - Check for ASCII control chars (bytes < 0x20, 0x7F DEL)
   - Check for spaces and special chars: `~`, `^`, `:`, `?`, `*`, `[`, `\`
   - Check for leading/trailing dots
   - Check for `..` or `//` sequences
   - Check for `@{` sequences
   - Check for `.lock` suffix
   - Return `{ valid: false, error: string }` with clear message including the branch name

3. Error message format: `"Branch '{branch}' contains invalid characters. Worktrees cannot be created from this branch."`

Regex patterns from RESEARCH.md:
```typescript
const INVALID_CHARS_REGEX = /[\x00-\x1F\x7F ~^:?*\[\\]/;
const LEADING_TRAILING_DOT_REGEX = /^\.|\.$/;
const DOT_SEQUENCE_REGEX = /\.\.|\/\//;
const BRACE_SEQUENCE_REGEX = /@\{/;
const LOCK_SUFFIX_REGEX = /\.lock$/;
```

This is VALIDATION (not sanitization) - reject invalid input rather than transform it. The existing `sanitizeSessionName` is for display names, but branch names must be validated before Git operations.
  </action>
  <verify>grep -q "validateBranchName" src/utils.ts && grep -q "ValidationResult" src/utils.ts</verify>
  <done>validateBranchName function rejects Git-invalid branch names with clear error messages</done>
</task>

<task type="auto">
  <name>Task 3: Integrate queue into createSession in extension.ts</name>
  <files>src/extension.ts</files>
  <action>
Modify `createSession` function in `src/extension.ts`:

1. Import AsyncQueue at top of file:
```typescript
import { AsyncQueue } from './AsyncQueue';
```

2. Create module-level queue instance after imports (around line 40):
```typescript
// Session creation queue - prevents race conditions when rapidly creating sessions
const sessionCreationQueue = new AsyncQueue();
```

3. Wrap createSession body in queue operation:
   - Keep existing function signature
   - Wrap entire function body (after initial checks) in `sessionCreationQueue.add()`
   - Add 30-second timeout parameter

4. Add duplicate worktree check BEFORE queueing:
   - After workspaceRoot check, call `branchExists()` for session name
   - If branch exists AND worktree directory exists, fail fast with clear error
   - This prevents queueing requests we know will fail

5. Update progress message:
   - Keep "Creating session..." message
   - Queue is silent (no queue position display per user decision)

Key locations:
- Import section: around line 1-40
- createSession function: starts at line 1693
- Worktree path construction: around line 1761

Pattern:
```typescript
async function createSession(...): Promise<void> {
    // Early checks (workspace, git) stay outside queue
    if (!workspaceRoot) { ... }
    if (!isGit) { ... }

    // Queue the actual session creation
    return sessionCreationQueue.add(async () => {
        // All existing logic here
        // ...
    }, 30000); // 30 second timeout
}
```
  </action>
  <verify>grep -q "sessionCreationQueue" src/extension.ts && grep -q "import.*AsyncQueue" src/extension.ts</verify>
  <done>createSession uses AsyncQueue for serialization with 30s timeout</done>
</task>

<task type="auto">
  <name>Task 4: Add branch validation in createSession and showGitChanges</name>
  <files>src/extension.ts</files>
  <action>
Add branch validation in two locations:

1. In `createSession` (around line 1850-1860):
   - After trimming sourceBranch, validate with `validateBranchName()`
   - If invalid, show error and throw: `vscode.window.showErrorMessage(validation.error)`
   - Do same for session name (trimmedName) before Git operations

2. In `showGitChanges` command (around line 1315-1345):
   - Before calling `generateDiffContent`, validate `item.label`
   - If invalid, show error with branch name and return early
   - Message: `"Branch '{branch}' contains invalid characters. Cannot view changes."`

3. Import validateBranchName at top of file:
```typescript
import { validateBranchName, ValidationResult } from './utils';
```

Key insight: Pre-flight validation gives faster feedback than letting Git fail. User sees "Branch 'feature/.' contains invalid characters" instead of cryptic Git error.

Locations:
- createSession sourceBranch handling: lines ~1850-1910
- showGitChanges: lines ~1315-1345
- Import section: around line 35
  </action>
  <verify>grep -q "validateBranchName" src/extension.ts</verify>
  <done>Branch names validated before Git operations in createSession and showGitChanges</done>
</task>

<task type="auto">
  <name>Task 5: Add auto-fetch and improve merge-base error handling</name>
  <files>src/extension.ts</files>
  <action>
Modify `generateDiffContent` function (around line 1153-1248):

1. Add auto-fetch for remote branches before merge-base:
```typescript
// Auto-fetch for remote branches
if (baseBranch.startsWith('origin/') || baseBranch.includes('/')) {
    try {
        const parts = baseBranch.split('/');
        const remote = parts[0];
        const branch = parts.slice(1).join('/');
        await execGit(['fetch', remote, branch], worktreePath);
    } catch (fetchErr) {
        console.warn(`Lanes: Failed to fetch ${baseBranch}:`, getErrorMessage(fetchErr));
        // Continue anyway - local ref may exist
    }
}
```

2. Improve merge-base fallback (in catch block around line 1165-1169):
   - Add warning notification: `vscode.window.showWarningMessage("Using fallback diff method - merge-base unavailable for '{branch}'")`
   - Use three-dot syntax instead of direct branch: `diffArgs = ['diff', \`${baseBranch}...HEAD\`];`
   - The three-dot syntax (A...B) finds merge-base implicitly and shows committed changes

3. Debounce warning: Use Set to track warned branches per VS Code session to avoid spam:
```typescript
// At module level
const warnedMergeBaseBranches = new Set<string>();

// In generateDiffContent
if (!warnedMergeBaseBranches.has(baseBranch)) {
    vscode.window.showWarningMessage(`Using fallback diff method - merge-base unavailable for '${baseBranch}'`);
    warnedMergeBaseBranches.add(baseBranch);
}
```

Key insight: Auto-fetch ensures merge-base has best chance to succeed. Three-dot fallback shows committed changes without requiring merge-base computation.

Locations:
- generateDiffContent function: lines ~1153-1248
- Merge-base try/catch: lines ~1161-1169
  </action>
  <verify>grep -q "fetch.*remote.*branch" src/extension.ts && grep -q "warnedMergeBaseBranches" src/extension.ts</verify>
  <done>Remote branches auto-fetched before merge-base; fallback uses three-dot syntax with warning</done>
</task>

<task type="auto">
  <name>Task 6: Add tests for async queue, branch validation, and merge-base handling</name>
  <files>src/test/asyncQueue.test.ts, src/test/branchValidation.test.ts, src/test/mergeBaseHandling.test.ts</files>
  <action>
Create three test files:

1. `src/test/asyncQueue.test.ts`:
   - Test sequential execution (tasks complete in order)
   - Test timeout (task rejected after timeout)
   - Test error handling (one task failure doesn't stop queue)
   - Test concurrent adds (multiple tasks queued correctly)

2. `src/test/branchValidation.test.ts`:
   - Test valid branch names pass
   - Test `feature/.` is rejected with clear error
   - Test `feature/*` is rejected
   - Test branches with spaces rejected
   - Test branches with `~^:` characters rejected
   - Test branches starting/ending with dot rejected
   - Test branches with `..` or `//` rejected
   - Test branches ending with `.lock` rejected

3. `src/test/mergeBaseHandling.test.ts`:
   - Test auto-fetch is called for remote branches
   - Test three-dot fallback is used on merge-base failure
   - Test warning is shown once per branch
   - Test normal merge-base path when available

Use existing test patterns from `sanitization.test.ts`. Mock `execGit` for git operations to avoid actual git commands.

Import patterns:
```typescript
import * as assert from 'assert';
import sinon from 'sinon';
import { validateBranchName } from '../utils';
import { AsyncQueue } from '../AsyncQueue';
```

Note: Tests for merge-base handling may require mocking vscode.window.showWarningMessage - create a test helper or stub.

Since fast-check is not yet installed and this is Level 0 (existing patterns only), use standard Mocha assert tests instead of property-based testing. PBT can be added in Phase 5 (Test Foundation).
  </action>
  <verify>npm test 2>&1 | head -50</verify>
  <done>All new tests pass; async queue serializes correctly, branch validation rejects invalid names, merge-base has proper fallback</done>
</task>

</tasks>

<verification>
## Overall Verification Steps

1. **Race Condition Fix:**
   - Create 5 sessions rapidly in succession
   - Verify all succeed without "worktree already exists" errors
   - Verify sessions are created sequentially (not parallel)

2. **Branch Validation:**
   - Attempt to create session from branch named `feature/.`
   - Verify error message includes branch name and explains invalid characters
   - Test with other invalid names: `feature/*`, `bug~test`, `name..test`

3. **Merge-base Handling:**
   - Create worktree from remote branch (e.g., `origin/main`)
   - View Git changes for that session
   - Verify fetch is attempted before merge-base
   - If merge-base fails, verify warning is shown and fallback diff works

4. **Tests:**
   - Run `npm test` - all tests pass
   - Run `npm run compile` - no TypeScript errors
   - Run `npm run lint` - no linting errors
</verification>

<success_criteria>
1. User can create sessions rapidly (5+ in 10 seconds) without worktree initialization failures
2. Branch `feature/.` shows clear error: "Branch 'feature/.' contains invalid characters..."
3. Remote branch changes show without merge-base errors (auto-fetch + fallback)
4. All tests pass (npm test)
5. Code compiles without errors (npm run compile)
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-01-SUMMARY.md` with:
- Actual changes made (files created/modified)
- Any deviations from plan
- Test results summary
- Next steps (01-02-PLAN.md if needed, or move to Phase 2)
</output>
