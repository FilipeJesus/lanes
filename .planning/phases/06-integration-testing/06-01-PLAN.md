---
phase: 06-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/integration/error-paths.test.ts
autonomous: true

must_haves:
  truths:
    - "GitError from gitService.execGit propagates through extension to user notification"
    - "ValidationError from validators prevents git operations from executing"
    - "Error userMessage is displayed to users via VS Code API"
    - "System remains in consistent state after error scenarios"
  artifacts:
    - path: "src/test/integration/error-paths.test.ts"
      provides: "Integration tests for error propagation across module boundaries"
      min_lines: 150
  key_links:
    - from: "src/test/integration/error-paths.test.ts"
      to: "src/gitService.ts"
      via: "sinon.stub() on gitService.execGit"
      pattern: "sinon.stub.*execGit"
    - from: "src/test/integration/error-paths.test.ts"
      to: "src/validation/validators.ts"
      via: "import validation functions"
      pattern: "validateSessionName|validateBranchName"
---

<objective>
Create error path integration tests that verify error propagation from source (git operations, validation) through the extension layer to user notification.

Purpose: Current error tests only verify error types are correct, but do not verify the full error path. Integration tests ensure errors reach users and the system remains in consistent state.

Output: New `src/test/integration/error-paths.test.ts` with comprehensive error propagation tests.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-integration-testing/06-RESEARCH.md
@.planning/codebase/TESTING.md
@src/test/testSetup.ts

# Prior phases with relevant patterns
@.planning/phases/02-error-handling/02-01-PLAN.md
@.planning/phases/03-input-validation/03-01-PLAN.md
@.planning/phases/05-test-foundation/05-01-PLAN.md

# Source files to test
@src/gitService.ts
@src/errors/GitError.ts
@src/errors/ValidationError.ts
@src/validation/validators.ts
</context>

<tasks>

<task type="auto">
  <name>Create integration directory and error-paths.test.ts file</name>
  <files>src/test/integration/error-paths.test.ts</files>
  <action>
Create `src/test/integration/error-paths.test.ts` with the following test structure:

**File structure:**
1. Import statements:
   - `assert` from node:assert
   - `sinon` from sinon
   - `{ vol }` from memfs
   - `{ GitError, ValidationError }` from ../../errors
   - `{ execGit }` from ../../gitService
   - `{ validateSessionName, validateBranchName }` from ../../validation
   - `{ setupMemfs, setupGitStubs, createTestRepo }` from ../testSetup

2. Suite: "Error Path Integration: Git Operations"
   - Use setupMemfs() for filesystem isolation
   - Use setupGitStubs() to mock gitService.execGit
   - Test: "should propagate GitError from worktree creation to user notification"
     * Stub execGit to reject with git error
     * Call git operation that would use execGit
     * Assert GitError is caught with correct properties
     * Assert userMessage is actionable
   - Test: "should include command details in GitError"
     * Verify command array is preserved
     * Verify exitCode is captured

3. Suite: "Error Path Integration: Validation"
   - Test: "should prevent git operations on invalid session name"
     * Use path traversal attempt (../../etc/passwd)
     * Call validateSessionName
     * Assert ValidationError thrown
     * Assert git operations NOT executed (verify stub not called)
   - Test: "should reject invalid branch names"
     * Test @{ sequence (not allowed by git ref format)
     * Assert field and reason in error

4. Suite: "Error Path Integration: User Notification"
   - Test: "GitError provides user-friendly message"
     * Assert userMessage excludes technical details
     * Assert userMessage includes actionable context
   - Test: "ValidationError shows invalid value and reason"
     * Assert truncated value for long inputs
     * Assert reason explains what to fix

**Key patterns from Phase 5:**
- Use `setup()` to initialize memfs and gitStubs
- Use `teardown()` to call `memfs.reset()` and `gitStubs.restore()`
- Use `vol.fromJSON()` for test file structure
- Each test: Arrange (setup), Act (call function), Assert (verify)

**No external dependencies needed** - use existing Phase 5 infrastructure (memfs, sinon).
  </action>
  <verify>Run `npm test -- --grep "Error Path Integration"` to verify new tests pass</verify>
  <done>All error path integration tests pass, covering:
1. GitError propagation from execGit through extension
2. ValidationError preventing git operations
3. userMessage reaches user (verified via error properties)
4. System state consistency after errors (no partial state)</done>
</task>

</tasks>

<verification>
Run the full test suite to ensure no regressions:
```bash
npm test
```

Verify new tests are included in test output:
```bash
npm test -- --grep "Error Path Integration"
```

Check that the integration directory structure exists:
```bash
ls -la src/test/integration/
```
</verification>

<success_criteria>
1. New `src/test/integration/` directory created
2. `error-paths.test.ts` contains at least 5 test cases covering GitError and ValidationError paths
3. All tests use memfs and sinon for isolation (no real filesystem/git operations)
4. Tests verify both error type AND error behavior (user notification, state consistency)
5. Full test suite passes (`npm test`)
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-testing/06-01-SUMMARY.md` with:
- Test cases implemented
- Coverage gaps identified (if any)
- Any issues discovered during testing
</output>
