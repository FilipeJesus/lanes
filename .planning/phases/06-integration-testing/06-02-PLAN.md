---
phase: 06-integration-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/integration/mcp-workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "Workflow state persists across MCP tool calls"
    - "workflow_advance increments step and saves outputs"
    - "workflow_set_tasks modifies state and persists"
    - "Concurrent state updates use atomic writes (no corruption)"
    - "workflow_status returns correct position after state changes"
  artifacts:
    - path: "src/test/integration/mcp-workflow.test.ts"
      provides: "End-to-end MCP workflow state machine integration tests"
      min_lines: 200
  key_links:
    - from: "src/test/integration/mcp-workflow.test.ts"
      to: "src/mcp/tools.ts"
      via: "import MCP workflow functions"
      pattern: "workflowStart|workflowAdvance|workflowSetTasks"
    - from: "src/test/integration/mcp-workflow.test.ts"
      to: "src/workflow/state.ts"
      via: "WorkflowStateMachine class"
      pattern: "WorkflowStateMachine"
</key_links>
---

<objective>
Create MCP workflow integration tests that verify end-to-end state persistence and state machine transitions across multiple tool calls.

Purpose: Current MCP tests verify individual tools in isolation. Integration tests ensure state persists correctly across the full workflow lifecycle (start -> set tasks -> advance -> complete).

Output: New `src/test/integration/mcp-workflow.test.ts` with comprehensive workflow state machine tests.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-integration-testing/06-RESEARCH.md
@.planning/codebase/TESTING.md
@src/test/testSetup.ts

# Prior phases with relevant patterns
@.planning/phases/05-test-foundation/05-01-PLAN.md

# Source files to test
@src/mcp/tools.ts
@src/workflow/state.ts
@src/workflow/types.ts
</context>

<tasks>

<task type="auto">
  <name>Create mcp-workflow.test.ts with end-to-end workflow state tests</name>
  <files>src/test/integration/mcp-workflow.test.ts</files>
  <action>
Create `src/test/integration/mcp-workflow.test.ts` with the following test structure:

**File structure:**
1. Import statements:
   - `assert` from node:assert
   - `{ vol }` from memfs
   - `{ WorkflowStateMachine, loadWorkflowTemplate }` from ../../workflow
   - `{ workflowStart, workflowAdvance, workflowSetTasks, saveState, loadState, getStatePath }` from ../../mcp/tools
   - `{ setupMemfs, createTestRepo }` from ../testSetup
   - `* as path` from path

2. Test fixtures:
   - Create a minimal workflow template in memory for testing
   - Helper to create worktree path with .git directory

3. Suite: "MCP Workflow Integration: State Persistence"
   - setup(): Initialize memfs with vol.reset()
   - teardown(): Reset memfs

   Test: "should persist workflow state across tool calls"
     * Create virtual worktree path with .git directory
     * Call workflowStartFromPath with test template
     * Call loadState to verify state was persisted
     * Assert workflowId, step, status, outputs are correct

   Test: "should advance workflow state and persist results"
     * Start workflow
     * Call workflowAdvance with output
     * Load state and verify step advanced
     * Assert outputs contain previous step's output

   Test: "should set tasks and persist to state"
     * Start workflow with loop step
     * Call workflowSetTasks with task array
     * Load state and verify tasks were saved
     * Assert state.tasks[loopId] matches provided tasks

4. Suite: "MCP Workflow Integration: State Machine Transitions"
   Test: "should progress through multi-step workflow"
     * Create template with 2 action steps
     * Start workflow
     * Advance through step 1
     * Verify step moved to step 2
     * Advance through step 2
     * Verify status is 'complete'

   Test: "should track outputs from all steps"
     * Start workflow
     * Advance with outputs for each step
     * Verify all outputs stored in state
     * Assert workflowContext returns all outputs

5. Suite: "MCP Workflow Integration: Concurrent Updates"
   Test: "should handle concurrent state updates with atomic writes"
     * Start workflow
     * Simulate concurrent updates with Promise.all():
       ```javascript
       const promises = [
           saveState(worktreePath, { ...state, outputs: { step1: 'output1' } }),
           saveState(worktreePath, { ...state, outputs: { step2: 'output2' } })
       ];
       await Promise.all(promises);
       ```
     * Load state and verify valid JSON (not corrupted)
     * Assert atomic rename prevented data loss

6. Suite: "MCP Workflow Integration: State Recovery"
   Test: "should resume workflow from persisted state"
     * Start workflow and advance one step
     * Create new WorkflowStateMachine.fromState with loaded state
     * Verify step position is preserved
     * Advance and verify continuation works

**Key patterns from Phase 5:**
- Use `vol.fromJSON()` to create virtual file structure
- Use in-memory workflow template (avoid file loading)
- Use `setup()` and `teardown()` for test isolation
- Each test: Arrange (create template/worktree), Act (call workflow functions), Assert (verify state)

**Workflow template structure for testing:**
```typescript
const testTemplate = {
    name: 'test-workflow',
    steps: [
        { id: 'step1', type: 'action', agent: null, instructions: 'First step' },
        { id: 'step2', type: 'action', agent: null, instructions: 'Second step' }
    ]
};
```
  </action>
  <verify>Run `npm test -- --grep "MCP Workflow Integration"` to verify new tests pass</verify>
  <done>All MCP workflow integration tests pass, covering:
1. State persistence across tool calls
2. State machine transitions (start -> advance -> complete)
3. Output tracking and context retrieval
4. Atomic writes for concurrent updates
5. State recovery with fromState()</done>
</task>

</tasks>

<verification>
Run the full test suite to ensure no regressions:
```bash
npm test
```

Verify new tests are included in test output:
```bash
npm test -- --grep "MCP Workflow Integration"
```

Check that workflow state file operations work correctly:
```bash
npm test -- --grep "should persist workflow state"
```
</verification>

<success_criteria>
1. `mcp-workflow.test.ts` contains at least 6 test cases covering workflow state persistence
2. Tests verify state file I/O using memfs (no real filesystem)
3. Tests cover both success paths and concurrent update scenarios
4. All tests pass independently
5. Full test suite passes (`npm test`)
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-testing/06-02-SUMMARY.md` with:
- Test cases implemented
- Any state corruption scenarios discovered
- Recommendations for production state file handling
</output>
