---
phase: 01-file-attachment-ui-and-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SessionFormProvider.ts
autonomous: false

must_haves:
  truths:
    - "User sees a paperclip attach button inside the bottom-right corner of the starting prompt textarea"
    - "Clicking the attach button opens the VS Code native file picker dialog with multi-select"
    - "Selected files appear as chips below the textarea showing file type icon + filename"
    - "Clicking the X on a chip removes that file from the attachment list"
    - "Selecting a duplicate file shows a brief notification and does not add the file again"
    - "Attachment list persists when the webview is hidden and re-shown"
    - "The createSession message includes an attachments array of file path strings"
  artifacts:
    - path: "src/SessionFormProvider.ts"
      provides: "Attachment UI (button, chips, file picker handler, state persistence) and updated callback type"
      contains: "showFilePicker"
  key_links:
    - from: "webview JS (attach button click)"
      to: "extension message handler"
      via: "postMessage({command: 'showFilePicker'})"
      pattern: "showFilePicker"
    - from: "extension message handler"
      to: "webview JS (chip rendering)"
      via: "postMessage({command: 'filesSelected', files: [...]})"
      pattern: "filesSelected"
    - from: "webview JS (form submit)"
      to: "extension onSubmit callback"
      via: "postMessage({command: 'createSession', ..., attachments: [...]})"
      pattern: "attachments"
---

<objective>
Add the complete file attachment UI to the session creation form: a paperclip attach button overlaid inside the textarea, a VS Code native file picker triggered via message passing, a chip list showing selected files with remove buttons, duplicate detection, file limit (20), and webview state persistence for attachments.

Purpose: This is the user-facing half of the attachment feature -- everything the user sees and interacts with, plus the plumbing to get selected file paths to the extension host and back.
Output: Modified `SessionFormProvider.ts` with working attachment UI and updated callback type.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-file-attachment-ui-and-integration/01-CONTEXT.md
@.planning/phases/01-file-attachment-ui-and-integration/01-RESEARCH.md

@src/SessionFormProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add attachment UI, file picker message handling, and callback type to SessionFormProvider</name>
  <files>src/SessionFormProvider.ts</files>
  <action>
Modify `src/SessionFormProvider.ts` to add the complete file attachment feature. This is a single-file change touching HTML/CSS/JS in `_getHtmlForWebview()`, the message handler in `resolveWebviewView()`, and the `SessionFormSubmitCallback` type.

**1. Update `SessionFormSubmitCallback` type (line ~37-43):**
Add `attachments: string[]` as the last parameter:
```typescript
export type SessionFormSubmitCallback = (
    name: string,
    prompt: string,
    sourceBranch: string,
    permissionMode: PermissionMode,
    workflow: string | null,
    attachments: string[]
) => void | Promise<void>;
```

**2. Add `import * as path from 'path';`** at the top of the file (needed for `path.basename` and file extension extraction in the extension-side message handler).

**3. Update the extension-side message handler in `resolveWebviewView()` (line ~172-205):**

Add a new case for `'showFilePicker'` in the switch statement:
```typescript
case 'showFilePicker':
    const uris = await vscode.window.showOpenDialog({
        canSelectMany: true,
        canSelectFiles: true,
        canSelectFolders: false,
        openLabel: 'Attach',
        title: 'Select files to attach',
        defaultUri: vscode.workspace.workspaceFolders?.[0]?.uri
    });
    if (uris && uris.length > 0) {
        this._view?.webview.postMessage({
            command: 'filesSelected',
            files: uris.map(uri => ({
                path: uri.fsPath,
                name: path.basename(uri.fsPath)
            }))
        });
    }
    break;
```

Update the `'createSession'` case to pass `attachments` to the callback:
```typescript
await this._onSubmit(
    message.name,
    message.prompt,
    message.sourceBranch || '',
    message.permissionMode || 'acceptEdits',
    message.workflow || null,
    message.attachments || []
);
```

**4. Update the `clearForm` message** sent after successful submission to also clear attachments in the webview (the existing `postMessage({ command: 'clearForm' })` is fine -- the webview JS will handle clearing the attachments array).

**5. Update the HTML/CSS in `_getHtmlForWebview()`:**

**CSS additions** (add inside the existing `<style>` block):

- `.textarea-wrapper` -- `position: relative; width: 100%;` to contain the overlaid button
- `.attach-btn` -- `position: absolute; bottom: 6px; right: 6px; width: 28px; height: 28px; padding: 0; border: none; background: transparent; cursor: pointer; font-size: 16px; color: var(--vscode-foreground); display: flex; align-items: center; justify-content: center; border-radius: 3px; z-index: 1;`
- `.attach-btn:hover` -- `background-color: var(--vscode-list-hoverBackground);`
- Modify `textarea` style to add `padding-bottom: 36px;` to reserve space for the overlaid button
- `.attachment-chips` -- `display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;`
- `.chip` -- `display: inline-flex; align-items: center; gap: 4px; padding: 2px 4px 2px 8px; background-color: var(--vscode-badge-background); color: var(--vscode-badge-foreground); border-radius: 3px; font-size: 12px; max-width: 100%;`
- `.chip-icon` -- `flex-shrink: 0; font-size: 14px;`
- `.chip-label` -- `max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;`
- `.chip-remove` -- `width: 18px; height: 18px; padding: 0; border: none; background: transparent; color: inherit; cursor: pointer; font-size: 16px; line-height: 1; border-radius: 2px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;`
- `.chip-remove:hover` -- `background-color: rgba(255, 255, 255, 0.15);`
- `.attachment-warning` -- `font-size: 11px; color: var(--vscode-editorWarning-foreground, #cca700); margin-top: 4px; opacity: 1; transition: opacity 0.3s ease;`

**HTML modifications:**

Wrap the existing `<textarea>` in a `.textarea-wrapper` div and add the attach button AFTER the textarea (but inside the wrapper):
```html
<div class="textarea-wrapper">
    <textarea id="prompt" name="prompt" placeholder="Describe the task for Claude..."></textarea>
    <button type="button" class="attach-btn" id="attachBtn" title="Attach files" aria-label="Attach files">&#128206;</button>
</div>
<div class="attachment-chips" id="attachmentChips"></div>
```
Note: Use the Unicode paperclip character `&#128206;` (U+1F4CE) for the button icon. The existing hint div `<div class="hint">Sent to Claude after the session starts</div>` should appear AFTER the `attachment-chips` div.

**6. Update the webview JavaScript (inside the `<script>` tag):**

Add these variables after the existing variable declarations:
```javascript
const attachBtn = document.getElementById('attachBtn');
const attachmentChipsContainer = document.getElementById('attachmentChips');
let attachments = []; // Array of {path: string, name: string}
const MAX_FILES = 20;
```

Add a file icon mapping function (use simple extension-based mapping returning emoji/unicode characters -- codicons are NOT installed in this project):
```javascript
function getFileIcon(filename) {
    const ext = filename.split('.').pop()?.toLowerCase() || '';
    const codeExts = ['js','ts','jsx','tsx','py','java','cpp','c','h','go','rs','rb','php','swift','kt','cs','html','css','scss','less','vue','svelte'];
    const dataExts = ['json','xml','yaml','yml','toml','ini','env','csv'];
    const docExts = ['md','txt','rst','doc','docx','rtf'];
    const mediaExts = ['png','jpg','jpeg','gif','svg','mp4','mp3','wav','webp','ico'];
    const archiveExts = ['zip','tar','gz','rar','7z'];
    if (codeExts.includes(ext)) return '\u{1F4C4}';     // page facing up (code)
    if (dataExts.includes(ext)) return '\u{1F4CB}';      // clipboard (data)
    if (docExts.includes(ext)) return '\u{1F4DD}';       // memo (docs)
    if (mediaExts.includes(ext)) return '\u{1F5BC}';     // framed picture (media)
    if (archiveExts.includes(ext)) return '\u{1F4E6}';   // package (archive)
    return '\u{1F4C1}';                                    // file folder (default)
}
```

Add chip rendering function:
```javascript
function renderAttachmentChips() {
    attachmentChipsContainer.innerHTML = '';
    attachments.forEach((file, index) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.dataset.path = file.path;
        chip.innerHTML =
            '<span class="chip-icon">' + getFileIcon(file.name) + '</span>' +
            '<span class="chip-label">' + escapeHtml(file.name) + '</span>' +
            '<button type="button" class="chip-remove" aria-label="Remove ' + escapeHtml(file.name) + '">\u00D7</button>';
        chip.querySelector('.chip-remove').addEventListener('click', () => {
            attachments.splice(index, 1);
            renderAttachmentChips();
            saveState();
        });
        attachmentChipsContainer.appendChild(chip);
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
```

Add duplicate notification function:
```javascript
function showAttachmentWarning(message) {
    // Remove existing warning if any
    const existing = attachmentChipsContainer.parentNode.querySelector('.attachment-warning');
    if (existing) existing.remove();

    const warning = document.createElement('div');
    warning.className = 'attachment-warning';
    warning.textContent = message;
    attachmentChipsContainer.parentNode.insertBefore(warning, attachmentChipsContainer.nextSibling);

    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        warning.style.opacity = '0';
        setTimeout(() => warning.remove(), 300);
    }, 3000);
}
```

Add attach button click handler:
```javascript
attachBtn.addEventListener('click', () => {
    if (attachments.length >= MAX_FILES) {
        showAttachmentWarning('Maximum ' + MAX_FILES + ' files allowed');
        return;
    }
    vscode.postMessage({ command: 'showFilePicker' });
});
```

Add `filesSelected` message handler inside the existing `window.addEventListener('message', ...)` switch block:
```javascript
case 'filesSelected':
    if (message.files && Array.isArray(message.files)) {
        let duplicateCount = 0;
        const availableSlots = MAX_FILES - attachments.length;
        const filesToAdd = message.files.slice(0, availableSlots);
        if (message.files.length > availableSlots) {
            showAttachmentWarning('Can only attach ' + availableSlots + ' more files (limit: ' + MAX_FILES + ')');
        }
        for (const file of filesToAdd) {
            const isDuplicate = attachments.some(
                a => a.path.toLowerCase() === file.path.toLowerCase()
            );
            if (isDuplicate) {
                duplicateCount++;
            } else {
                attachments.push(file);
            }
        }
        if (duplicateCount > 0) {
            showAttachmentWarning(duplicateCount === 1 ? 'File already attached' : duplicateCount + ' files already attached');
        }
        renderAttachmentChips();
        saveState();
    }
    break;
```

Update `clearForm` handler to clear attachments:
```javascript
case 'clearForm':
    // ... existing clear logic ...
    attachments = [];
    renderAttachmentChips();
    // Update saved state to also clear attachments
```

Update `saveState()` to include attachments:
```javascript
function saveState() {
    vscode.setState({
        name: nameInput.value,
        sourceBranch: sourceBranchInput.value,
        prompt: promptInput.value,
        bypassPermissions: bypassPermissions,
        workflow: workflowInput.value,
        attachments: attachments
    });
}
```

Update state restoration (the `previousState` block) to restore attachments:
```javascript
if (previousState) {
    // ... existing restore ...
    attachments = previousState.attachments || [];
    renderAttachmentChips();
}
```

Update form submission to include attachments in the message:
```javascript
vscode.postMessage({
    command: 'createSession',
    name: name,
    sourceBranch: sourceBranch,
    prompt: prompt,
    permissionMode: permissionMode,
    workflow: workflow || null,
    attachments: attachments.map(a => a.path)
});
```

**Important implementation notes:**
- The paperclip button uses `&#128206;` (Unicode paperclip U+1F4CE) per user decision -- no text label, tooltip "Attach files"
- Button appearance does NOT change when files are attached (no count badge or state change) per user decision
- No tooltip on chips per user decision
- Case-insensitive duplicate detection (`.toLowerCase()`) for cross-platform support per research pitfall #2
- File limit check BEFORE opening picker per research pitfall #5
- `uri.fsPath` used (not raw Uri) per research pitfall #4
- HTML escaping for file names to prevent XSS
  </action>
  <verify>
Run `npm run compile` from the project root to confirm TypeScript compilation succeeds with the updated `SessionFormSubmitCallback` type and new `path` import. All existing call sites of `setOnSubmit` will need their callbacks updated (this will show compile errors -- expected, will be fixed in Plan 02). To verify just this file compiles in isolation, check that no syntax errors are reported for `SessionFormProvider.ts`.

Note: Full `npm test` will likely fail until Plan 02 updates the callback call sites in `extension.ts` and tests. That is expected.
  </verify>
  <done>
SessionFormProvider.ts contains: (1) a paperclip attach button overlaid inside the textarea bottom-right, (2) chip list rendering below textarea with file type icon + filename + X remove button, (3) showFilePicker message handler calling vscode.window.showOpenDialog with canSelectMany:true, (4) filesSelected message handler with case-insensitive duplicate detection and 20-file limit, (5) attachments included in saveState/getState for webview persistence, (6) attachments array sent in createSession message, (7) updated SessionFormSubmitCallback type with attachments parameter.
  </done>
</task>

<task type="checkpoint:human-verify" gate="informational">
  <what-built>File attachment UI in the session creation form -- paperclip button, file picker integration, chip list with remove buttons, duplicate detection, state persistence</what-built>
  <how-to-verify>
    1. Press F5 in VS Code to launch the Extension Development Host
    2. Open the Lanes sidebar panel -- you should see the session creation form
    3. Look at the "Starting Prompt" textarea -- there should be a paperclip button in the bottom-right corner
    4. Hover over the paperclip button -- tooltip should say "Attach files"
    5. Click the paperclip button -- VS Code native file picker should open
    6. Select 2-3 files and click "Attach" -- chips should appear below the textarea showing icon + filename + X
    7. Click the X on one chip -- it should be removed
    8. Click the paperclip again and select a file you already attached -- you should see a brief "File already attached" warning that auto-dismisses
    9. Collapse and re-expand the Lanes sidebar -- the attached files should still be shown (state persistence)
    10. Note: Creating a session will fail at this point because the callback wiring is not yet updated -- that is Plan 02
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues</resume-signal>
</task>

</tasks>

<verification>
- The form renders with a paperclip button inside the textarea area
- Clicking the button triggers the VS Code file picker dialog
- Selected files appear as chips with filename and remove button
- Duplicate files are detected (case-insensitive) and warned about
- File limit of 20 is enforced
- Attachments persist in webview state across hide/show cycles
- The createSession message includes attachments array
- TypeScript compiles without errors in SessionFormProvider.ts
</verification>

<success_criteria>
- Paperclip button visible inside textarea bottom-right corner
- File picker opens with multi-select enabled
- Chips render below textarea with file type icon + filename + X
- Remove button works on chips
- Duplicate detection works (case-insensitive)
- State persistence works across webview hide/show
- createSession message includes attachments array of file paths
</success_criteria>

<output>
After completion, create `.planning/phases/01-file-attachment-ui-and-integration/01-01-SUMMARY.md`
</output>
