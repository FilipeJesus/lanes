---
phase: 04-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SessionFormProvider.ts
  - src/extension.ts
  - src/test/session/session-form.test.ts
autonomous: true

must_haves:
  truths:
    - "Session creation form shows agent dropdown when both Claude and Codex CLIs are installed"
    - "Session creation form hides agent dropdown when only one agent CLI is available"
    - "Dropdown defaults to lanes.defaultAgent VS Code setting value"
    - "Unavailable agent appears as disabled option with '(not installed)' suffix"
    - "Form submission passes selected agent name to the session creation callback"
    - "Agent selection resets to default on form clear after successful submission"
    - "Permission toggle state is preserved when user switches agent selection"
    - "If lanes.defaultAgent points to unavailable CLI, warning notification shown and Claude used as fallback"
  artifacts:
    - path: "src/SessionFormProvider.ts"
      provides: "Agent dropdown HTML, agentAvailability state, updated callback type with agent parameter"
      contains: "setAgentAvailability"
    - path: "src/extension.ts"
      provides: "CLI availability checks for all agents at activation, agent resolution from form submission"
      contains: "agentAvailability"
    - path: "src/test/session/session-form.test.ts"
      provides: "Tests for agent dropdown HTML, callback agent parameter, state persistence"
      contains: "Agent Dropdown"
  key_links:
    - from: "src/SessionFormProvider.ts"
      to: "src/extension.ts"
      via: "SessionFormSubmitCallback with agent parameter"
      pattern: "agent.*string"
    - from: "src/extension.ts"
      to: "src/codeAgents/factory.ts"
      via: "getAgent() to resolve agent name to CodeAgent instance"
      pattern: "getAgent\\(.*agent"
    - from: "src/SessionFormProvider.ts webview JS"
      to: "src/SessionFormProvider.ts message handler"
      via: "postMessage with agent field in createSession command"
      pattern: "agent.*agentInput"
---

<objective>
Add agent selection dropdown to the session creation webview form and wire it through to session creation so users can choose between Claude Code and Codex CLI per session.

Purpose: Fulfills REQ-U1 (agent selector), REQ-U2 (permission adaptation -- already works via existing toggle + agent command building), and validates REQ-U3 (terminal differentiation -- already implemented in Phase 2/3).
Output: Updated SessionFormProvider with agent dropdown, updated extension activation with CLI availability checks, updated tests.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ui-integration/04-CONTEXT.md
@.planning/phases/04-ui-integration/04-RESEARCH.md
@src/SessionFormProvider.ts
@src/extension.ts
@src/codeAgents/factory.ts
@src/codeAgents/index.ts
@src/test/session/session-form.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent dropdown to SessionFormProvider and update callback signature</name>
  <files>src/SessionFormProvider.ts, src/test/session/session-form.test.ts</files>
  <action>
**SessionFormProvider.ts changes:**

1. Add `_agentAvailability` private field (`Map<string, boolean>`) and `_defaultAgent` private field (string, defaults to `'claude'`).

2. Add `setAgentAvailability(availability: Map<string, boolean>, defaultAgent: string)` public method that stores both values and posts `updateAgentAvailability` message to webview if already visible.

3. Update `SessionFormSubmitCallback` type to add `agent: string` as the SECOND parameter (after name, before prompt):
   ```typescript
   export type SessionFormSubmitCallback = (
       name: string,
       agent: string,
       prompt: string,
       sourceBranch: string,
       permissionMode: PermissionMode,
       workflow: string | null,
       attachments: string[]
   ) => void | Promise<void>;
   ```

4. Add private `_getAgentDropdownHtml()` method that:
   - Counts available agents from `_agentAvailability`
   - Returns empty string if available count <= 1 (per user decision: hide dropdown when only one agent available)
   - Otherwise returns a `<div class="form-group">` with:
     - Label: `<label for="agent">Code Agent</label>`
     - `<select id="agent" name="agent">` with options for all agents
     - Agent list: `{ name: 'claude', label: 'Claude Code' }` and `{ name: 'codex', label: 'Codex CLI' }`
     - Unavailable agents get `disabled` attribute and label becomes `"Codex CLI (not installed)"`
     - Default agent gets `selected` attribute (use `this._defaultAgent`)
     - Hint: `<div class="hint">Select which AI assistant to use for this session</div>`
   - Use `this._escapeHtml()` for all labels

5. In `_getHtmlForWebview()`:
   - Insert `${this._getAgentDropdownHtml()}` AFTER the session name form-group div and BEFORE the source branch form-group div (per user decision: second field in form)
   - Add CSS for disabled option styling:
     ```css
     select option:disabled {
         opacity: 0.5;
         color: var(--vscode-disabledForeground);
         font-style: italic;
     }
     ```
   - In the webview JavaScript section:
     - Add `const agentInput = document.getElementById('agent');` after existing element references
     - Update `saveState()` to include `agent: agentInput ? agentInput.value : '${this._escapeHtml(this._defaultAgent)}'`
     - Update state restoration to restore agent: `if (agentInput && previousState.agent) { agentInput.value = previousState.agent; }`
     - Add change listener: `if (agentInput) { agentInput.addEventListener('change', saveState); }` -- ONLY saveState, no permission state modification (per user decision: toggle state preserved on agent switch)
     - Update form submit to include `agent: agentInput ? agentInput.value : '${this._escapeHtml(this._defaultAgent)}'` in the postMessage
     - In `clearForm` message handler, reset agent to default: `if (agentInput) { agentInput.value = '${this._escapeHtml(this._defaultAgent)}'; }` (per user decision: always resets to lanes.defaultAgent)
     - Update cleared state to include `agent: '${this._escapeHtml(this._defaultAgent)}'`
     - Add handler for `updateAgentAvailability` message that dynamically shows/hides the agent form group and updates disabled states (for when availability is sent after webview is already open)

6. Update the `createSession` message handler in `resolveWebviewView` to pass `message.agent` as the second argument to `this._onSubmit`:
   ```typescript
   await this._onSubmit(
       message.name,
       message.agent || 'claude',
       message.prompt,
       message.sourceBranch || '',
       message.permissionMode || 'acceptEdits',
       message.workflow || null,
       message.attachments || []
   );
   ```

**Test file changes (src/test/session/session-form.test.ts):**

1. Update ALL existing `SessionFormSubmitCallback` usages to include the new `agent: string` parameter as the second parameter. This affects approximately 8 callback definitions in the test file. Each needs `agent: string` added after `name: string`.

2. Update all `simulateMessage` calls to include `agent: 'claude'` field.

3. Add a new test suite `'Agent Dropdown'` with tests:
   - "Form includes agent dropdown when multiple agents available": Call `setAgentAvailability(new Map([['claude', true], ['codex', true]]), 'claude')`, get HTML, assert `id="agent"` and both option labels exist
   - "Form hides agent dropdown when only one agent available": Call `setAgentAvailability(new Map([['claude', true], ['codex', false]]), 'claude')`, get HTML, assert `id="agent"` does NOT exist
   - "Agent dropdown shows disabled option for unavailable agent": Call `setAgentAvailability(new Map([['claude', true], ['codex', false]]), 'claude')` -- but we need 2+ available for dropdown to show. Instead: test the `_getAgentDropdownHtml` private method via HTML when `setAgentAvailability(new Map([['claude', true], ['codex', true]]), 'claude')` then verify label text. Actually, since dropdown is hidden when only 1 available, the disabled option scenario requires a different test: set both to true, get HTML, verify no disabled. Then for a scenario where we want to show disabled: the dropdown only shows when count > 1. So the disabled option scenario requires a deliberate test of HTML generation with forced availability. Test: set `Map([['claude', true], ['codex', false]])`, verify HTML does NOT contain agent dropdown (hidden per count <= 1 rule). Add separate test: set `Map([['claude', true], ['codex', true]])`, verify both options enabled. Note: The disabled option logic exists in the code but only manifests when a third agent is added or we relax the hide rule. For now, verify the code path exists by testing with both available and checking neither has disabled.

4. Add test suite `'Agent Callback'` with:
   - "Session form passes agent to callback": Set up callback capturing agent param, simulate message with `agent: 'codex'`, assert callback received `'codex'`
   - "Session form defaults agent to claude when not provided": Simulate message without agent field, assert callback received `'claude'`

5. Add to `'Form State Persistence'` suite:
   - "Form JavaScript saves agent in state": Get HTML with multiple agents available, assert `agent:` appears in saveState
   - "Form JavaScript resets agent to default on clearForm": Get HTML, assert agent reset logic in clearForm handler
  </action>
  <verify>Run `npm run compile` to ensure TypeScript compiles without errors. Run `npm test` to verify all existing tests still pass and new tests pass.</verify>
  <done>SessionFormProvider has agent dropdown that conditionally renders based on availability. Callback type includes agent parameter. All tests pass including new agent dropdown and callback tests.</done>
</task>

<task type="auto">
  <name>Task 2: Wire CLI availability checks and agent resolution in extension activation</name>
  <files>src/extension.ts</files>
  <action>
**extension.ts changes:**

1. Add import for `getAvailableAgents` and `isCliAvailable` from `'./codeAgents'` (they are already exported from the index, may need to add to the existing import statement).

2. In `activate()`, AFTER the existing agent validation block (lines ~105-121 where `codeAgent` is determined) and BEFORE the `SessionFormProvider` initialization (line ~164), add CLI availability checking for ALL agents:
   ```typescript
   // Check CLI availability for all registered agents (for form dropdown)
   const agentAvailability = new Map<string, boolean>();
   for (const agentName of getAvailableAgents()) {
       const agent = getAgent(agentName);
       if (agent) {
           const available = await isCliAvailable(agent.cliCommand);
           agentAvailability.set(agentName, available);
       } else {
           agentAvailability.set(agentName, false);
       }
   }
   ```

3. Determine the effective default agent for the form. After the availability check, validate the user's configured default:
   ```typescript
   // Determine effective default agent for the form
   let effectiveDefaultAgent = defaultAgentName;
   if (!agentAvailability.get(defaultAgentName)) {
       // User decision: show warning and fall back to Claude
       vscode.window.showWarningMessage(
           `Default agent '${defaultAgentName}' is not installed. Falling back to Claude Code.`
       );
       effectiveDefaultAgent = 'claude';
   }
   ```
   Note: The existing code already handles agent fallback for the global `codeAgent` instance (lines 109-120). This new block handles the form default separately. Avoid duplicate warnings -- the existing `validateAndGetAgent` already shows a warning about CLI not found. Remove the overlap by checking: if `defaultAgentName !== 'claude'` and it was already warned about by `validateAndGetAgent`, skip the second warning. Simplest approach: only show the form-default warning if the default agent is NOT Claude (since Claude falling back to Claude is a no-op).

4. AFTER `sessionFormProvider` is created (line ~164), call:
   ```typescript
   sessionFormProvider.setAgentAvailability(agentAvailability, effectiveDefaultAgent);
   ```

5. Update the `setOnSubmit` callback (line ~174) to accept the new `agent` parameter and resolve it to a CodeAgent instance:
   ```typescript
   sessionFormProvider.setOnSubmit(async (name: string, agent: string, prompt: string, sourceBranch: string, permissionMode: PermissionMode, workflow: string | null, attachments: string[]) => {
       // Resolve agent name to CodeAgent instance
       const selectedAgent = getAgent(agent) || codeAgent;
       await createSession(name, prompt, permissionMode, sourceBranch, workflow, attachments, baseRepoPath, sessionProvider, selectedAgent);
   });
   ```
   This resolves the agent name string from the webview to a CodeAgent instance using the factory. Falls back to the global `codeAgent` (always Claude or validated default) if resolution fails.

6. Do NOT modify the `createSession` function signature in `SessionService.ts` -- it already accepts `codeAgent?: CodeAgent` as the last parameter. The agent resolution happens in `extension.ts` before calling `createSession`.
  </action>
  <verify>Run `npm run compile` to confirm no type errors. Run `npm test` to verify all tests pass. Manually verify the flow: form sends agent name string -> extension resolves to CodeAgent -> passes to createSession.</verify>
  <done>Extension activation checks all agent CLI availability, passes availability map to form provider, and the form submission callback resolves agent name to CodeAgent instance before creating the session. Warning shown when default agent is unavailable.</done>
</task>

</tasks>

<verification>
1. `npm run compile` succeeds with zero errors
2. `npm test` passes all existing and new tests
3. SessionFormProvider HTML contains agent dropdown when `setAgentAvailability` called with 2+ available agents
4. SessionFormProvider HTML omits agent dropdown when only 1 agent available
5. SessionFormSubmitCallback type signature includes `agent: string` as second parameter
6. Extension.ts resolves agent name from form to CodeAgent instance via factory
7. Form clear resets agent to default (not last-used)
8. Agent change does not affect bypass permissions toggle state
</verification>

<success_criteria>
- Agent dropdown appears in session form when multiple CLIs available, hidden when only one
- Dropdown defaults to `lanes.defaultAgent` setting, resets on form clear
- Unavailable agents shown as disabled with "(not installed)" suffix
- Selected agent name flows from webview -> extension -> createSession as CodeAgent instance
- Permission toggle state preserved across agent switches
- Warning shown when default agent CLI unavailable, falls back to Claude
- All existing tests pass with updated callback signature
- New tests cover agent dropdown rendering, callback, and state persistence
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-integration/04-01-SUMMARY.md`
</output>
