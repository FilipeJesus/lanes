---
phase: 02-agent-abstraction-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/codeAgents/CodexAgent.ts
  - src/codeAgents/factory.ts
  - src/codeAgents/index.ts
  - src/extension.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Factory creates ClaudeCodeAgent when lanes.defaultAgent is 'claude'"
    - "Factory creates CodexAgent when lanes.defaultAgent is 'codex'"
    - "Unrecognized lanes.defaultAgent values fall back to Claude with a VS Code warning"
    - "Factory returns singleton instances (same object reference on repeated calls)"
    - "Factory validates CLI availability at creation time using command -v"
    - "lanes.defaultAgent VS Code setting exists with enum options claude and codex"
    - "Extension activation uses factory instead of direct ClaudeCodeAgent instantiation"
  artifacts:
    - path: "src/codeAgents/factory.ts"
      provides: "Agent factory with hardcoded map and singleton caching"
      exports: ["getAgent", "getAvailableAgents", "getDefaultAgent"]
    - path: "src/codeAgents/CodexAgent.ts"
      provides: "Stub CodexAgent extending CodeAgent with minimal implementations"
      exports: ["CodexAgent"]
    - path: "src/codeAgents/index.ts"
      provides: "Re-exports factory functions and CodexAgent"
    - path: "package.json"
      provides: "lanes.defaultAgent configuration property with enum"
      contains: "lanes.defaultAgent"
    - path: "src/extension.ts"
      provides: "Factory-based agent creation in activate()"
  key_links:
    - from: "src/extension.ts"
      to: "src/codeAgents/factory.ts"
      via: "getDefaultAgent() + getAgent() calls"
      pattern: "getDefaultAgent|getAgent"
    - from: "src/codeAgents/factory.ts"
      to: "src/codeAgents/CodexAgent.ts"
      via: "import and factory map entry"
      pattern: "CodexAgent"
    - from: "src/codeAgents/factory.ts"
      to: "src/codeAgents/ClaudeCodeAgent.ts"
      via: "import and factory map entry"
      pattern: "ClaudeCodeAgent"
---

<objective>
Create the agent factory with hardcoded map, singleton lifecycle, CLI availability validation, and `lanes.defaultAgent` VS Code setting. Also create a stub CodexAgent that extends CodeAgent with minimal implementations (full implementation deferred to Phase 3).

Purpose: This is the foundation for multi-agent support. The factory determines which CodeAgent subclass to instantiate based on the user's setting, and the extension uses it instead of directly constructing ClaudeCodeAgent.

Output: Factory module, stub CodexAgent, updated extension activation, and new VS Code configuration property.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-abstraction-enhancement/02-CONTEXT.md
@.planning/phases/02-agent-abstraction-enhancement/02-RESEARCH.md

@src/codeAgents/CodeAgent.ts
@src/codeAgents/ClaudeCodeAgent.ts
@src/codeAgents/index.ts
@src/extension.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CodexAgent stub and agent factory module</name>
  <files>
    src/codeAgents/CodexAgent.ts
    src/codeAgents/factory.ts
    src/codeAgents/index.ts
  </files>
  <action>
**Create `src/codeAgents/CodexAgent.ts`** - A stub implementation of CodeAgent for Codex CLI. This is a STUB for Phase 2 infrastructure; full implementation comes in Phase 3. Implement all abstract methods with minimal valid returns:

- Constructor: calls `super()` with config `{ name: 'codex', displayName: 'Codex', cliCommand: 'codex', sessionFileExtension: '.claude-session', statusFileExtension: '.claude-status', settingsFileName: 'config.toml', defaultDataDir: '.codex' }`. Note: `sessionFileExtension` and `statusFileExtension` use `.claude-session` / `.claude-status` per user decision (session file name stays the same for ALL agents).
- `getSessionFileName()`: return `this.config.sessionFileExtension`
- `getStatusFileName()`: return `this.config.statusFileExtension`
- `getSettingsFileName()`: return `this.config.settingsFileName`
- `getDataDirectory()`: return `this.config.defaultDataDir`
- `getLocalSettingsFiles()`: return `[{ dir: '.codex', file: 'config.toml' }]`
- `getTerminalName(sessionName)`: return `` `Codex: ${sessionName}` ``
- `getTerminalIcon()`: return `{ id: 'robot', color: 'terminal.ansiBlue' }` (blue to differentiate from Claude's green)
- `buildStartCommand()`: return `'codex'` (stub - Phase 3 implements full command building)
- `buildResumeCommand()`: return `'codex resume --last'` (stub)
- `parseSessionData(content)`: parse JSON, validate sessionId exists and is string, return `{ sessionId, timestamp, agentName: this.config.name, workflow, isChimeEnabled }`. No UUID validation (Codex IDs may not be UUIDs).
- `parseStatus(content)`: parse JSON, validate status field, return `{ status, timestamp, message }`
- `getValidStatusStates()`: return `['active', 'idle']` (hookless agents only have active/idle per user decision)
- `getPermissionModes()`: return stub array with `[{ id: 'read-only', label: 'Read Only' }, { id: 'workspace-write', label: 'Workspace Write' }, { id: 'full-access', label: 'Full Access' }]`
- `validatePermissionMode(mode)`: check against getPermissionModes()
- `getPermissionFlag(mode)`: return empty string (stub - Phase 3 maps to --sandbox and --ask-for-approval)
- `getHookEvents()`: return `[]` (Codex has no hook system)
- `generateHooksConfig()`: return `[]` (no hooks)
- `supportsMcp()`: return `false`

**Create `src/codeAgents/factory.ts`** - Agent factory with hardcoded map and singleton lifecycle:

- `const instances = new Map<string, CodeAgent>()` for singleton caching
- `const agentConstructors: Record<string, () => CodeAgent>` map with `'claude': () => new ClaudeCodeAgent()` and `'codex': () => new CodexAgent()`
- `getAgent(agentName: string): CodeAgent` function: check `instances` cache first, if not cached look up in `agentConstructors`, create instance, cache it, return it. If `agentName` not in map, return `null` (caller handles fallback).
- `getAvailableAgents(): string[]` function: return `Object.keys(agentConstructors)`
- `getDefaultAgent(): string` function: reads `vscode.workspace.getConfiguration('lanes').get<string>('defaultAgent', 'claude')`, validates against `getAvailableAgents()`. If invalid, shows `vscode.window.showWarningMessage(...)` and returns `'claude'`.
- `async isCliAvailable(cliCommand: string): Promise<boolean>` function: uses `child_process.exec` with `command -v ${cliCommand}` (POSIX builtin, NOT `which`). Returns true if exit code 0, false otherwise. Set `shell: true` and use `{ timeout: 5000 }`.
- `async validateAndGetAgent(agentName: string): Promise<CodeAgent | null>` function: calls `getAgent(agentName)`, then calls `isCliAvailable(agent.cliCommand)`. If CLI not available, shows `vscode.window.showWarningMessage('Codex CLI not found. Install it with ...')` and returns null per user decision (factory validates CLI availability at creation time).

Export: `getAgent`, `getAvailableAgents`, `getDefaultAgent`, `isCliAvailable`, `validateAndGetAgent`.

**Update `src/codeAgents/index.ts`** - Add exports:
- `export { CodexAgent } from './CodexAgent'`
- `export { getAgent, getAvailableAgents, getDefaultAgent, isCliAvailable, validateAndGetAgent } from './factory'`
  </action>
  <verify>
Run `npm run compile` - should compile without errors. Verify that:
- `src/codeAgents/CodexAgent.ts` exists and exports `CodexAgent` class
- `src/codeAgents/factory.ts` exists and exports factory functions
- `src/codeAgents/index.ts` re-exports everything
  </verify>
  <done>
CodexAgent stub class exists with all abstract methods implemented. Factory module creates singleton instances from hardcoded map. CLI availability check uses `command -v`. All exports accessible from `src/codeAgents/index.ts`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add lanes.defaultAgent setting and update extension activation to use factory</name>
  <files>
    package.json
    src/extension.ts
  </files>
  <action>
**Update `package.json`** - Add `lanes.defaultAgent` configuration property. Add a new configuration group after the existing "Lanes: General" group (or within it as the last property):

```json
"lanes.defaultAgent": {
  "type": "string",
  "enum": ["claude", "codex"],
  "enumDescriptions": [
    "Claude Code - AI coding assistant by Anthropic",
    "Codex CLI - AI coding assistant by OpenAI (requires codex CLI)"
  ],
  "default": "claude",
  "description": "Default code agent for new sessions",
  "order": 3
}
```

Place this in the "Lanes: General" configuration section after `lanes.promptsFolder`.

**Update `src/extension.ts`** - Replace direct `ClaudeCodeAgent` instantiation with factory:

1. Update imports: replace `import { ClaudeCodeAgent, CodeAgent } from './codeAgents'` with `import { CodeAgent, getDefaultAgent, getAgent, validateAndGetAgent } from './codeAgents'`

2. Replace the line `const codeAgent = new ClaudeCodeAgent()` (around line 102) with:
```typescript
// Create the global code agent instance using the factory
// Reads lanes.defaultAgent setting and creates the appropriate agent
const defaultAgentName = getDefaultAgent();
let codeAgent: CodeAgent;

// Validate CLI availability for the selected agent
const validatedAgent = await validateAndGetAgent(defaultAgentName);
if (validatedAgent) {
    codeAgent = validatedAgent;
} else {
    // CLI not available - fall back to Claude (always available as default)
    const fallbackAgent = getAgent('claude');
    if (!fallbackAgent) {
        // This should never happen - Claude is always in the factory map
        throw new Error('Failed to create default Claude agent');
    }
    codeAgent = fallbackAgent;
}
```

3. Update the console.log after agent creation: `console.log(\`Code agent initialized: ${codeAgent.displayName} (${codeAgent.name})\`)`

4. Keep all other code unchanged - the `codeAgent` variable is already passed through the ServiceContainer to all services.

Do NOT change any other imports or usages of `ClaudeCodeAgent` elsewhere (SettingsService, SessionService, TerminalService still import it for their fallback paths, which is fine).
  </action>
  <verify>
Run `npm run compile` to verify no TypeScript errors. Then run `npm test` to verify all existing tests still pass (backward compatibility). Check that `package.json` has the new `lanes.defaultAgent` property with enum values.
  </verify>
  <done>
- `package.json` contains `lanes.defaultAgent` setting with `claude` and `codex` enum options, defaulting to `claude`
- Extension activation reads the setting via `getDefaultAgent()`, validates CLI availability, and falls back to Claude if the selected agent's CLI is not installed
- All existing tests pass unchanged (backward compatibility maintained)
  </done>
</task>

</tasks>

<verification>
1. `npm run compile` passes with zero errors
2. `npm test` passes with all existing tests unchanged
3. `grep -r 'lanes.defaultAgent' package.json` shows the new setting
4. `grep -r 'getDefaultAgent\|getAgent\|validateAndGetAgent' src/extension.ts` shows factory usage
5. No direct `new ClaudeCodeAgent()` in `src/extension.ts` (moved to factory)
</verification>

<success_criteria>
- Agent factory creates correct CodeAgent subclass based on agent name
- Singleton pattern: `getAgent('claude') === getAgent('claude')` (same reference)
- `getDefaultAgent()` reads `lanes.defaultAgent` VS Code setting
- Invalid agent names fall back to Claude with a warning notification
- CLI availability check uses `command -v` (POSIX builtin)
- Extension activation uses factory instead of direct construction
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-abstraction-enhancement/02-01-SUMMARY.md`
</output>
