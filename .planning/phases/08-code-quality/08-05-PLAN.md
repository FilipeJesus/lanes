---
phase: 08-code-quality
plan: 05
type: execute
wave: 4
depends_on: ["08-03", "08-04"]
files_modified:
  - src/extension.ts
  - src/watchers.ts
  - src/mcp/server.ts
  - src/services/SessionService.ts
  - src/services/TerminalService.ts
  - src/services/SessionProcessService.ts
  - src/services/WorkflowService.ts
  - src/localSettings.ts
autonomous: true

must_haves:
  truths:
    - "All production code (non-test) uses async file I/O"
    - "ESLint shows zero sync fs violations in src/"
    - "All services use FileService for file operations"
    - "No fs.readFileSync/writeFileSync/existsSync/mkdirSync in src/"
  artifacts:
    - path: "src/"
      provides: "Production code with async file I/O"
      excludes: ["readFileSync", "writeFileSync", "existsSync", "mkdirSync"]
  key_links:
    - from: "All migrated files"
      to: "src/services/FileService.ts"
      via: "import and use FileService for file operations"
      pattern: "import.*FileService"
---

<objective>
Complete final migration pass: convert remaining sync file I/O to async in all production code.

Purpose: Finish the async I/O migration by handling the remaining modules: extension.ts, watchers.ts, mcp/server.ts, and the service modules. After this plan, all production code should use async file I/O exclusively.

Output: Zero sync fs operations in src/ directory (excluding tests), all modules using FileService or McpAdapter.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-code-quality/08-RESEARCH.md
@.planning/phases/08-code-quality/08-01-SUMMARY.md
@.planning/phases/08-code-quality/08-02-SUMMARY.md
@.planning/phases/08-code-quality/08-03-SUMMARY.md
@.planning/phases/08-code-quality/08-04-SUMMARY.md

# Remaining files with sync fs
@src/extension.ts - May have sync fs for config checks
@src/watchers.ts - Uses fs.existsSync for git dir checks
@src/mcp/server.ts - Uses fs.existsSync
@src/services/SessionService.ts - May have sync fs
@src/services/TerminalService.ts - May have sync fs
@src/services/SessionProcessService.ts - May have sync fs
@src/services/WorkflowService.ts - Uses fs.existsSync for template checks
@src/localSettings.ts - Uses fs.promises (already async, verify)
</context>

<tasks>

<task type="auto">
  <name>Migrate extension.ts and watchers.ts to async file I/O</name>
  <files>src/extension.ts, src/watchers.ts</files>
  <action>
Migrate extension.ts and watchers.ts to use FileService:

1. **extension.ts:**
   - Add import: `import { fileExists, readJson } from './services/FileService';`
   - Find any `fs.existsSync()` calls (typically checking for config files)
   - Replace with `await fileExists()`
   - Find any `fs.readFileSync()` calls
   - Replace with `await readJson()` or `await readFile()`
   - Make affected functions async
   - Update activate() if needed (it's already async)

2. **watchers.ts:**
   - Add import: `import { fileExists } from './services/FileService';`
   - Find `fs.existsSync()` calls (typically checking for .git directories)
   - Replace with `await fileExists()`
   - Make affected functions async
   - Ensure the watcher setup properly handles async checks

DO NOT change the extension activation flow. File checks should be fast async operations.
  </action>
  <verify>
grep -c "\.existsSync\|\.readFileSync\|\.writeFileSync" src/extension.ts outputs 0
grep -c "\.existsSync\|\.readFileSync\|\.writeFileSync" src/watchers.ts outputs 0
npm run compile passes
  </verify>
  <done>
extension.ts and watchers.ts use only async file I/O
  </done>
</task>

<task type="auto">
  <name>Migrate mcp/server.ts to async file I/O</name>
  <files>src/mcp/server.ts</files>
  <action>
Migrate src/mcp/server.ts to use FileService:

1. **Update imports:**
   - Add: `import { fileExists, readJson } from '../services/FileService';`
   - Remove: `import * as fs from 'fs';` (after migration)

2. **Find sync fs operations:**
   - Search for `fs.existsSync()` calls
   - These are likely used for checking if workflow state exists

3. **Replace with FileService:**
   - `fs.existsSync(path)` -> `await fileExists(path)`
   - `fs.readFileSync(path, 'utf-8')` -> `await readJson(path)`

4. **Make affected functions async:**
   - Add `async` keyword where needed
   - Update return types to Promise<T>

Note: mcp/server.ts is the MCP server entry point. Keep the server startup logic intact.
  </action>
  <verify>
grep -c "\.existsSync\|\.readFileSync\|\.writeFileSync" src/mcp/server.ts outputs 0
npm run compile passes
  </verify>
  <done>
mcp/server.ts uses only async file I/O via FileService
  </done>
</task>

<task type="auto">
  <name>Migrate remaining service modules to async file I/O</name>
  <files>src/services/SessionService.ts, src/services/TerminalService.ts, src/services/SessionProcessService.ts, src/services/WorkflowService.ts</files>
  <action>
Migrate remaining service modules to use FileService:

For each service file (SessionService.ts, TerminalService.ts, SessionProcessService.ts, WorkflowService.ts):

1. **Update imports:**
   - Add: `import { fileExists, readJson, readFile, writeJson, atomicWrite, ensureDir } from '../services/FileService';`
   - Remove: `import * as fs from 'fs';` (after migration)

2. **Find and replace sync fs operations:**
   - `fs.existsSync()` -> `await fileExists()`
   - `fs.readFileSync()` -> `await readJson()` or `await readFile()`
   - `fs.writeFileSync()` -> `await writeJson()` or `await atomicWrite()`
   - `fs.mkdirSync()` -> `await ensureDir()`

3. **Make functions async:**
   - Add `async` keyword to functions using FileService
   - Update return types to Promise<T>

4. **Special consideration for WorkflowService.ts:**
   - It checks for workflow template files (existsSync)
   - Template loading should use readFile
   - Template validation logic should stay the same

Note: These services were extracted in Phase 7. They may have inherited sync patterns from the original extension.ts code.
  </action>
  <verify>
grep -c "\.existsSync\|\.readFileSync\|\.writeFileSync\|\.mkdirSync" src/services/*.ts outputs 0
npm run compile passes
  </verify>
  <done>
All service modules use only async file I/O via FileService
  </done>
</task>

<task type="auto">
  <name>Verify and fix localSettings.ts async pattern</name>
  <files>src/localSettings.ts</files>
  <action>
Verify src/localSettings.ts uses async file I/O correctly:

1. **Check current implementation:**
   - Read the file to verify it already uses fs/promises
   - According to research, this file already uses `await fsPromises.access()`

2. **If any sync patterns found:**
   - Replace with FileService methods
   - Add FileService import if needed

3. **Verify async consistency:**
   - Ensure all file operations are awaited
   - Check that error handling is consistent with FileService patterns

Note: localSettings.ts should already be async. This task is verification and any needed fixes.
  </action>
  <verify>
grep -c "\.Sync" src/localSettings.ts outputs 0
npm run compile passes
  </verify>
  <done>
localSettings.ts verified async (or migrated if needed)
  </done>
</task>

<task type="auto">
  <name>Run ESLint to verify no sync fs violations</name>
  <files>eslint.config.mjs</files>
  <action>
Run ESLint to verify all sync fs operations have been migrated:

1. **Run ESLint on src directory:**
   ```bash
   npx eslint "src/**/*.ts" --max-warnings=0
   ```

2. **Check for sync fs violations:**
   - Look for "no-sync-fs" errors from our custom rule
   - These indicate remaining sync fs operations

3. **If violations found:**
   - Note the files and line numbers
   - Fix each violation by replacing with FileService methods
   - Re-run ESLint to verify

4. **Final verification:**
   - Run `npm run lint` to check full linting status
   - Run `npm run compile` to verify TypeScript compilation
   - Run `npm test` to verify tests still pass

DO NOT commit if ESLint shows sync fs violations in production code.
  </action>
  <verify>
npm run lint exits with code 0
npm run compile exits with code 0
grep -r "fs\.\(readFileSync\|writeFileSync\|existsSync\|mkdirSync\)" src/ --include="*.ts" | grep -v test | wc -l outputs 0
  </verify>
  <done>
Zero sync fs operations in src/ directory (excluding tests)
  </done>
</task>

</tasks>

<verification>
1. All files in src/ use async file I/O (no sync fs methods)
2. ESLint passes with zero sync fs violations
3. TypeScript compilation succeeds
4. Test suite passes (functionality unchanged)
5. Only test files may use sync fs (acceptable for test setup)
</verification>

<success_criteria>
1. Zero sync fs operations in production code
2. All modules use FileService or McpAdapter
3. ESLint enforces async-only patterns
4. Codebase follows consistent async/await conventions
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-quality/08-05-SUMMARY.md` with:
- Final count of migrated files/operations
- ESLint verification results
- Any test files that still use sync fs (acceptable)
- Phase 8 complete summary
</output>
