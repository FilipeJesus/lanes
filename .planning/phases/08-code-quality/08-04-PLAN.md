---
phase: 08-code-quality
plan: 04
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - src/mcp/tools.ts
  - src/workflow/state.ts
  - src/commands/sessionCommands.ts
autonomous: true

must_haves:
  truths:
    - "MCP tools use McpAdapter instead of direct file I/O"
    - "workflow/state.ts uses FileService for async operations"
    - "sessionCommands use FileService for async operations"
    - "No sync fs methods in migrated files"
  artifacts:
    - path: "src/mcp/tools.ts"
      provides: "MCP tools using McpAdapter"
      contains: "import.*mcpAdapter"
      excludes: ["fs.promises", "readFileSync", "writeFileSync"]
    - path: "src/workflow/state.ts"
      provides: "Workflow state with async file I/O"
      contains: "import.*FileService"
      excludes: ["existsSync", "readFileSync", "writeFileSync"]
    - path: "src/commands/sessionCommands.ts"
      provides: "Session commands with async file I/O"
      contains: "import.*FileService"
      excludes: ["existsSync", "readFileSync", "writeFileSync"]
  key_links:
    - from: "src/mcp/tools.ts"
      to: "src/services/McpAdapter.ts"
      via: "mcpAdapter import for state persistence"
      pattern: "import.*mcpAdapter"
    - from: "src/workflow/state.ts"
      to: "src/services/FileService.ts"
      via: "FileService for async state operations"
      pattern: "import.*FileService"
---

<objective>
Migrate MCP tools, workflow state, and session commands to use async file I/O.

Purpose: Complete the async migration for MCP-related modules and command handlers. These modules have mixed sync/async patterns and need consistent async operations. MCP tools will also use the new McpAdapter abstraction.

Output: MCP tools using McpAdapter, workflow/state and sessionCommands using FileService, all with async I/O.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-code-quality/08-RESEARCH.md
@.planning/phases/08-code-quality/08-01-SUMMARY.md
@.planning/phases/08-code-quality/08-02-SUMMARY.md

# Files to migrate
@src/mcp/tools.ts - Has atomic write pattern, migrate to McpAdapter
@src/workflow/state.ts - Uses fs.existsSync, migrate to FileService
@src/commands/sessionCommands.ts - Uses fs.existsSync, migrate to FileService
@src/services/FileService.ts - Created in 08-01
@src/services/McpAdapter.ts - Created in 08-02
</context>

<tasks>

<task type="auto">
  <name>Migrate MCP tools to use McpAdapter</name>
  <files>src/mcp/tools.ts</files>
  <action>
Migrate src/mcp/tools.ts to use McpAdapter for file operations:

1. **Update imports:**
   - Add: `import { mcpAdapter } from '../services/McpAdapter';`
   - Remove: `import * as fs from 'fs';` (no longer needed for state operations)
   - Keep: `import * as path from 'path';` (still needed for other paths)

2. **Refactor state persistence functions:**
   - `saveState(worktreePath, state)`: Replace implementation with `await mcpAdapter.saveState(worktreePath, state);`
   - `loadState(worktreePath)`: Replace implementation with `return await mcpAdapter.loadState(worktreePath);`

3. **Refactor pending session functions:**
   - Find the function that creates pending session files
   - Replace direct fs.promises calls with `await mcpAdapter.createPendingSession(config);`
   - Ensure PendingSessionConfig is imported from '../types/mcp'

4. **Refactor clear request functions:**
   - Find the function that creates clear request files
   - Replace with `await mcpAdapter.createClearRequest(worktreePath);`

5. **Keep getStatePath() function:**
   - It's a pure function, doesn't do file I/O
   - May still be used by other code

6. **Remove direct fs.promises usage:**
   - After migration, tools.ts should have minimal or no fs.promises calls
   - All file I/O goes through McpAdapter

Note: tools.ts already has good async patterns (lines 40-48 show atomic write).
This task is about using the abstraction layer, not fixing async issues.
  </action>
  <verify>
grep -c "mcpAdapter\." src/mcp/tools.ts outputs > 2
grep -c "fs\.promises\." src/mcp/tools.ts outputs 0 (or minimal for non-state operations)
npm run compile passes
  </verify>
  <done>
MCP tools use McpAdapter for all state and session file operations
  </done>
</task>

<task type="auto">
  <name>Migrate workflow/state.ts to async file I/O</name>
  <files>src/workflow/state.ts</files>
  <action>
Migrate src/workflow/state.ts to use FileService:

1. **Update imports:**
   - Add: `import { fileExists, readJson, writeJson } from '../services/FileService';`
   - Remove: `import * as fs from 'fs';` (after migration)

2. **Find sync fs operations:**
   - Search for `fs.existsSync()` calls
   - Search for `fs.readFileSync()` calls

3. **Replace with FileService methods:**
   - `fs.existsSync(path)` -> `await fileExists(path)`
   - `fs.readFileSync(path, 'utf-8')` -> `await readJson(path)` or `await readFile(path)`
   - `fs.writeFileSync(path, content)` -> `await writeJson(path, data)`

4. **Make affected functions async:**
   - Add `async` keyword
   - Update return types to Promise<T>

5. **Check callers:**
   - If state.ts is imported by other modules, ensure they handle async properly
   - Update callers if needed to await the async calls

DO NOT change the WorkflowStateMachine class behavior, only the file I/O implementation.
  </action>
  <verify>
grep -c "\.existsSync\|\.readFileSync\|\.writeFileSync" src/workflow/state.ts outputs 0
npm run compile passes
  </verify>
  <done>
workflow/state.ts uses only async file I/O via FileService
  </done>
</task>

<task type="auto">
  <name>Migrate sessionCommands to async file I/O</name>
  <files>src/commands/sessionCommands.ts</files>
  <action>
Migrate src/commands/sessionCommands.ts to use FileService:

1. **Update imports:**
   - Add: `import { fileExists, readJson, readFile } from '../services/FileService';`
   - Remove: `import * as fs from 'fs';` (after migration)

2. **Find sync fs operations:**
   - Search for `fs.existsSync()` calls
   - These are typically used to check if session files exist

3. **Replace with FileService:**
   - `fs.existsSync(path)` -> `await fileExists(path)`

4. **Make command handlers async:**
   - Command handlers are already async (they return Promise<void>)
   - Ensure any file existence checks are properly awaited

5. **Test command flows:**
   - Commands should still work with async file checks
   - No behavior changes, only implementation

DO NOT change command handler signatures (they take ExtensionContext as parameter).
  </action>
  <verify>
grep -c "\.existsSync" src/commands/sessionCommands.ts outputs 0
npm run compile passes
  </verify>
  <done>
sessionCommands.ts uses only async file I/O via FileService
  </done>
</task>

</tasks>

<verification>
1. MCP tools use McpAdapter for state operations
2. workflow/state.ts has no sync fs operations
3. sessionCommands.ts has no sync fs operations
4. All files import and use their respective services
5. `npm run compile` passes
6. `npm run lint` shows no sync fs violations in these files
</verification>

<success_criteria>
1. MCP tool handlers use McpAdapter abstraction
2. Workflow state uses async file I/O
3. Session commands use async file I/O
4. ESLint passes for migrated files
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-quality/08-04-SUMMARY.md` with:
- Files migrated
- McpAdapter integration confirmed
- Remaining sync fs files (if any)
- Next steps (final migration pass)
</output>
