---
phase: 08-code-quality
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - src/ClaudeSessionProvider.ts
  - src/PreviousSessionProvider.ts
autonomous: true

must_haves:
  truths:
    - "ClaudeSessionProvider uses async file I/O (no sync methods)"
    - "All fs.existsSync replaced with FileService.fileExists"
    - "All fs.readFileSync replaced with FileService.readJson or readFile"
    - "All fs.writeFileSync replaced with FileService.atomicWrite or writeJson"
    - "All fs.mkdirSync replaced with FileService.ensureDir"
  artifacts:
    - path: "src/ClaudeSessionProvider.ts"
      provides: "Session provider with async file I/O"
      contains: "import.*FileService"
      excludes: ["readFileSync", "writeFileSync", "existsSync", "mkdirSync"]
    - path: "src/PreviousSessionProvider.ts"
      provides: "Previous session provider with async file I/O"
      contains: "import.*FileService"
      excludes: ["readFileSync", "writeFileSync", "existsSync"]
  key_links:
    - from: "src/ClaudeSessionProvider.ts"
      to: "src/services/FileService.ts"
      via: "import statements for async file operations"
      pattern: "import.*FileService"
---

<objective>
Migrate ClaudeSessionProvider and PreviousSessionProvider from sync to async file I/O.

Purpose: Eliminate the heaviest users of synchronous file I/O. ClaudeSessionProvider has ~20 sync fs calls that block the UI thread. Migration to async improves responsiveness and establishes the pattern for other modules.

Output: Two provider modules fully migrated to FileService with no sync fs operations.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-code-quality/08-RESEARCH.md
@.planning/phases/08-code-quality/08-01-SUMMARY.md
@.planning/phases/08-code-quality/08-02-SUMMARY.md

# Files to migrate
@src/ClaudeSessionProvider.ts - Primary target, ~20 sync fs operations (lines 310-943)
@src/PreviousSessionProvider.ts - Secondary target, multiple sync fs operations
@src/services/FileService.ts - Created in 08-01, use for all file operations
</context>

<tasks>

<task type="auto">
  <name>Migrate ClaudeSessionProvider to async file I/O</name>
  <files>src/ClaudeSessionProvider.ts</files>
  <action>
Migrate ClaudeSessionProvider.ts from sync to async file I/O:

1. **Update imports:**
   - Add: `import * as path from 'path';` (if not already present)
   - Add: `import { atomicWrite, readJson, readFile, fileExists, ensureDir, writeJson } from './services/FileService';`
   - Remove: `import * as fs from 'fs';` (after migration)

2. **Convert sync fs calls to FileService methods:**
   - `fs.existsSync(dir)` -> `await fileExists(dir)`
   - `fs.mkdirSync(dir, { recursive: true })` -> `await ensureDir(dir)`
   - `fs.readFileSync(sessionPath, 'utf-8')` -> `await readJson(sessionPath)` or `await readFile(sessionPath)`
   - `fs.writeFileSync(sessionPath, JSON.stringify(...))` -> `await writeJson(sessionPath, data)`

3. **Make functions async:**
   - Add `async` keyword to any function that uses FileService
   - Update return types: `T | null` -> `Promise<T | null>`, `void` -> `Promise<void>`

4. **Specific function migrations:**
   - `getSessionWorkflow()` (lines ~310-327): Already async, convert sync fs
   - `getSessionWorkflowFromPath()` (lines ~342-355): Already async, convert sync fs
   - `getBranchFromSession()` (lines ~368-390): Already async, convert sync fs
   - `saveSessionWorkflow()` (lines ~398-415): Already async, convert sync fs
   - `getClaudeStatus()` (lines ~430-455): Already async, convert sync fs
   - `getSessionData()` (lines ~485-505): Already async, convert sync fs
   - `saveSessionData()` (lines ~543-560): Already async, convert sync fs
   - `getClaudeStatusFromPath()` (lines ~590-610): Already async, convert sync fs
   - `saveClaudeStatus()` (lines ~631-650): Already async, convert sync fs
   - `getActiveSessions()` (lines ~672-695): Already async, convert sync fs
   - `getLanesSessions()` (lines ~943-960): Already async, convert sync fs

Note: Many functions are already marked async but use sync fs internally. Just replace the fs calls.

5. **TreeDataProvider methods:**
   - `getChildren()` may need to be async (already is)
   - Ensure all await chains are properly handled

DO NOT change function signatures (names/parameters) to maintain backward compatibility.
  </action>
  <verify>
grep -c "\.readFileSync\|\.writeFileSync\|\.existsSync\|\.mkdirSync" src/ClaudeSessionProvider.ts outputs 0
grep -c "await.*fileExists\|await.*readJson\|await.*writeJson\|await.*ensureDir" src/ClaudeSessionProvider.ts outputs > 10
npm run compile passes
  </verify>
  <done>
ClaudeSessionProvider.ts uses only async file I/O via FileService
  </done>
</task>

<task type="auto">
  <name>Migrate PreviousSessionProvider to async file I/O</name>
  <files>src/PreviousSessionProvider.ts</files>
  <action>
Migrate PreviousSessionProvider.ts from sync to async file I/O:

1. **Update imports:**
   - Add: `import { fileExists, readJson, readFile } from './services/FileService';`
   - Remove: `import * as fs from 'fs';` (after migration)

2. **Convert sync fs calls:**
   - Find all `fs.existsSync()` and replace with `await fileExists()`
   - Find all `fs.readFileSync()` and replace with `await readJson()` or `await readFile()`

3. **Make functions async:**
   - Add `async` keyword to functions using FileService
   - Update return types to Promise<T>

4. **TreeDataProvider methods:**
   - `getChildren()` - ensure async if it reads files
   - `getTreeItem()` - may stay sync if it only returns based on cached data

DO NOT change public API signatures.
  </action>
  <verify>
grep -c "\.readFileSync\|\.writeFileSync\|\.existsSync" src/PreviousSessionProvider.ts outputs 0
npm run compile passes
  </verify>
  <done>
PreviousSessionProvider.ts uses only async file I/O via FileService
  </done>
</task>

</tasks>

<verification>
1. ClaudeSessionProvider has no sync fs operations
2. PreviousSessionProvider has no sync fs operations
3. Both modules import and use FileService
4. `npm run compile` passes (TypeScript compilation)
5. `npm run lint` shows no sync fs violations in these files
6. Functions remain backward compatible (same parameter signatures)
</verification>

<success_criteria>
1. ClaudeSessionProvider fully async (no blocking fs calls)
2. PreviousSessionProvider fully async
3. ESLint passes for these files (no sync fs violations)
4. No breaking changes to public API
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-quality/08-03-SUMMARY.md` with:
- Number of sync fs operations replaced
- Functions converted to async
- Any compatibility notes
- Next steps (continue migration to other modules)
</output>
