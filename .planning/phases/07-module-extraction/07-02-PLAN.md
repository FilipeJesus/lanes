---
phase: 07-module-extraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/WorkflowService.ts
  - src/services/SessionProcessService.ts
  - src/types/extension.d.ts
  - src/extension.ts
autonomous: true

must_haves:
  truths:
    - "WorkflowService exports validateWorkflow, createWorkflow, combinePromptAndCriteria, getWorkflowOrchestratorInstructions"
    - "SessionProcessService exports processPendingSession, processClearRequest, checkPendingSessions, checkClearRequests, getPendingSessionsDir"
    - "PendingSessionConfig and ClearSessionConfig interfaces moved to types/extension.d.ts"
    - "extension.ts re-exports all moved functions for backwards compatibility (deprecated)"
    - "All existing tests pass (npm test)"
  artifacts:
    - path: "src/services/WorkflowService.ts"
      provides: "Workflow template validation and creation operations"
      exports: ["validateWorkflow", "createWorkflow", "combinePromptAndCriteria", "getWorkflowOrchestratorInstructions"]
      min_lines: 150
    - path: "src/services/SessionProcessService.ts"
      provides: "MCP pending session request processing"
      exports: ["processPendingSession", "processClearRequest", "checkPendingSessions", "checkClearRequests", "getPendingSessionsDir"]
      min_lines: 100
    - path: "src/types/extension.d.ts"
      provides: "Extension-specific type definitions"
      exports: ["PendingSessionConfig", "ClearSessionConfig"]
      min_lines: 30
  key_links:
    - from: "src/extension.ts"
      to: "src/services/WorkflowService.ts"
      via: "re-export with @deprecated tag"
      pattern: "export.*from.*WorkflowService"
    - from: "src/extension.ts"
      to: "src/services/SessionProcessService.ts"
      via: "re-export with @deprecated tag"
      pattern: "export.*from.*SessionProcessService"
    - from: "src/extension.ts"
      to: "src/types/extension.d.ts"
      via: "type import"
      pattern: "import.*from.*types/extension"
</controls>

---

<objective>
Extract WorkflowService and SessionProcessService from extension.ts, plus move shared types to a dedicated types file. These services are independent of each other and the Wave 1 services, making them suitable for parallel Wave 1 execution.

Purpose: Further reduce extension.ts size by isolating workflow template operations and MCP session processing into focused modules.

Output: Two new service files, one types file, and deprecated re-exports in extension.ts.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-module-extraction/07-RESEARCH.md

# Existing patterns to follow
@src/ProjectManagerService.ts
@src/workflow/index.ts

# Tests that use these functions
@src/test/core/prompt-combination.test.ts
@src/test/session/session-clear.test.ts
@src/test/workflow/mcp-workflow-control.test.ts
</context>

<tasks>

<task type="auto">
  <name>Create types/extension.d.ts and move session interfaces</name>
  <files>
    src/types/extension.d.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/types/extension.d.ts` with:

    1. Copy the following interfaces from extension.ts (lines ~54-68):
       ```typescript
       /**
        * Pending session request from MCP server.
        */
       export interface PendingSessionConfig {
           name: string;
           sourceBranch: string;
           prompt?: string;
           workflow?: string;
           requestedAt: string;
       }

       /**
        * Clear session request from MCP server.
        */
       export interface ClearSessionConfig {
           worktreePath: string;
           requestedAt: string;
       }
       ```

    2. Create the directory if it doesn't exist:
       ```bash
       mkdir -p src/types
       ```

    3. In extension.ts:
       - Delete the copied interfaces
       - Add at top: `import type { PendingSessionConfig, ClearSessionConfig } from './types/extension';`

    Note: Using `.d.ts` for types is consistent with TypeScript best practices for type-only exports.

    DO NOT:
    - Modify interface fields
    - Add new types (only move existing ones)
  </action>
  <verify>
    Run: `npm run compile`
    Verify: No type errors related to PendingSessionConfig or ClearSessionConfig
  </verify>
  <done>
    types/extension.d.ts exists with both interfaces, extension.ts imports them, compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Extract WorkflowService from extension.ts</name>
  <files>
    src/services/WorkflowService.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/services/WorkflowService.ts` with:

    1. Copy the following from extension.ts:
       - `validateWorkflow()` function (~lines 96-128)
       - `createWorkflow()` function (~lines 2798-3003)
       - `combinePromptAndCriteria()` function (~lines 2033-2050)
       - `getWorkflowOrchestratorInstructions()` function (~lines 2051-2090)
       - `WORKFLOWS_DIR` constant (~lines 84)

    2. Add imports at top:
       ```typescript
       import * as vscode from 'vscode';
       import * as path from 'path';
       import * as fsPromises from 'fs/promises';
       import { discoverWorkflows, WorkflowMetadata, loadWorkflowTemplateFromString, WorkflowValidationError } from '../workflow';
       import { getPromptsDir } from '../PreviousSessionProvider';
       ```

    3. Export all functions and the constant

    4. In extension.ts:
       - Delete the copied functions and constant
       - Add import and deprecated re-export (same pattern as 07-01)

    DO NOT:
    - Modify workflow validation logic
    - Change prompt combination behavior
    - Break existing prompt combination tests
  </action>
  <verify>
    Run: `npm test -- src/test/core/prompt-combination.test.ts`
    Verify: All prompt combination tests pass
  </verify>
  <done>
    WorkflowService.ts exists with all exports, extension.ts re-exports for compatibility, tests pass
  </done>
</task>

<task type="auto">
  <name>Extract SessionProcessService from extension.ts</name>
  <files>
    src/services/SessionProcessService.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/services/SessionProcessService.ts` with:

    1. Copy the following from extension.ts:
       - `getPendingSessionsDir()` function (~lines 76-78)
       - `processPendingSession()` function (~lines 562-637)
       - `checkPendingSessions()` function (~lines 638-670)
       - `processClearRequest()` function (~lines 671-717)

    2. Add imports at top:
       ```typescript
       import * as vscode from 'vscode';
       import * as path from 'path';
       import * as fsPromises from 'fs/promises';
       import type { PendingSessionConfig } from '../types/extension';
       import type { ClearSessionConfig } from '../types/extension';
       import { createSession, openClaudeTerminal } from '../extension';
       import { getSessionId } from '../ClaudeSessionProvider';
       ```

    3. Export all functions

    4. Note: `checkClearRequests` is called during activation, keep the registration call in extension.ts

    5. In extension.ts:
       - Delete the copied functions
       - Add import and deprecated re-export (same pattern as 07-01)

    Important: `processPendingSession` and `processClearRequest` call `createSession` and `openClaudeTerminal` from extension.ts. After extraction, import these from extension.ts to avoid circular dependencies. This is a temporary measure - these will be resolved when SessionService is extracted in 07-03.

    DO NOT:
    - Modify MCP request processing logic
    - Change file reading/writing behavior
    - Break session clearing tests
  </action>
  <verify>
    Run: `npm test -- src/test/session/session-clear.test.ts src/test/workflow/mcp-workflow-control.test.ts`
    Verify: All session clearing and MCP workflow tests pass
  </verify>
  <done>
    SessionProcessService.ts exists with all exports, extension.ts re-exports for compatibility, tests pass
  </done>
</task>

</tasks>

<verification>
After completing all tasks, run full test suite:

```bash
npm test
```

Expected results:
- All tests pass (no regressions)
- extension.ts reduced by ~400 more lines
- Two new service files created
- One new types file created
- Linting passes: `npm run lint`
</verification>

<success_criteria>
1. `src/types/extension.d.ts` exists and exports: `PendingSessionConfig`, `ClearSessionConfig`
2. `src/services/WorkflowService.ts` exists and exports: `validateWorkflow`, `createWorkflow`, `combinePromptAndCriteria`, `getWorkflowOrchestratorInstructions`, `WORKFLOWS_DIR`
3. `src/services/SessionProcessService.ts` exists and exports: `processPendingSession`, `processClearRequest`, `checkPendingSessions`, `checkClearRequests`, `getPendingSessionsDir`
4. `extension.ts` imports types from `./types/extension`
5. `extension.ts` re-exports all moved functions with `@deprecated` JSDoc tags
6. All existing tests pass without modification
7. `npm run compile` succeeds
8. `npm run lint` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-module-extraction/07-02-SUMMARY.md`
</output>
