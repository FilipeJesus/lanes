---
phase: 07-module-extraction
plan: 05
type: execute
wave: 4
depends_on: ["07-01", "07-02", "07-03", "07-04"]
files_modified:
  - src/watchers.ts
  - src/extension.ts
autonomous: true

must_haves:
  truths:
    - "extension.ts is a thin entry point (~100 lines) with activate/deactivate only"
    - "watchers.ts exports registerWatchers function"
    - "All deprecated re-exports are removed from extension.ts"
    - "ServiceContainer is created in activate() and passed to modules"
    - "All tests pass (npm test)"
    - "Extension activates without errors"
  artifacts:
    - path: "src/extension.ts"
      provides: "Extension entry point"
      exports: ["activate", "deactivate"]
      max_lines: 150
    - path: "src/watchers.ts"
      provides: "File system watcher registration"
      exports: ["registerWatchers"]
      min_lines: 100
  key_links:
    - from: "src/extension.ts"
      to: "src/watchers.ts"
      via: "registerWatchers call in activate()"
      pattern: "registerWatchers"
    - from: "src/extension.ts"
      to: "src/commands/index.ts"
      via: "registerAllCommands call in activate()"
      pattern: "registerAllCommands"
    - from: "src/extension.ts"
      to: "src/services/"
      via: "no direct imports - services used via commands/watchers"
---

<objective>
Finalize Phase 7 by extracting file watchers and thinning extension.ts to a minimal entry point. Remove all deprecated re-exports and ensure clean module organization.

Purpose: Complete the refactoring so extension.ts is only an entry point (~100 lines) that wires up services, commands, and watchers. This achieves the Phase 7 goal of splitting extension.ts into focused modules.

Output: A thin extension.ts entry point, a watchers module, and clean module organization.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-module-extraction/07-RESEARCH.md
@.planning/phases/07-module-extraction/07-01-SUMMARY.md
@.planning/phases/07-module-extraction/07-02-SUMMARY.md
@.planning/phases/07-module-extraction/07-03-SUMMARY.md
@.planning/phases/07-module-extraction/07-04-SUMMARY.md

# File watcher code in extension.ts
# Lines ~523-670 contain file watcher setup
</context>

<tasks>

<task type="auto">
  <name>Extract file watchers to watchers.ts</name>
  <files>
    src/watchers.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/watchers.ts` with:

    1. Copy file watcher registration code from extension.ts:
       - `getStatusWatchPattern()` function (if not already in SettingsService)
       - `getSessionWatchPattern()` function (if not already in SettingsService)
       - All file watcher creation code from activate()
       - The `checkPendingSessions()` and `checkClearRequests()` polling setup

    2. Structure as:
       ```typescript
       import * as vscode from 'vscode';
       import type { ServiceContainer } from './types/serviceContainer';
       import { checkPendingSessions, checkClearRequests, getPendingSessionsDir } from './services/SessionProcessService';
       import { getStatusWatchPattern, getSessionWatchPattern } from './services/SettingsService';
       import { getSessionId } from './ClaudeSessionProvider';

       export function registerWatchers(
           context: vscode.ExtensionContext,
           services: ServiceContainer
       ): void {
           // File system watchers
           const statusWatcher = vscode.workspace.createFileSystemWatcher(
               getStatusWatchPattern(services.baseRepoPath),
               false,
               false,
               false
           );
           // ... rest of watcher setup

           // Polling for MCP requests
           const checkInterval = setInterval(() => {
               checkPendingSessions(services.baseRepoPath, services);
               checkClearRequests(services.baseRepoPath);
           }, 2000);

           context.subscriptions.push(
               statusWatcher,
               sessionWatcher,
               // ... other watchers
               { dispose: () => clearInterval(checkInterval) }
           );
       }
       ```

    3. In extension.ts:
       - Remove the copied watcher code
       - Add: `import { registerWatchers } from './watchers';`
       - Add in activate(): `registerWatchers(context, services);`

    DO NOT:
    - Modify watcher behavior or timing
    - Change file patterns
    - Break MCP request polling
  </action>
  <verify>
    Run: `npm test -- --grep "pending"`
    Verify: Pending session tests pass
  </verify>
  <done>
    watchers.ts exists with registerWatchers function, extension.ts updated
  </done>
</task>

<task type="auto">
  <name>Thin extension.ts to minimal entry point</name>
  <files>
    src/extension.ts
  </files>
  <action>
    Refactor extension.ts to be a thin entry point:

    1. Keep only essential code in activate():
       ```typescript
       import * as vscode from 'vscode';
       import { ClaudeSessionProvider } from './ClaudeSessionProvider';
       import { SessionFormProvider } from './SessionFormProvider';
       import { PreviousSessionProvider } from './PreviousSessionProvider';
       import { WorkflowsProvider } from './WorkflowsProvider';
       import { GitChangesPanel } from './GitChangesPanel';
       import { initialize as initializeGitPath } from './gitService';
       import { initialize as initializeProjectManagerService } from './ProjectManagerService';
       import type { ServiceContainer } from './types/serviceContainer';
       import { registerAllCommands } from './commands';
       import { registerWatchers } from './watchers';
       import { checkAndRepairBrokenWorktrees } from './services/BrokenWorktreeService';
       import { getBaseRepoPath } from './services/SettingsService';
       import { getErrorMessage } from './utils';

       const TERMINAL_CLOSE_DELAY_MS = 200;

       export async function activate(context: vscode.ExtensionContext): Promise<void> {
           // Initialize git path
           await initializeGitPath();

           // Initialize Project Manager service
           initializeProjectManagerService(context);

           // Get workspace paths
           const workspaceRoot = vscode.workspace.workspaceFolders?.[0].uri.fsPath;
           const baseRepoPath = workspaceRoot ? await getBaseRepoPath(workspaceRoot) : undefined;

           // Initialize global storage for session provider
           initializeGlobalStorageContext(context);

           // Create service container
           const services: ServiceContainer = {
               output: vscode.window.createOutputChannel('Lanes'),
               extensionContext: context,
               sessionProvider: new ClaudeSessionProvider(workspaceRoot, baseRepoPath),
               sessionFormProvider: new SessionFormProvider(context.extensionUri),
               previousSessionProvider: new PreviousSessionProvider(),
               workflowsProvider: new WorkflowsProvider(),
               gitChangesPanel: new GitChangesPanel(),
               workspaceRoot,
               baseRepoPath,
               extensionPath: context.extensionPath
           };

           // Register tree view providers
           context.subscriptions.push(
               vscode.window.createTreeView('claudeSessionsView', {
                   treeDataProvider: services.sessionProvider,
                   showCollapseAll: true
               }),
               services.sessionFormProvider,
               services.previousSessionProvider,
               services.workflowsProvider,
               services.gitChangesPanel
           );

           // Register commands
           registerAllCommands(context, services);

           // Register file watchers
           registerWatchers(context, services);

           // Check for broken worktrees on activation
           if (baseRepoPath) {
               await checkAndRepairBrokenWorktrees(baseRepoPath);
           }
       }

       export function deactivate(): void {
           // Cleanup handled by disposables registered to context
       }
       ```

    2. Remove all deprecated re-exports added in previous plans

    3. Ensure all imports are from the correct modules (not from `./extension`)

    4. The file should be ~100 lines when complete

    DO NOT:
    - Change activation behavior
    - Remove any initialization steps
    - Break extension loading
  </action>
  <verify>
    Run: `npm run compile`
    Verify: extension.ts compiles with no errors
    Run: `wc -l src/extension.ts`
    Verify: extension.ts is ~150 lines or less
  </verify>
  <done>
    extension.ts is thin entry point, deprecated re-exports removed, activation works
  </done>
</task>

<task type="auto">
  <name>Update test imports to use new modules</name>
  <files>
    src/test/**/*.test.ts
  </files>
  <action>
    Update test files that import from extension.ts to use the new service modules:

    1. Find all imports from extension.ts:
       ```bash
       grep -r "from.*extension'" src/test/
       ```

    2. Update each import:
       - `createSession` → import from `./services/SessionService`
       - `openClaudeTerminal` → import from `./services/TerminalService`
       - `getBaseRepoPath` → import from `./services/SettingsService`
       - `generateDiffContent` → import from `./services/DiffService`
       - etc.

    3. Run tests to verify each change

    DO NOT:
    - Modify test logic, only imports
    - Skip any test file imports
    - Leave any extension.ts imports that are still needed

    Note: Some test files may legitimately import from extension.ts for the `activate` function or other exports. Only update imports for functions that were moved to services.
  </action>
  <verify>
    Run: `npm test`
    Verify: All tests pass after import updates
  </verify>
  <done>
    All test imports updated to use new service modules
  </done>
</task>

</tasks>

<verification>
After completing all tasks, run full test suite:

```bash
npm test
npm run compile
npm run lint
```

Expected results:
- All tests pass (no regressions)
- extension.ts is ~100-150 lines
- All deprecated re-exports removed
- Clean module organization achieved
- No linting errors

Manual verification:
1. Run `Developer: Reload Window` in VS Code
2. Verify extension activates
3. Test core functionality:
   - Create a session
   - Open a session
   - View git changes
   - Delete a session
</verification>

<success_criteria>
1. `src/extension.ts` is ≤150 lines
2. `src/extension.ts` exports only `activate` and `deactivate`
3. `src/watchers.ts` exists and exports `registerWatchers`
4. No deprecated re-exports remain in extension.ts
5. All test files import from appropriate service modules (not extension.ts for moved functions)
6. All existing tests pass
7. Extension activates without errors
8. Core functionality works (create, open, delete sessions)
9. `npm run compile` succeeds
10. `npm run lint` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-module-extraction/07-05-SUMMARY.md`

Also create `.planning/phases/07-module-extraction/07-SUMMARY.md` with phase completion summary.
</output>
