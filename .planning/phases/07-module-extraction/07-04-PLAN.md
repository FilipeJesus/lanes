---
phase: 07-module-extraction
plan: 04
type: execute
wave: 3
depends_on: ["07-01", "07-02", "07-03"]
files_modified:
  - src/commands/index.ts
  - src/commands/sessionCommands.ts
  - src/commands/workflowCommands.ts
  - src/commands/repairCommands.ts
  - src/types/serviceContainer.d.ts
  - src/extension.ts
autonomous: true

must_haves:
  truths:
    - "commands/index.ts exports registerAllCommands function"
    - "commands/sessionCommands.ts exports registerSessionCommands function"
    - "commands/workflowCommands.ts exports registerWorkflowCommands function"
    - "commands/repairCommands.ts exports registerRepairCommands function"
    - "ServiceContainer interface defines all service dependencies"
    - "extension.ts calls registerAllCommands in activate()"
    - "All commands still work (verified by npm test)"
  artifacts:
    - path: "src/commands/index.ts"
      provides: "Centralized command registration"
      exports: ["registerAllCommands"]
      min_lines: 50
    - path: "src/commands/sessionCommands.ts"
      provides: "Session-related command registration"
      exports: ["registerSessionCommands"]
      min_lines: 150
    - path: "src/commands/workflowCommands.ts"
      provides: "Workflow-related command registration"
      exports: ["registerWorkflowCommands"]
      min_lines: 100
    - path: "src/commands/repairCommands.ts"
      provides: "Worktree repair command registration"
      exports: ["registerRepairCommands"]
      min_lines: 50
    - path: "src/types/serviceContainer.d.ts"
      provides: "Service dependency injection container"
      exports: ["ServiceContainer"]
      min_lines: 30
  key_links:
    - from: "src/extension.ts"
      to: "src/commands/index.ts"
      via: "registerAllCommands call in activate()"
      pattern: "registerAllCommands"
    - from: "src/commands/index.ts"
      to: "src/commands/sessionCommands.ts"
      via: "import and delegation"
      pattern: "registerSessionCommands"
    - from: "src/commands/*.ts"
      to: "src/services/*.ts"
      via: "ServiceContainer parameter"
      pattern: "services\\."
---

<objective>
Extract command registration from extension.ts into organized command modules. Create a ServiceContainer for dependency injection and register commands by functional domain (session, workflow, repair).

Purpose: Reduce extension.ts activation function from ~1000 lines to ~100 lines by extracting command handlers. Use dependency injection pattern for testability.

Output: Four command modules with clear separation of concerns and a ServiceContainer interface.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-module-extraction/07-RESEARCH.md
@.planning/phases/07-module-extraction/07-01-SUMMARY.md
@.planning/phases/07-module-extraction/07-02-SUMMARY.md
@.planning/phases/07-module-extraction/07-03-SUMMARY.md

# Command patterns in extension.ts
# Lines ~718-1760 contain activate() with ~500 lines of command registration
</context>

<tasks>

<task type="auto">
  <name>Create ServiceContainer interface</name>
  <files>
    src/types/serviceContainer.d.ts
  </files>
  <action>
    Create `src/types/serviceContainer.d.ts` with:

    1. Define the ServiceContainer interface with all service dependencies:
       ```typescript
       import * as vscode from 'vscode';
       import type { ClaudeSessionProvider } from '../ClaudeSessionProvider';
       import type { SessionFormProvider } from '../SessionFormProvider';
       import type { PreviousSessionProvider } from '../PreviousSessionProvider';
       import type { WorkflowsProvider } from '../WorkflowsProvider';
       import type { GitChangesPanel } from '../GitChangesPanel';

       // Service types (use typeof for services with classes)
       export interface ServiceContainer {
           // VS Code API
           output: vscode.OutputChannel;
           extensionContext: vscode.ExtensionContext;

           // Providers
           sessionProvider: ClaudeSessionProvider;
           sessionFormProvider: SessionFormProvider;
           previousSessionProvider: PreviousSessionProvider;
           workflowsProvider: WorkflowsProvider;
           gitChangesPanel: GitChangesPanel;

           // Paths
           workspaceRoot: string | undefined;
           baseRepoPath: string | undefined;
           extensionPath: string;
       }

       export type ServiceContainerOptions = Omit<ServiceContainer, 'output'>;
       ```

    2. Create the types directory if it doesn't exist (already created in 07-02)

    3. This interface will be passed to command registration functions

    DO NOT:
    - Include services not yet created
    - Add methods to the interface (it's just for dependency injection)
  </action>
  <verify>
    Run: `npm run compile`
    Verify: ServiceContainer type compiles without errors
  </verify>
  <done>
    serviceContainer.d.ts exists with ServiceContainer interface
  </done>
</task>

<task type="auto">
  <name>Extract session commands to sessionCommands.ts</name>
  <files>
    src/commands/sessionCommands.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/commands/sessionCommands.ts` with:

    1. Create the commands directory:
       ```bash
       mkdir -p src/commands
       ```

    2. Copy session-related command registrations from extension.ts activate() function:
       - `lanes.createSession` command handler
       - `lanes.deleteSession` command handler
       - `lanes.openSession` command handler
       - `lanes.openInNewWindow` command handler
       - `lanes.setChimeEnabled` command handler
       - Any other session-related commands

    3. Structure as:
       ```typescript
       import * as vscode from 'vscode';
       import type { ServiceContainer } from '../types/serviceContainer';
       import { createSession } from '../services/SessionService';
       import { openClaudeTerminal } from '../services/TerminalService';
       // ... other imports

       export function registerSessionCommands(
           context: vscode.ExtensionContext,
           services: ServiceContainer
       ): void {
           const disposables = [
               vscode.commands.registerCommand('lanes.createSession', async () => {
                   // command handler logic
               }),
               // ... more commands
           ];

           disposables.forEach(d => context.subscriptions.push(d));
       }
       ```

    4. Extract inline handler functions to the module level (outside the registration function) for better testability

    5. In extension.ts:
       - Remove the copied command registrations from activate()
       - Add: `import { registerSessionCommands } from './commands/sessionCommands';`
       - Add in activate(): `registerSessionCommands(context, services);`

    DO NOT:
    - Modify command handler logic
    - Change command IDs (must match package.json)
    - Break existing session functionality
  </action>
  <verify>
    Run: `npm test -- --grep "session"`
    Verify: Session-related tests pass
  </verify>
  <done>
    sessionCommands.ts exists with registerSessionCommands function, extension.ts updated
  </done>
</task>

<task type="auto">
  <name>Extract workflow and repair commands</name>
  <files>
    src/commands/workflowCommands.ts,
    src/commands/repairCommands.ts,
    src/commands/index.ts,
    src/extension.ts
  </files>
  <action>
    Create workflow and repair command modules:

    **Part A: workflowCommands.ts**
    1. Copy workflow-related command registrations:
       - `lanes.createWorkflow` command handler
       - `lanes.validateWorkflow` command handler
       - Any other workflow-related commands

    2. Structure as:
       ```typescript
       import * as vscode from 'vscode';
       import type { ServiceContainer } from '../types/serviceContainer';
       import { createWorkflow } from '../services/WorkflowService';
       // ... other imports

       export function registerWorkflowCommands(
           context: vscode.ExtensionContext,
           services: ServiceContainer
       ): void {
               // workflow command registrations
       }
       ```

    **Part B: repairCommands.ts**
    1. Copy worktree repair command registrations:
       - `lanes.repairWorktree` command handler
       - `lanes.checkBrokenWorktrees` command handler
       - Any other repair-related commands

    2. Structure similarly with:
       ```typescript
       export function registerRepairCommands(...)
       ```

    **Part C: commands/index.ts**
    1. Create the registry:
       ```typescript
       import * as vscode from 'vscode';
       import type { ServiceContainer } from '../types/serviceContainer';
       import { registerSessionCommands } from './sessionCommands';
       import { registerWorkflowCommands } from './workflowCommands';
       import { registerRepairCommands } from './repairCommands';

       export function registerAllCommands(
           context: vscode.ExtensionContext,
           services: ServiceContainer
       ): void {
           registerSessionCommands(context, services);
           registerWorkflowCommands(context, services);
           registerRepairCommands(context, services);
       }
       ```

    **Part D: Update extension.ts**
    1. Remove copied command registrations from activate()
    2. Add: `import { registerAllCommands } from './commands';`
    3. Replace command registrations in activate() with: `registerAllCommands(context, services);`

    DO NOT:
    - Modify command handler logic
    - Change command IDs
    - Break existing workflow or repair functionality
  </action>
  <verify>
    Run: `npm test`
    Verify: All tests pass (commands still work)
  </verify>
  <done>
    workflowCommands.ts, repairCommands.ts, and commands/index.ts exist, extension.ts updated with registerAllCommands
  </done>
</task>

</tasks>

<verification>
After completing all tasks, run full test suite:

```bash
npm test
```

Expected results:
- All tests pass (no regressions)
- extension.ts activation function reduced by ~500 lines
- Four command modules created
- All commands still registered and functional
- Linting passes: `npm run lint`

Manual verification:
1. Reload VS Code window
2. Run `Developer: Reload Window` command
3. Verify extension activates without errors
4. Test a few commands from Command Palette
</verification>

<success_criteria>
1. `src/commands/index.ts` exists and exports: `registerAllCommands`
2. `src/commands/sessionCommands.ts` exists and exports: `registerSessionCommands`
3. `src/commands/workflowCommands.ts` exists and exports: `registerWorkflowCommands`
4. `src/commands/repairCommands.ts` exists and exports: `registerRepairCommands`
5. `src/types/serviceContainer.d.ts` exists and exports: `ServiceContainer`
6. `extension.ts` calls `registerAllCommands(context, services)` in activate()
7. All existing tests pass without modification
8. `npm run compile` succeeds
9. `npm run lint` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-module-extraction/07-04-SUMMARY.md`
</output>
