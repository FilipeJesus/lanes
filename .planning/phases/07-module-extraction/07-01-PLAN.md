---
phase: 07-module-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/BrokenWorktreeService.ts
  - src/services/SettingsService.ts
  - src/services/DiffService.ts
  - src/extension.ts
autonomous: true

must_haves:
  truths:
    - "BrokenWorktreeService exports detectBrokenWorktrees, repairWorktree, checkAndRepairBrokenWorktrees"
    - "SettingsService exports getBaseRepoPath, getRepoName, getOrCreateExtensionSettingsFile"
    - "DiffService exports generateDiffContent, parseUntrackedFiles, isBinaryContent, synthesizeUntrackedFileDiff, getBaseBranch"
    - "extension.ts re-exports all moved functions for backwards compatibility (deprecated)"
    - "All existing tests pass (npm test)"
    - "Each service has JSDoc documentation"
  artifacts:
    - path: "src/services/BrokenWorktreeService.ts"
      provides: "Broken worktree detection and repair operations"
      exports: ["detectBrokenWorktrees", "repairWorktree", "checkAndRepairBrokenWorktrees", "BrokenWorktree"]
      min_lines: 200
    - path: "src/services/SettingsService.ts"
      provides: "Extension settings and repo path utilities"
      exports: ["getBaseRepoPath", "getRepoName", "getOrCreateExtensionSettingsFile"]
      min_lines: 150
    - path: "src/services/DiffService.ts"
      provides: "Git diff content generation and parsing"
      exports: ["generateDiffContent", "parseUntrackedFiles", "isBinaryContent", "synthesizeUntrackedFileDiff", "getBaseBranch"]
      min_lines: 150
  key_links:
    - from: "src/extension.ts"
      to: "src/services/BrokenWorktreeService.ts"
      via: "re-export with @deprecated tag"
      pattern: "export.*from.*BrokenWorktreeService"
    - from: "src/extension.ts"
      to: "src/services/SettingsService.ts"
      via: "re-export with @deprecated tag"
      pattern: "export.*from.*SettingsService"
    - from: "src/extension.ts"
      to: "src/services/DiffService.ts"
      via: "re-export with @deprecated tag"
      pattern: "export.*from.*DiffService"
    - from: "src/test/brokenWorktree.test.ts"
      to: "src/extension.ts"
      via: "existing imports still work (re-exported)"
      pattern: "from.*extension"
---

<objective>
Extract three foundational services from extension.ts: BrokenWorktreeService, SettingsService, and DiffService. These services have no interdependencies, making them ideal for Wave 1 parallel extraction.

Purpose: Reduce extension.ts from ~3000 lines to ~2000 lines by isolating focused, testable modules. Each service will have a single responsibility and clear public interface.

Output: Three new service files in `src/services/` with deprecated re-exports in extension.ts for backwards compatibility.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-module-extraction/07-RESEARCH.md

# Existing patterns to follow
@src/ProjectManagerService.ts  # Example of well-structured service module
@src/gitService.ts              # Example of focused service interface
@src/workflow/index.ts          # Example of module with exports

# Tests that use these functions
@src/test/brokenWorktree.test.ts
@src/test/core/generate-diff.test.ts
@src/test/git/diff-parsing.test.ts
@src/test/git/diff-base-branch.test.ts
@src/test/core/extension-settings-location.test.ts
</context>

<tasks>

<task type="auto">
  <name>Extract BrokenWorktreeService from extension.ts</name>
  <files>
    src/services/BrokenWorktreeService.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/services/BrokenWorktreeService.ts` with:

    1. Copy the following from extension.ts (lines ~134-447):
       - `BrokenWorktree` interface
       - `detectBrokenWorktrees()` function
       - `repairWorktree()` function
       - `copyDirectoryContents()` function (private helper)
       - `copyDirectory()` function (private helper)
       - `checkAndRepairBrokenWorktrees()` function
       - `branchExists()` helper (needed by repairWorktree - around line 2351)

    2. Add imports at top:
       ```typescript
       import * as vscode from 'vscode';
       import * as path from 'path';
       import * as fs from 'fs';
       import * as fsPromises from 'fs/promises';
       import { execGit } from '../gitService';
       import { getErrorMessage } from '../utils';
       import { getWorktreesFolder } from '../ClaudeSessionProvider';
       ```

    3. Export all functions and the interface

    4. In extension.ts:
       - Delete the copied functions
       - Add at top: `import * as BrokenWorktreeService from './services/BrokenWorktreeService';`
       - Add deprecated re-exports at bottom:
         ```typescript
         /**
          * @deprecated Import from './services/BrokenWorktreeService' instead
          */
         export { BrokenWorktreeService };
         ```
       - Keep internal usage via the imported module

    5. Follow ProjectManagerService.ts pattern:
       - Use JSDoc for all public exports
       - Keep helper functions private (not exported)
       - No module-level state (pure functions)

    DO NOT:
    - Modify function signatures or behavior
    - Change error handling logic
    - Break existing tests
  </action>
  <verify>
    Run: `npm test -- src/test/brokenWorktree.test.ts`
    Verify: All broken worktree tests pass
  </verify>
  <done>
    BrokenWorktreeService.ts exists with all exports, extension.ts re-exports for compatibility, tests pass
  </done>
</task>

<task type="auto">
  <name>Extract SettingsService from extension.ts</name>
  <files>
    src/services/SettingsService.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/services/SettingsService.ts` with:

    1. Copy the following from extension.ts:
       - `getBaseRepoPath()` function (~lines 464-521)
       - `getStatusWatchPattern()` function (~lines 523-537)
       - `getSessionWatchPattern()` function (~lines 539-552)
       - `getRepoName()` function (~lines 554-560)
       - `getOrCreateExtensionSettingsFile()` function (~lines 2439-2618)

    2. Add imports at top:
       ```typescript
       import * as vscode from 'vscode';
       import * as path from 'path';
       import * as fsPromises from 'fs/promises';
       import { execGit } from '../gitService';
       import { ClaudeCodeAgent, CodeAgent } from '../codeAgents';
       import { getSessionId, getPromptsPath, getBaseRepoPathForStorage } from '../ClaudeSessionProvider';
       ```

    3. Export all functions

    4. In extension.ts:
       - Delete the copied functions
       - Add import and deprecated re-export (same pattern as Task 1)

    DO NOT:
    - Modify the PROPAGATE_HOOKS constant or hook script logic
    - Change file writing behavior
    - Break existing settings tests
  </action>
  <verify>
    Run: `npm test -- src/test/core/extension-settings-location.test.ts src/test/core/extension-settings-hooks.test.ts`
    Verify: All settings-related tests pass
  </verify>
  <done>
    SettingsService.ts exists with all exports, extension.ts re-exports for compatibility, tests pass
  </done>
</task>

<task type="auto">
  <name>Extract DiffService from extension.ts</name>
  <files>
    src/services/DiffService.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/services/DiffService.ts` with:

    1. Copy the following from extension.ts:
       - `parseUntrackedFiles()` function (~lines 2620-2650)
       - `isBinaryContent()` function (~lines 2651-2660)
       - `synthesizeUntrackedFileDiff()` function (~lines 2662-2707)
       - `getBaseBranch()` function (~lines 2709-2796)
       - `generateDiffContent()` function (~lines 1760-end of createSession, the diff generation part)

    2. Add imports at top:
       ```typescript
       import * as path from 'path';
       import { execGit } from '../gitService';
       import { getErrorMessage } from '../utils';
       ```

    3. Export all functions

    4. In extension.ts:
       - Delete the copied functions
       - Add import and deprecated re-export (same pattern as Task 1)

    Note: The `generateDiffContent` function is used within `createSession`. After extraction, import it in extension.ts for internal use.

    DO NOT:
    - Modify diff generation logic
    - Change binary content detection
    - Break existing diff tests
  </action>
  <verify>
    Run: `npm test -- src/test/core/generate-diff.test.ts src/test/git/diff-parsing.test.ts src/test/git/diff-base-branch.test.ts`
    Verify: All diff-related tests pass
  </verify>
  <done>
    DiffService.ts exists with all exports, extension.ts re-exports for compatibility, tests pass
  </done>
</task>

</tasks>

<verification>
After completing all tasks, run full test suite:

```bash
npm test
```

Expected results:
- All tests pass (no regressions)
- extension.ts reduced by ~850 lines
- Three new service files created
- Linting passes: `npm run lint`

Check that extension.ts still compiles:
```bash
npm run compile
```
</verification>

<success_criteria>
1. `src/services/BrokenWorktreeService.ts` exists and exports: `detectBrokenWorktrees`, `repairWorktree`, `checkAndRepairBrokenWorktrees`, `BrokenWorktree`
2. `src/services/SettingsService.ts` exists and exports: `getBaseRepoPath`, `getRepoName`, `getOrCreateExtensionSettingsFile`, `getStatusWatchPattern`, `getSessionWatchPattern`
3. `src/services/DiffService.ts` exists and exports: `generateDiffContent`, `parseUntrackedFiles`, `isBinaryContent`, `synthesizeUntrackedFileDiff`, `getBaseBranch`
4. `extension.ts` re-exports all moved functions with `@deprecated` JSDoc tags
5. All existing tests pass without modification
6. `npm run compile` succeeds
7. `npm run lint` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-module-extraction/07-01-SUMMARY.md`
</output>
