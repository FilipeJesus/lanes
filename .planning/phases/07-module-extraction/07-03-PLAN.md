---
phase: 07-module-extraction
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/services/SessionService.ts
  - src/services/TerminalService.ts
  - src/extension.ts
autonomous: true

must_haves:
  truths:
    - "SessionService exports createSession, branchExists, getBranchesInWorktrees, ensureWorktreeDirExists"
    - "TerminalService exports openClaudeTerminal, countTerminalsForSession, createTerminalForSession"
    - "SessionService uses gitService, validation, and extracted services (not extension.ts)"
    - "TerminalService uses SessionService and codeAgents (not extension.ts)"
    - "extension.ts re-exports all moved functions for backwards compatibility (deprecated)"
    - "All existing tests pass (npm test)"
  artifacts:
    - path: "src/services/SessionService.ts"
      provides: "Session creation, deletion, and worktree management operations"
      exports: ["createSession", "branchExists", "getBranchesInWorktrees", "ensureWorktreeDirExists"]
      min_lines: 200
    - path: "src/services/TerminalService.ts"
      provides: "Terminal creation and management for Claude sessions"
      exports: ["openClaudeTerminal", "countTerminalsForSession", "createTerminalForSession"]
      min_lines: 150
  key_links:
    - from: "src/services/SessionService.ts"
      to: "src/gitService.ts"
      via: "direct import"
      pattern: "from.*gitService"
    - from: "src/services/SessionService.ts"
      to: "src/validation"
      via: "direct import"
      pattern: "from.*validation"
    - from: "src/services/TerminalService.ts"
      to: "src/services/SessionService.ts"
      via: "import for session-related operations"
      pattern: "from.*SessionService"
    - from: "src/services/SessionProcessService.ts"
      to: "src/services/SessionService.ts"
      via: "will import in 07-03 (resolves circular dependency from 07-02)"
      pattern: "from.*SessionService"
---

<objective>
Extract SessionService and TerminalService from extension.ts. These services depend on Wave 1 services (gitService, validation, SettingsService) so they must execute after Wave 1 completes.

Purpose: Extract the core session creation and terminal management logic into focused services. This resolves circular dependencies introduced in 07-02 where SessionProcessService had to import from extension.ts.

Output: Two new service files with session and terminal operations isolated.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-module-extraction/07-RESEARCH.md
@.planning/phases/07-module-extraction/07-01-SUMMARY.md
@.planning/phases/07-module-extraction/07-02-SUMMARY.md

# Existing patterns to follow
@src/ProjectManagerService.ts
@src/gitService.ts

# Tests that use these functions
@src/test/edgeCases.test.ts
@src/test/core/extension-settings-workflow.test.ts
</context>

<tasks>

<task type="auto">
  <name>Extract SessionService from extension.ts</name>
  <files>
    src/services/SessionService.ts,
    src/extension.ts
  </files>
  <action>
    Create `src/services/SessionService.ts` with:

    1. Copy the following from extension.ts:
       - `createSession()` function (~lines 1760-2032)
       - `branchExists()` function (~lines 2351-2370)
       - `getBranchesInWorktrees()` function (~lines 2371-2392)
       - `ensureWorktreeDirExists()` function (~lines 2393-2438)

    2. Add imports at top:
       ```typescript
       import * as vscode from 'vscode';
       import * as path from 'path';
       import * as fsPromises from 'fs/promises';
       import { execGit } from '../gitService';
       import { ClaudeSessionProvider, getSessionId, getSessionChimeEnabled, setSessionChimeEnabled, getBaseRepoPathForStorage, getSessionNameFromWorktree, getWorktreesFolder, getPromptsPath, saveSessionWorkflow, getClaudeStatusPath, getClaudeSessionPath, getWorkflowStatus, getOrCreateTaskListId } from '../ClaudeSessionProvider';
       import { PermissionMode, isValidPermissionMode } from '../SessionFormProvider';
       import { getBaseRepoPath, getOrCreateExtensionSettingsFile } from './SettingsService';
       import { generateDiffContent } from './DiffService';
       import { validateBranchName } from '../validation';
       import { sanitizeSessionName, getErrorMessage } from '../utils';
       import { validateSessionName } from '../validation';
       import { AsyncQueue } from '../AsyncQueue';
       import { LanesError, GitError, ValidationError } from '../errors';
       import { ClaudeCodeAgent, CodeAgent } from '../codeAgents';
       import { propagateLocalSettings, LocalSettingsPropagationMode } from '../localSettings';
       import { discoverWorkflows, WorkflowMetadata, loadWorkflowTemplateFromString, WorkflowValidationError } from '../workflow';
       import { addProject } from '../ProjectManagerService';
       ```

    3. The `sessionCreationQueue` module-level variable (line ~46) should be encapsulated in the service. Export a function to get/create it:
       ```typescript
       let sessionCreationQueue: AsyncQueue | undefined;

       export function getSessionCreationQueue(): AsyncQueue {
           if (!sessionCreationQueue) {
               sessionCreationQueue = new AsyncQueue();
           }
           return sessionCreationQueue;
       }
       ```

    4. The `warnedMergeBaseBranches` Set (line ~49) should also be encapsulated:
       ```typescript
       const warnedMergeBaseBranches = new Set<string>();
       ```

    5. Export all functions

    6. In extension.ts:
       - Delete the copied functions and module-level variables
       - Add import and deprecated re-export
       - Keep using `sessionCreationQueue` via the service import

    DO NOT:
    - Modify session creation logic
    - Change async queue behavior
    - Break existing session tests
  </action>
  <verify>
    Run: `npm test -- src/test/edgeCases.test.ts src/test/core/extension-settings-workflow.test.ts`
    Verify: Session-related tests pass
  </verify>
  <done>
    SessionService.ts exists with all exports, sessionCreationQueue encapsulated, extension.ts updated, tests pass
  </done>
</task>

<task type="auto">
  <name>Update SessionProcessService to use SessionService</name>
  <files>
    src/services/SessionProcessService.ts
  </files>
  <action>
    Update `src/services/SessionProcessService.ts` to resolve circular dependency:

    1. Change imports at top:
       - Remove: `import { createSession, openClaudeTerminal } from '../extension';`
       - Add: `import { createSession } from './SessionService';`

    2. The `processPendingSession` function uses `createSession` - this now imports from SessionService instead of extension.ts

    3. Note: `openClaudeTerminal` is still in extension.ts at this point (will be extracted in Task 3). Keep that import for now.

    This resolves the circular dependency noted in 07-02 where SessionProcessService had to import from extension.ts.

    DO NOT:
    - Modify MCP request processing logic
    - Change behavior of `processPendingSession`
  </action>
  <verify>
    Run: `npm test -- src/test/session/session-clear.test.ts`
    Verify: Session clearing tests still pass after import change
  </verify>
  <done>
    SessionProcessService imports createSession from SessionService, no circular dependency
  </done>
</task>

<task type="auto">
  <name>Extract TerminalService from extension.ts</name>
  <files>
    src/services/TerminalService.ts,
    src/extension.ts,
    src/services/SessionProcessService.ts
  </files>
  <action>
    Create `src/services/TerminalService.ts` with:

    1. Copy the following from extension.ts:
       - `countTerminalsForSession()` function (~lines 2091-2111)
       - `createTerminalForSession()` function (~lines 2112-2147)
       - `openClaudeTerminal()` function (~lines 2148-2350)

    2. Add imports at top:
       ```typescript
       import * as vscode from 'vscode';
       import * as path from 'path';
       import { SessionItem, getSessionId } from '../ClaudeSessionProvider';
       import { SessionFormProvider, PermissionMode } from '../SessionFormProvider';
       import { ClaudeCodeAgent, CodeAgent } from '../codeAgents';
       import { getOrCreateExtensionSettingsFile } from './SettingsService';
       import { createSession } from './SessionService';
       ```

    3. Export all functions

    4. In extension.ts:
       - Delete the copied functions
       - Add import and deprecated re-export

    5. Update SessionProcessService.ts:
       - Change `openClaudeTerminal` import from `../extension` to `./TerminalService`

    6. The `TERMINAL_CLOSE_DELAY_MS` constant (~line 43) should be moved to TerminalService

    DO NOT:
    - Modify terminal creation logic
    - Change chime sound behavior
    - Break terminal-related functionality
  </action>
  <verify>
    Run: `npm test -- src/test/core/chime-configuration.test.ts`
    Verify: Chime configuration tests pass (terminal creation tests)
  </verify>
  <done>
    TerminalService.ts exists with all exports, SessionProcessService updated, tests pass
  </done>
</task>

</tasks>

<verification>
After completing all tasks, run full test suite:

```bash
npm test
```

Expected results:
- All tests pass (no regressions)
- extension.ts reduced by ~500 more lines
- Two new service files created
- SessionProcessService no longer has circular dependency on extension.ts
- Linting passes: `npm run lint`
</verification>

<success_criteria>
1. `src/services/SessionService.ts` exists and exports: `createSession`, `branchExists`, `getBranchesInWorktrees`, `ensureWorktreeDirExists`, `getSessionCreationQueue`
2. `src/services/TerminalService.ts` exists and exports: `openClaudeTerminal`, `countTerminalsForSession`, `createTerminalForSession`
3. `src/services/SessionProcessService.ts` imports from SessionService and TerminalService (not extension.ts)
4. `extension.ts` re-exports all moved functions with `@deprecated` JSDoc tags
5. All existing tests pass without modification
6. `npm run compile` succeeds
7. `npm run lint` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-module-extraction/07-03-SUMMARY.md`
</output>
