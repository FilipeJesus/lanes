---
phase: 05-test-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 05-02
files_modified:
  - src/test/extension.test.ts
  - src/test/session.test.ts
  - src/test/workflow.test.ts
  - src/test/configuration.test.ts
  - src/test/gitChanges.test.ts
  - src/test/sessionForm.test.ts
  - src/test/session-clear.test.ts
  - src/test/workflow-resume.test.ts
  - src/test/code-agent.test.ts
  - src/test/mcp.test.ts
  - src/test/branchValidation.test.ts
  - src/test/mergeBaseHandling.test.ts
autonomous: true

must_haves:
  truths:
    - "Large test files (500+ lines) are split into focused modules"
    - "Tests are organized by functionality in subdirectories"
    - "Each test file has a single, clear responsibility"
    - "All tests continue to pass after reorganization"
  artifacts:
    - path: "src/test/core/"
      provides: "Split core extension tests"
      min_files: 2
    - path: "src/test/session/"
      provides: "Split session-related tests"
      min_files: 3
    - path: "src/test/workflow/"
      provides: "Split workflow tests"
      min_files: 3
    - path: "src/test/config/"
      provides: "Split configuration tests"
      min_files: 2
    - path: "src/test/git/"
      provides: "Split git-related tests"
      min_files: 2
  key_links:
    - from: "new test files"
      to: "testSetup.ts"
      via: "Import shared mock utilities"
      pattern: "import.*testSetup"
    - from: "split test files"
      to: "source modules"
      via: "Maintained import paths"
      pattern: "import.*from.*src/"
---

<objective>
Split large test files into focused modules organized by functionality.

Purpose: Improve test maintainability by organizing tests into logical subdirectories with clear responsibilities. Large files (500+ lines) are difficult to navigate and maintain.

Output: Organized test suite with files under 500 lines, grouped by functionality.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-test-foundation/05-RESEARCH.md
@.planning/phases/05-test-foundation/05-02-SUMMARY.md

# Phase Context
Plans 05-01 and 05-02 installed mocking infrastructure and fixed flaky tests. This plan organizes the test suite for maintainability.

# Large Files to Split (from RESEARCH.md)
- extension.test.ts: 1873 lines
- session.test.ts: 2711 lines
- workflow.test.ts: 2312 lines
- configuration.test.ts: 1340 lines
- gitChanges.test.ts: 1753 lines

# Existing Files to Move into New Structure
- sessionForm.test.ts, session-clear.test.ts -> session/
- workflow-resume.test.ts, code-agent.test.ts, mcp.test.ts -> workflow/
- branchValidation.test.ts, mergeBaseHandling.test.ts -> git/

# Previous Patterns
- Organize by module/functionality
- Keep test logic unchanged when reorganizing
- Run tests after each move to verify
</context>

<tasks>

<task type="auto">
  <name>Split extension.test.ts into core modules</name>
  <files>src/test/extension.test.ts, src/test/core/</files>
  <action>
    Split extension.test.ts (1873 lines) into focused modules:

    1. Create src/test/core/ directory if not exists

    2. Split tests into separate files by functionality:
       - src/test/core/extension-activation.test.ts - Extension lifecycle, activate, deactivate
       - src/test/core/commands.test.ts - Command registration
       - src/test/core/settings.test.ts - Settings file management

    3. Move relevant test suites from extension.test.ts to new files:
       - Copy imports to each new file
       - Move related test suites
       - Ensure proper setup/teardown in each file

    4. Delete or minimize extension.test.ts:
       - If tests remain, ensure file has clear purpose
       - If empty, delete the file

    5. Run tests to verify no regressions:
       ```bash
       npm test -- src/test/core/
       ```

    Target: Each new file under 500 lines, clear single responsibility.

    DO NOT change test logic or assertions - only organize into separate files.
  </action>
  <verify>
    npm test -- src/test/core/
    wc -l /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/core/*.test.ts  # All under 500 lines
  </verify>
  <done>
    extension.test.ts split into 3+ focused modules, each under 500 lines, all tests pass
  </done>
</task>

<task type="auto">
  <name>Split session.test.ts into session modules</name>
  <files>src/test/session.test.ts, src/test/session/</files>
  <action>
    Split session.test.ts (2711 lines) into focused modules:

    1. Create src/test/session/ directory if not exists

    2. Split tests into separate files:
       - src/test/session/session-creation.test.ts - Session creation logic
       - src/test/session/session-management.test.ts - Listing, deletion
       - src/test/session/session-listing.test.ts - Tree view rendering

    3. Move existing related files into session/ for consistency:
       - src/test/sessionForm.test.ts -> src/test/session/session-form.test.ts
       - src/test/session-clear.test.ts -> src/test/session/session-clear.test.ts

    4. Update imports in moved files

    5. Delete or minimize session.test.ts

    Target: Each file under 500 lines.

    DO NOT change test logic - only organize into separate files.
  </action>
  <verify>
    npm test -- src/test/session/
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/session -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
  </verify>
  <done>
    session tests split into 5+ files, all under 500 lines, existing tests moved into subdirectory
  </done>
</task>

<task type="auto">
  <name>Split workflow.test.ts into workflow modules</name>
  <files>src/test/workflow.test.ts, src/test/workflow/</files>
  <action>
    Split workflow.test.ts (2312 lines) into focused modules:

    1. Create src/test/workflow/ directory if not exists

    2. Split tests into separate files:
       - src/test/workflow/workflow-state.test.ts - State machine
       - src/test/workflow/workflow-progression.test.ts - Workflow advancement
       - src/test/workflow/workflow-templates.test.ts - Template handling

    3. Move existing related files into workflow/ for consistency:
       - src/test/workflow-resume.test.ts -> src/test/workflow/workflow-resume.test.ts
       - src/test/code-agent.test.ts -> src/test/workflow/code-agent.test.ts
       - src/test/mcp.test.ts -> src/test/workflow/mcp.test.ts

    4. Update imports in moved files

    5. Delete or minimize workflow.test.ts

    Target: Each file under 500 lines.

    DO NOT change test logic - only organize into separate files.
  </action>
  <verify>
    npm test -- src/test/workflow/
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/workflow -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
  </verify>
  <done>
    workflow tests split into 6+ files, all under 500 lines, existing tests moved into subdirectory
  </done>
</task>

<task type="auto">
  <name>Split configuration.test.ts and organize git tests</name>
  <files>src/test/configuration.test.ts, src/test/config/, src/test/git/</files>
  <action>
    Handle remaining large files:

    1. Create src/test/config/ directory if not exists
    2. Create src/test/git/ directory if not exists

    3. Split configuration.test.ts (1340 lines) into:
       - src/test/config/settings.test.ts - VS Code settings
       - src/test/config/workspace.test.ts - Workspace configuration
       - src/test/config/storage.test.ts - Global/local storage

    4. Move existing git-related files into git/ for consistency:
       - src/test/branchValidation.test.ts -> src/test/git/branch-validation.test.ts
       - src/test/mergeBaseHandling.test.ts -> src/test/git/merge-base.test.ts

    5. For gitChanges.test.ts (1753 lines) - if still large after flaky test fixes in 05-02:
       - src/test/git/diff.test.ts - Diff viewing
       - src/test/git/status.test.ts - Git status operations
       - Split if file exceeds 500 lines

    6. Delete or minimize configuration.test.ts

    Target: All test files under 500 lines.

    DO NOT change test logic - only organize into separate files.
  </action>
  <verify>
    npm test -- src/test/config/ src/test/git/
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/config -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/git -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
  </verify>
  <done>
    configuration.test.ts split into 3+ files, git tests organized in git/ subdirectory, all files under 500 lines
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. Run full test suite:
   ```bash
   npm test
   ```
   All tests should pass

2. Verify test file organization:
   ```bash
   find src/test -name "*.test.ts" -exec wc -l {} + | sort -rn | head -10
   ```
   Largest files should be under 500 lines

3. Verify directory structure:
   ```bash
   ls -la src/test/core/
   ls -la src/test/session/
   ls -la src/test/workflow/
   ls -la src/test/config/
   ls -la src/test/git/
   ```
   Should contain organized test files
</verification>

<success_criteria>
Plan 05-03 complete when:
1. All test files under 500 lines
2. Tests organized in subdirectories (core/, session/, workflow/, config/, git/)
3. Full test suite passes (npm test)
4. Existing related files moved into appropriate subdirectories (sessionForm, session-clear, workflow-resume, code-agent, mcp, branchValidation, mergeBaseHandling)
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-foundation/05-03-SUMMARY.md` with:
- Test file organization summary (before/after file counts)
- List of all new directories and files
- Largest remaining test files and line counts
- Any deviations from plan
</output>
