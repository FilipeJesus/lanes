---
phase: 05-test-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/test/brokenWorktree.test.ts
  - src/test/gitChanges.test.ts
autonomous: true

must_haves:
  truths:
    - "npm test passes consistently without intermittent failures"
    - "All previously skipped tests in brokenWorktree.test.ts now pass with proper mocking"
    - "All previously skipped tests in gitChanges.test.ts now pass with proper mocking"
    - "Tests use in-memory file system to avoid real I/O delays"
  artifacts:
    - path: "src/test/brokenWorktree.test.ts"
      provides: "Fixed worktree repair tests"
      contains: "sinon\\.stub.*execGit"
      not_contains: "test\\.skip"
    - path: "src/test/gitChanges.test.ts"
      provides: "Fixed git changes tests"
      contains: "vol\\.(fromJSON|reset)"
      not_contains: "test\\.skip"
  key_links:
    - from: "src/test/brokenWorktree.test.ts"
      to: "sinon.stub"
      via: "Git operation mocking"
      pattern: "sinon\\.stub.*execGit"
    - from: "src/test/gitChanges.test.ts"
      to: "memfs vol"
      via: "File system mocking"
      pattern: "vol\\.(fromJSON|reset)"
    - from: "both test files"
      to: "testSetup.ts"
      via: "Shared mock utilities"
      pattern: "import.*testSetup"
---

<objective>
Fix flaky tests using mocking infrastructure installed in plan 05-01.

Purpose: Eliminate test flakiness caused by real file system and git operations. Tests will use memfs for in-memory file operations and sinon for git stubbing.

Output: All previously skipped tests now pass with proper mocking.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-test-foundation/05-RESEARCH.md
@.planning/phases/05-test-foundation/05-01-SUMMARY.md

# Phase Context
Plan 05-01 installed memfs and sinon and created testSetup.ts utilities. This plan uses those utilities to fix flaky tests.

# Flaky Tests to Fix
- brokenWorktree.test.ts: 2 skipped tests (lines 254, 350) - real git worktree operations
- gitChanges.test.ts: 4 skipped tests (lines 80, 225, 1155, 1177) - parent directory traversal

# Previous Patterns
- Arrange-Act-Assert test structure
- setup()/teardown() for test lifecycle
- Import testSetup utilities for consistent mocking
</context>

<tasks>

<task type="auto">
  <name>Fix flaky worktree tests with mocking</name>
  <files>src/test/brokenWorktree.test.ts</files>
  <action>
    Fix the 2 skipped tests in brokenWorktree.test.ts using sinon for git mocking:

    1. Remove test.skip from:
       - Line 254: "should successfully repair a broken worktree when the branch exists"
       - Line 350: "should succeed when repairing directory without .git file if branch exists"

    2. Import testSetup utilities at top of file:
       ```typescript
       import { setupGitStubs, setupMemfs } from './testSetup';
       ```

    3. Replace real git operations with sinon.stub:
       - Stub execGit to avoid real worktree creation
       - Mock worktree list, prune, add operations
       - Use memfs for file system operations instead of fs.mkdtempSync

    4. Add setup/teardown:
       ```typescript
       let execGitStub: sinon.SinonStub;
       setup(() => {
           const { vol } = setupMemfs();
           vol.reset();
           execGitStub = setupGitStubs();
       });
       teardown(() => {
           execGitStub.restore();
       });
       ```

    DO NOT change the test logic or assertions - only replace real operations with mocks.
  </action>
  <verify>
    npm test -- src/test/brokenWorktree.test.ts
    grep -n "test.skip" /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/brokenWorktree.test.ts | wc -l  # Should be 0
  </verify>
  <done>
    All brokenWorktree tests pass, no test.skip remaining, git operations use sinon.stub
  </done>
</task>

<task type="auto">
  <name>Fix flaky gitChanges tests with mocking</name>
  <files>src/test/gitChanges.test.ts</files>
  <action>
    Fix the 4 skipped tests in gitChanges.test.ts:

    1. Remove test.skip from:
       - Line 80: "getBranchesInWorktrees should return empty set when no worktrees have branches"
       - Line 225: "should return main as fallback for non-git directory"
       - Line 1155: "should return original path for non-git directory"
       - Line 1177: "should log warning when git command fails in non-git directory"

    2. Import testSetup utilities at top of file

    3. Stub getBaseRepoPath and execGit to avoid parent directory traversal:
       - Mock getBaseRepoPath to return fixed test path
       - Stub execGit responses for non-git directory scenarios

    4. Use memfs for file system mocking:
       - Replace fs.mkdtempSync with vol.fromJSON for test directories
       - Use vol.reset() in teardown

    Focus on the root cause: git traverses parent directories to find repos, making tests environment-dependent.

    DO NOT change test assertions - only replace real git/fs operations with mocks.
  </action>
  <verify>
    npm test -- src/test/gitChanges.test.ts
    grep -n "test.skip" /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/gitChanges.test.ts | wc -l  # Should be 0
  </verify>
  <done>
    All gitChanges tests pass, no test.skip remaining, parent traversal mocked
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. Run test suites:
   ```bash
   npm test -- src/test/brokenWorktree.test.ts
   npm test -- src/test/gitChanges.test.ts
   ```
   All tests should pass

2. Verify no skipped tests remain:
   ```bash
   grep -n "test.skip" src/test/brokenWorktree.test.ts
   grep -n "test.skip" src/test/gitChanges.test.ts
   ```
   Should return 0 results

3. Verify mocking is used:
   ```bash
   grep "sinon.stub" src/test/brokenWorktree.test.ts
   grep "vol.fromJSON\|vol.reset" src/test/gitChanges.test.ts
   ```
   Should find mocking patterns
</verification>

<success_criteria>
Plan 05-02 complete when:
1. npm test passes for both test files
2. Zero test.skip calls in brokenWorktree.test.ts and gitChanges.test.ts
3. Tests use sinon.stub for git operations
4. Tests use memfs for file system operations
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-foundation/05-02-SUMMARY.md` with:
- List of fixed flaky tests
- Before/after comparison of test approaches
- Any deviations from plan
</output>
