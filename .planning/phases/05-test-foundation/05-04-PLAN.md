---
phase: 05-test-foundation
plan: 04
type: execute
wave: 1
depends_on:
  - 05-03
files_modified:
  - src/test/git/diff.test.ts
  - src/test/config/settings.test.ts
  - src/test/workflow/mcp.test.ts
  - src/test/previousSession.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All test files are under 500 lines per file"
    - "Tests are organized by functionality in appropriate subdirectories"
    - "Each test file has a single, clear responsibility"
    - "All tests continue to pass after reorganization"
  artifacts:
    - path: "src/test/git/"
      provides: "Split git diff tests"
      min_files: 6
      max_lines_per_file: 500
    - path: "src/test/config/"
      provides: "Split configuration tests"
      min_files: 3
      max_lines_per_file: 500
    - path: "src/test/workflow/"
      provides: "Split MCP tests"
      min_files: 4
      max_lines_per_file: 500
    - path: "src/test/session/"
      provides: "Session tests including previousSession"
      contains: "previousSession.test.ts"
  key_links:
    - from: "split test files"
      to: "source modules"
      via: "Maintained import paths"
      pattern: "import.*from.*src/"
---

<objective>
Split remaining large test files to achieve the 500-line target and complete test organization.

Purpose: Close gaps identified in 05-VERIFICATION.md by splitting 4 test files that exceed 500 lines and moving previousSession.test.ts to the session/ subdirectory.

Output: All test files under 500 lines, fully organized test suite.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-test-foundation/05-VERIFICATION.md
@.planning/phases/05-test-foundation/05-03-SUMMARY.md

# Gap Closure Context

Per 05-VERIFICATION.md, the following gaps remain:

**Gap 1: 4 test files exceed 500-line target**
- src/test/git/diff.test.ts (1795 lines) - Contains complex webview rendering tests
- src/test/config/settings.test.ts (1341 lines) - Configuration validation tests
- src/test/workflow/mcp.test.ts (856 lines) - MCP tools and state persistence tests
- src/test/previousSession.test.ts (521 lines) - Should be in session/ subdirectory

**Gap 2: testSetup.ts utilities not actively used**
- Utilities created but not imported by test files
- Tests use direct sinon.stub pattern instead
- This is documented as intentional in 05-02-SUMMARY
- No action required - direct stubbing is the established pattern

**Gap 3: 9 tests use conditional skips**
- All are environment-specific (git availability, branch existence)
- Not flakiness-related
- Full isolation would require extensive mocking beyond current scope
- Document as acceptable deviation

# Existing Test Organization

From 05-03-SUMMARY:
- src/test/core/ - 9 files
- src/test/session/ - 5 files
- src/test/workflow/ - 5 files
- src/test/config/ - 1 file (settings.test.ts - 1341 lines)
- src/test/git/ - 3 files (diff.test.ts - 1795 lines, branch-validation.test.ts, merge-base.test.ts)

# Test File Structures

**diff.test.ts (1795 lines) - suites:**
- Branch Handling (lines ~73-142)
- Git Changes Button (lines ~144-210)
- Git Changes Command (lines ~212-229)
- getBaseBranch (lines ~231-288)
- Git Changes Webview (lines ~290-549)
  - parseDiff (lines ~316-549)
- Git Changes Panel HTML Generation (lines ~551-696)
- GitChangesPanel Comment Feature (lines ~698-876)
  - ReviewComment Interface (lines ~700-767)
  - Diff HTML Comment Buttons (lines ~769-808)
  - Submit Review Button (lines ~810-832)
  - Comment Badge (lines ~834-873)
  - Webview Message Handler (lines ~875-896)
- formatReviewForClipboard (lines ~898-1077)
- Base Branch Configuration (lines ~1079-1141)
- Worktree Detection (lines ~1143-1263)
- Base Branch Selection (lines ~1265-1421)
- Panel State (lines ~1423-1490)
- Git Changes with Untracked Files (lines ~1492-1746)
  - parseUntrackedFiles (lines ~1494-1565)
  - isBinaryContent (lines ~1567-1634)
  - synthesizeUntrackedFileDiff (lines ~1636-1746)
- Integration: Git Status Respects .gitignore (lines ~1748-1795)

**settings.test.ts (1341 lines) - suites:**
- Non-Global Session Management Path (lines ~54-155)
- Global Storage (lines ~157-440)
  - getRepoIdentifier (lines ~175-273)
  - getSessionNameFromWorktree (lines ~275-298)
  - getGlobalStoragePath (lines ~300-386)
  - Path functions respect useGlobalStorage (lines ~388-440)
- isGlobalStorageEnabled (lines ~442-480)
- Configuration (lines ~482-535)
- Configuration Structure (lines ~537-581)
- Configuration Sections (lines ~583-813)
- Configuration Defaults (lines ~815-859)
- Configuration Descriptions (lines ~861-888)
- Prompts Storage (lines ~890-1299)
  - Default: Global Storage (lines ~908-979)
  - User Override: Repo-Relative (lines ~981-1069)
  - Path Security Validation (lines ~1071-1234)
  - Fallback: Global Storage Not Initialized (lines ~1236-1299)
- Package.json Configuration (lines ~1301-1341)

**mcp.test.ts (856 lines) - suites:**
- MCP Tools (lines ~96-599)
  - workflowStart (lines ~122-172)
  - workflowSetTasks (lines ~174-213)
  - workflowAdvance (lines ~215-272)
  - workflowStatus (lines ~274-387)
  - workflowContext (lines ~389-447)
  - workflowRegisterArtefacts (lines ~449-598)
- MCP State (lines ~601-746)
  - State Persistence (lines ~625-745)
- MCP Session Creation with Workflow (lines ~748-856)

**previousSession.test.ts (521 lines) - suites:**
- PreviousSessionItem (lines ~14-119)
- PreviousSessionProvider (lines ~121-347)
- getPromptsDir (lines ~349-521)

# Previous Patterns

From 05-03-SUMMARY:
- DO NOT change test logic or assertions - only organize into separate files
- Run tests after each split to verify no regressions
- Copy imports to each new file
- Ensure proper setup/teardown in each file
</context>

<tasks>

<task type="auto">
  <name>Split diff.test.ts into focused modules</name>
  <files>src/test/git/diff.test.ts, src/test/git/*.test.ts</files>
  <action>
    Split src/test/git/diff.test.ts (1795 lines) into focused modules:

    1. Create the following new test files in src/test/git/:

       **diff-branches.test.ts** - Branch handling utilities (~70 lines)
       - Copy imports from diff.test.ts
       - Move "Branch Handling" suite (branchExists, getBranchesInWorktrees tests)
       - Copy setup/teardown (tempDir, worktreesDir, execGitStub)
       - Target: ~150 lines with setup

       **diff-command.test.ts** - Command registration and button (~150 lines)
       - Copy imports from diff.test.ts
       - Move "Git Changes Button" and "Git Changes Command" suites
       - Copy setup/teardown
       - Target: ~250 lines with setup

       **diff-base-branch.test.ts** - Base branch detection and selection (~400 lines)
       - Copy imports from diff.test.ts
       - Move "getBaseBranch", "Base Branch Configuration", "Worktree Detection", "Base Branch Selection" suites
       - Copy setup/teardown
       - Target: ~500 lines with setup

       **diff-parsing.test.ts** - Diff parsing utilities (~400 lines)
       - Copy imports from diff.test.ts
       - Move "parseDiff" suite (inside Git Changes Webview)
       - Move "Git Changes with Untracked Files" suite (parseUntrackedFiles, isBinaryContent, synthesizeUntrackedFileDiff)
       - Move "Integration: Git Status Respects .gitignore" suite
       - Copy setup/teardown
       - Target: ~500 lines with setup

       **diff-webview.test.ts** - Webview rendering and HTML generation (~500 lines)
       - Copy imports from diff.test.ts
       - Move "Git Changes Webview" suite (excluding parseDiff - now in diff-parsing.test.ts)
       - Move "Git Changes Panel HTML Generation" suite
       - Copy setup/teardown
       - Target: ~500 lines with setup

       **diff-comments.test.ts** - Review comment feature (~400 lines)
       - Copy imports from diff.test.ts
       - Move "GitChangesPanel Comment Feature" suite and all sub-suites
       - Move "formatReviewForClipboard" suite
       - Copy setup/teardown
       - Target: ~500 lines with setup

    2. After creating all new files, delete the original diff.test.ts

    3. Run tests to verify:
       ```bash
       npm test -- src/test/git/
       ```

    DO NOT change test logic or assertions - only organize into separate files.
    Each new file must have complete setup/teardown and imports.
  </action>
  <verify>
    npm test -- src/test/git/
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/git -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
  </verify>
  <done>
    diff.test.ts split into 6 focused modules (diff-branches, diff-command, diff-base-branch, diff-parsing, diff-webview, diff-comments), all under 500 lines, all tests pass
  </done>
</task>

<task type="auto">
  <name>Split settings.test.ts into focused modules</name>
  <files>src/test/config/settings.test.ts, src/test/config/*.test.ts</files>
  <action>
    Split src/test/config/settings.test.ts (1341 lines) into focused modules:

    1. Create the following new test files in src/test/config/:

       **global-storage.test.ts** - Global storage path functions (~450 lines)
       - Copy imports from settings.test.ts
       - Move "Global Storage" suite (getRepoIdentifier, getSessionNameFromWorktree, getGlobalStoragePath, Path functions respect useGlobalStorage)
       - Move "isGlobalStorageEnabled" suite
       - Move "Non-Global Session Management Path" suite
       - Copy setup/teardown if present
       - Target: ~500 lines

       **configuration.test.ts** - VS Code configuration structure (~450 lines)
       - Copy imports from settings.test.ts
       - Move "Configuration" suite
       - Move "Configuration Structure" suite
       - Move "Configuration Sections" suite
       - Move "Configuration Defaults" suite
       - Move "Configuration Descriptions" suite
       - Move "Package.json Configuration" suite
       - Copy setup/teardown if present
       - Target: ~500 lines

       **prompts-storage.test.ts** - Prompts folder configuration (~450 lines)
       - Copy imports from settings.test.ts
       - Move "Prompts Storage" suite and all sub-suites (Default: Global Storage, User Override: Repo-Relative, Path Security Validation, Fallback: Global Storage Not Initialized)
       - Copy setup/teardown if present
       - Target: ~500 lines

    2. After creating all new files, delete the original settings.test.ts

    3. Run tests to verify:
       ```bash
       npm test -- src/test/config/
       ```

    DO NOT change test logic or assertions - only organize into separate files.
    Each new file must have complete setup/teardown and imports.
  </action>
  <verify>
    npm test -- src/test/config/
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/config -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
  </verify>
  <done>
    settings.test.ts split into 3 focused modules (global-storage, configuration, prompts-storage), all under 500 lines, all tests pass
  </done>
</task>

<task type="auto">
  <name>Split mcp.test.ts and move previousSession.test.ts</name>
  <files>src/test/workflow/mcp.test.ts, src/test/workflow/*.test.ts, src/test/previousSession.test.ts, src/test/session/previousSession.test.ts</files>
  <action>
    Split src/test/workflow/mcp.test.ts (856 lines) into 2 modules and move previousSession.test.ts:

    **Part 1: Split mcp.test.ts**

    1. Create src/test/workflow/mcp-tools.test.ts:
       - Copy imports from mcp.test.ts
       - Move "MCP Tools" suite and all sub-suites (workflowStart, workflowSetTasks, workflowAdvance, workflowStatus, workflowContext, workflowRegisterArtefacts)
       - Copy setup/teardown
       - Target: ~550 lines

    2. Rename src/test/workflow/mcp.test.ts to mcp-state.test.ts:
       - Keep "MCP State" suite (State Persistence)
       - Keep "MCP Session Creation with Workflow" suite
       - This file already exists - just rename it
       - After renaming, the content should be ~250 lines

    **Part 2: Move previousSession.test.ts**

    3. Move src/test/previousSession.test.ts to src/test/session/previousSession.test.ts:
       - Use git mv or copy + delete to move the file
       - No changes to test content needed
       - The file is 521 lines - acceptable but note that it could be split further in a future plan

    4. Run tests to verify:
       ```bash
       npm test -- src/test/workflow/ src/test/session/
       ```

    DO NOT change test logic or assertions.
  </action>
  <verify>
    npm test -- src/test/workflow/ src/test/session/
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/workflow -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
    [ -f /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/session/previousSession.test.ts ]  # File moved
  </verify>
  <done>
    mcp.test.ts split into mcp-tools.test.ts and mcp-state.test.ts, previousSession.test.ts moved to session/ subdirectory, all tests pass
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. Run full test suite:
   ```bash
   npm test
   ```
   All tests should pass

2. Verify all test files under 500 lines:
   ```bash
   find src/test -name "*.test.ts" -exec wc -l {} + | sort -rn | head -20
   ```
   Largest files should be under 500 lines

3. Verify directory structure:
   ```bash
   find src/test -type d -ls
   ls -la src/test/git/
   ls -la src/test/config/
   ls -la src/test/workflow/
   ls -la src/test/session/
   ```

4. Verify no orphaned files:
   ```bash
   # These original files should NOT exist:
   [ ! -f src/test/git/diff.test.ts ] || echo "ERROR: diff.test.ts still exists"
   [ ! -f src/test/config/settings.test.ts ] || echo "ERROR: settings.test.ts still exists"
   [ ! -f src/test/workflow/mcp.test.ts ] || echo "ERROR: mcp.test.ts still exists"
   [ ! -f src/test/previousSession.test.ts ] || echo "ERROR: previousSession.test.ts still in root"
   ```

5. Count test files by subdirectory:
   ```bash
   echo "Core: $(ls -1 src/test/core/*.test.ts 2>/dev/null | wc -l)"
   echo "Session: $(ls -1 src/test/session/*.test.ts 2>/dev/null | wc -l)"
   echo "Workflow: $(ls -1 src/test/workflow/*.test.ts 2>/dev/null | wc -l)"
   echo "Config: $(ls -1 src/test/config/*.test.ts 2>/dev/null | wc -l)"
   echo "Git: $(ls -1 src/test/git/*.test.ts 2>/dev/null | wc -l)"
   ```
   Expected: Core: 9+, Session: 6+, Workflow: 6+, Config: 3+, Git: 6+
</verification>

<success_criteria>
Plan 05-04 complete when:
1. All test files under 500 lines (no file exceeds 500 lines)
2. diff.test.ts split into 6 files in src/test/git/
3. settings.test.ts split into 3 files in src/test/config/
4. mcp.test.ts split into 2 files in src/test/workflow/
5. previousSession.test.ts moved to src/test/session/
6. Full test suite passes (npm test)
7. Original large files deleted
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-foundation/05-04-SUMMARY.md` with:
- Test file split summary (before/after for each file)
- List of all new files created
- Final line counts for each file
- Confirmation that all files are under 500 lines
- Any deviations from plan
</output>
