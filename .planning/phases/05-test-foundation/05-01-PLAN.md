---
phase: 05-test-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/test/testSetup.ts
autonomous: true

must_haves:
  truths:
    - "memfs and sinon packages are installed as devDependencies"
    - "Shared testSetup.ts exports setupMemfs, setupGitStubs, and createTestRepo utilities"
    - "Test utilities can be imported across all test files"
  artifacts:
    - path: "package.json"
      provides: "Test dependencies (memfs, sinon)"
      contains: "memfs.*sinon"
    - path: "src/test/testSetup.ts"
      provides: "Shared test utilities for memfs and sinon"
      exports: ["setupMemfs", "setupGitStubs", "createTestRepo"]
  key_links:
    - from: "all test files"
      to: "testSetup.ts"
      via: "Import shared mock utilities"
      pattern: "import.*testSetup"
---

<objective>
Install test mocking infrastructure (memfs, sinon) and create shared test setup utilities.

Purpose: Establish the foundation for test mocking by installing required dependencies and creating reusable utilities. This is a prerequisite for fixing flaky tests.

Output: Installed memfs and sinon packages, testSetup.ts with exported utilities.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-test-foundation/05-RESEARCH.md

# Phase Context
Phase 5 focuses on test stability. Research identified memfs for in-memory FS and sinon for git operation stubbing as the standard stack.

# Previous Patterns
- Use npm install --save-dev for dev dependencies
- Export utilities for reuse across test files
</context>

<tasks>

<task type="auto">
  <name>Install memfs and sinon packages</name>
  <files>package.json</files>
  <action>
    1. Install memfs and sinon as devDependencies:
       ```bash
       npm install --save-dev memfs sinon
       npm install --save-dev @types/sinon
       ```

    2. Verify installation in package.json devDependencies

    DO NOT modify test framework (Mocha is correct).
  </action>
  <verify>
    grep -E '"memfs"|"sinon"' /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/package.json
    ls /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/node_modules/memfs
    ls /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/node_modules/sinon
  </verify>
  <done>
    memfs and sinon present in package.json devDependencies, installed in node_modules
  </done>
</task>

<task type="auto">
  <name>Create shared testSetup.ts utilities</name>
  <files>src/test/testSetup.ts</files>
  <action>
    Create or enhance src/test/testSetup.ts with shared utilities:

    1. `setupMemfs()` - Returns vol instance with reset() method
       - Imports { fs, vol } from 'memfs'
       - Provides vol.reset() for cleanup

    2. `setupGitStubs()` - Returns sinon.stub for execGit
       - Imports sinon from 'sinon'
       - Creates configurable stub for git operations
       - Provides restore() method for cleanup

    3. `createTestRepo(vol)` - Creates in-memory git repo structure
       - Creates .git directory structure
       - Sets up basic git config files

    4. Export all utilities for use across tests

    DO NOT create test logic - only infrastructure utilities.
  </action>
  <verify>
    cat /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/testSetup.ts | grep -E "export.*setupMemfs|export.*setupGitStubs|export.*createTestRepo"
  </verify>
  <done>
    testSetup.ts exists and exports setupMemfs, setupGitStubs, and createTestRepo
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. Verify packages installed:
   ```bash
   grep -E '"memfs"|"sinon"' package.json
   ```
   Both should be present in devDependencies

2. Verify testSetup exports:
   ```bash
   grep -E "export" src/test/testSetup.ts
   ```
   Should export setupMemfs, setupGitStubs, createTestRepo
</verification>

<success_criteria>
Plan 05-01 complete when:
1. memfs and sinon are in package.json devDependencies
2. node_modules/memfs and node_modules/sinon exist
3. testSetup.ts exports setupMemfs, setupGitStubs, and createTestRepo
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-foundation/05-01-SUMMARY.md` with:
- Installed package versions
- Created utilities summary
- Any deviations from plan
</output>
