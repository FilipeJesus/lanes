---
phase: 05-test-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/test/brokenWorktree.test.ts
  - src/test/gitChanges.test.ts
  - src/test/extension.test.ts
  - src/test/session.test.ts
  - src/test/workflow.test.ts
  - src/test/configuration.test.ts
autonomous: true

must_haves:
  truths:
    - "npm test passes consistently without intermittent failures"
    - "All previously skipped tests now pass with proper mocking"
    - "Tests execute faster due to in-memory file system mocking"
    - "Test suite can run in parallel without race conditions"
    - "Large test files (500+ lines) are split into focused modules"
  artifacts:
    - path: "package.json"
      provides: "Test dependencies (memfs, sinon)"
      contains: "memfs.*sinon"
    - path: "src/test/testSetup.ts"
      provides: "Shared test utilities for memfs and sinon"
      exports: ["setupMemfs", "setupGitStubs"]
    - path: "src/test/worktree/"
      provides: "Split worktree-related tests"
      min_files: 2
    - path: "src/test/core/"
      provides: "Split core extension tests"
      min_files: 2
    - path: "src/test/workflow/"
      provides: "Split workflow tests"
      min_files: 2
  key_links:
    - from: "src/test/brokenWorktree.test.ts"
      to: "sinon.stub"
      via: "Git operation mocking"
      pattern: "sinon\\.stub.*execGit"
    - from: "src/test/gitChanges.test.ts"
      to: "memfs vol"
      via: "File system mocking"
      pattern: "vol\\.(fromJSON|reset)"
    - from: "all new tests"
      to: "testSetup.ts"
      via: "Shared mock utilities"
      pattern: "import.*testSetup"
---

<objective>
Install test utilities (memfs, sinon), fix flaky tests with proper mocking, and split large test files into focused modules.

Purpose: Eliminate test flakiness caused by real file system and git operations, improve test organization for maintainability.

Output: Stable test suite passing consistently in CI, organized test files by functionality.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-test-foundation/05-RESEARCH.md
@.planning/codebase/TESTING.md

# Phase Context
Phase 5 focuses on test stability and organization. Research identified:
- 6 tests permanently skipped due to flakiness (real git operations, fs race conditions)
- 5 test files over 1000 lines (session.test.ts: 2711, workflow.test.ts: 2312, extension.test.ts: 1873, gitChanges.test.ts: 1753, configuration.test.ts: 1340)
- Standard stack (Mocha + @vscode/test-electron) is correct - only mocking utilities needed
- memfs for in-memory FS, sinon for git operation stubbing

# Previous Patterns
- Phase 1-4: Pre-flight validation, discriminated unions, ValidationError pattern
- Use assert.ok() for existence checks, assert.strictEqual() for equality
- Arrange-Act-Assert test structure
- setup()/teardown() for test lifecycle
</context>

<tasks>

<task type="auto">
  <name>Install test utilities and create shared test setup</name>
  <files>package.json, src/test/testSetup.ts</files>
  <action>
    1. Install memfs and sinon as devDependencies:
       ```bash
       npm install --save-dev memfs sinon
       npm install --save-dev @types/sinon
       ```

    2. Update package.json scripts to verify installation

    3. Create or enhance src/test/testSetup.ts with shared utilities:
       - `setupMemfs()` - Returns vol instance with reset()
       - `setupGitStubs()` - Returns sinon.stub for execGit with common mock responses
       - `createTestRepo(vol)` - Creates in-memory git repo structure
       - Export utilities for use across tests

    DO NOT modify test framework (Mocha is correct).
  </action>
  <verify>
    grep -E '"memfs"|"sinon"' /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/package.json
    ls /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/node_modules/memfs
    ls /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/node_modules/sinon
  </verify>
  <done>
    memfs and sinon installed in node_modules, package.json updated, testSetup.ts exports setupMemfs, setupGitStubs, createTestRepo
  </done>
</task>

<task type="auto">
  <name>Fix flaky worktree tests with mocking</name>
  <files>src/test/brokenWorktree.test.ts</files>
  <action>
    Fix the 2 skipped tests in brokenWorktree.test.ts using sinon for git mocking:

    1. Remove test.skip from:
       - Line 254: "should successfully repair a broken worktree when the branch exists"
       - Line 350: "should succeed when repairing directory without .git file if branch exists"

    2. Replace real git operations with sinon.stub:
       - Stub execGit to avoid real worktree creation
       - Mock worktree list, prune, add operations
       - Use memfs for file system operations instead of fs.mkdtempSync

    3. Import testSetup utilities for consistent mocking

    4. Verify tests still test the repair logic, not git itself

    DO NOT change the test logic - only replace real operations with mocks.
  </action>
  <verify>
    npm test -- src/test/brokenWorktree.test.ts
    grep -n "test.skip" /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/brokenWorktree.test.ts | wc -l  # Should be 0
  </verify>
  <done>
    All brokenWorktree tests pass, no test.skip remaining, git operations use sinon.stub
  </done>
</task>

<task type="auto">
  <name>Fix flaky gitChanges tests with mocking</name>
  <files>src/test/gitChanges.test.ts</files>
  <action>
    Fix the 4 skipped tests in gitChanges.test.ts:

    1. Remove test.skip from:
       - Line 80: "getBranchesInWorktrees should return empty set when no worktrees have branches"
       - Line 225: "should return main as fallback for non-git directory"
       - Line 1155: "should return original path for non-git directory"
       - Line 1177: "should log warning when git command fails in non-git directory"

    2. Stub getBaseRepoPath and execGit to avoid parent directory traversal
    3. Use memfs for file system mocking instead of real temp directories

    Focus on the root cause: git traverses parent directories to find repos, making tests environment-dependent.

    DO NOT change test assertions - only replace real git/fs operations with mocks.
  </action>
  <verify>
    npm test -- src/test/gitChanges.test.ts
    grep -n "test.skip" /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/gitChanges.test.ts | wc -l  # Should be 0
  </verify>
  <done>
    All gitChanges tests pass, no test.skip remaining, parent traversal mocked
  </done>
</task>

<task type="auto">
  <name>Split extension.test.ts into focused modules</name>
  <files>src/test/extension.test.ts, src/test/core/</files>
  <action>
    Split extension.test.ts (1873 lines) into focused modules:

    1. Create src/test/core/ directory if not exists

    2. Split tests into separate files by functionality:
       - src/test/core/extension-activation.test.ts - Extension lifecycle, activate, deactivate
       - src/test/core/commands.test.ts - Command registration
       - src/test/core/settings.test.ts - Settings file management (from extension.test.ts)

    3. Move relevant test suites from extension.test.ts to new files
    4. Delete or minimize extension.test.ts (move remaining tests to appropriate modules)
    5. Ensure all imports are updated in new files
    6. Run tests to verify no regressions

    Target: Each new file under 500 lines, clear single responsibility.

    DO NOT change test logic - only organize into separate files.
  </action>
  <verify>
    npm test -- src/test/core/
    wc -l /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/core/*.test.ts  # All under 500 lines
  </verify>
  <done>
    extension.test.ts split into 3+ focused modules, each under 500 lines, all tests pass
  </done>
</task>

<task type="auto">
  <name>Split session.test.ts and workflow.test.ts into focused modules</name>
  <files>src/test/session.test.ts, src/test/workflow.test.ts, src/test/session/, src/test/workflow/</files>
  <action>
    Split the two largest test files:
    - session.test.ts (2711 lines) -> src/test/session/
    - workflow.test.ts (2312 lines) -> src/test/workflow/

    For session.test.ts, create:
    - src/test/session/session-creation.test.ts
    - src/test/session/session-management.test.ts
    - src/test/session/session-listing.test.ts

    For workflow.test.ts, create:
    - src/test/workflow/workflow-state.test.ts
    - src/test/workflow/workflow-progression.test.ts
    - src/test/workflow/workflow-templates.test.ts

    Move existing files (sessionForm.test.ts, workflow-resume.test.ts, etc.) into these directories for consistency.

    Target: Each file under 500 lines.
  </action>
  <verify>
    npm test -- src/test/session/ src/test/workflow/
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/session -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test/workflow -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty
  </verify>
  <done>
    session and workflow tests split into 6+ files, all under 500 lines, existing tests moved into subdirectories
  </done>
</task>

<task type="auto">
  <name>Split configuration.test.ts and organize remaining large files</name>
  <files>src/test/configuration.test.ts, src/test/gitChanges.test.ts, src/test/config/</files>
  <action>
    Handle remaining large files:
    - configuration.test.ts (1340 lines) -> src/test/config/
    - Review gitChanges.test.ts (1753 lines) for further splitting if needed

    For configuration.test.ts, create:
    - src/test/config/settings.test.ts - VS Code settings
    - src/test/config/workspace.test.ts - Workspace configuration
    - src/test/config/storage.test.ts - Global/local storage

    For gitChanges.test.ts, if still large after fixing flaky tests:
    - src/test/git/diff.test.ts - Diff viewing
    - src/test/git/status.test.ts - Git status operations

    Create src/test/git/ directory for git-related tests (move branchValidation.test.ts, mergeBaseHandling.test.ts).

    Target: All test files under 500 lines.
  </action>
  <verify>
    npm test
    find /Users/filipejesus/Documents/repos/ai-agent-extension/claude-orchestra/src/test -name "*.test.ts" -exec wc -l {} + | awk '$1 > 500 {print $0}'  # Should be empty or minimal
  </verify>
  <done>
    All test files under 500 lines, git tests organized in git/ subdirectory, full test suite passes
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify phase success criteria:

1. Run full test suite: npm test
   - All tests should pass (no skips, no failures)
   - Test execution should be faster due to in-memory mocking

2. Verify no skipped tests remain:
   ```bash
   grep -r "test\.skip" src/test/
   ```
   Should return 0 results (or only intentionally skipped tests with documented reasons)

3. Verify test file organization:
   ```bash
   find src/test -name "*.test.ts" -exec wc -l {} + | sort -rn | head -5
   ```
   Largest files should be under 500 lines

4. Verify dependencies installed:
   ```bash
   grep -E '"memfs"|"sinon"' package.json
   ```
   Both should be present in devDependencies
</verification>

<success_criteria>
Phase 5 complete when:
1. npm test passes consistently without intermittent failures
2. Zero test.skip calls in brokenWorktree.test.ts and gitChanges.test.ts
3. All test files under 500 lines (or justified if larger)
4. Tests organized by functionality in subdirectories (core/, session/, workflow/, git/, config/)
5. memfs and sinon integrated via testSetup.ts for consistent mocking
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-foundation/05-01-SUMMARY.md` with:
- Test file organization summary (before/after file counts)
- List of fixed flaky tests
- Performance improvements (test execution time if measurable)
- Any deviations from plan
</output>
