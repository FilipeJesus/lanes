---
phase: 01-foundation-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ClaudeSessionProvider.ts
  - src/services/SettingsService.ts
  - src/services/TerminalService.ts
  - src/services/SessionService.ts
  - src/services/SessionProcessService.ts
  - src/commands/sessionCommands.ts
  - src/watchers.ts
  - src/extension.ts
  - src/codeAgents/CodeAgent.ts
  - src/codeAgents/ClaudeCodeAgent.ts
autonomous: true

must_haves:
  truths:
    - "A hypothetical second agent with different file names would have its paths resolved correctly by all services (no hardcoded .claude-session or .claude-status outside src/codeAgents/)"
    - "Watch patterns for session/status files adapt to whatever file names the active CodeAgent specifies"
    - "Terminal names display the agent's chosen prefix, not a hardcoded 'Claude:' string"
  artifacts:
    - path: "src/ClaudeSessionProvider.ts"
      provides: "Agent-agnostic path functions using codeAgent methods"
      contains: "codeAgent.getSessionFileName"
    - path: "src/services/SettingsService.ts"
      provides: "Watch patterns constructed from agent methods"
      contains: "getStatusFileName"
    - path: "src/watchers.ts"
      provides: "Agent-agnostic global storage watch patterns"
      contains: "getStatusFileName"
    - path: "src/codeAgents/CodeAgent.ts"
      provides: "getLocalSettingsFiles abstract method"
      contains: "getLocalSettingsFiles"
  key_links:
    - from: "src/ClaudeSessionProvider.ts"
      to: "src/codeAgents/CodeAgent.ts"
      via: "getSessionFileName(), getStatusFileName() calls"
      pattern: "codeAgent\\.get(Session|Status)FileName"
    - from: "src/services/SettingsService.ts"
      to: "src/codeAgents/CodeAgent.ts"
      via: "agent method calls for watch patterns"
      pattern: "getStatusFileName|getSessionFileName"
    - from: "src/watchers.ts"
      to: "src/codeAgents/CodeAgent.ts"
      via: "agent method calls for global storage watch patterns"
      pattern: "getStatusFileName|getSessionFileName"
---

<objective>
Replace all hardcoded Claude-specific string literals in shared production code with CodeAgent method calls. After this plan, every file path, watch pattern, and terminal name is constructed through CodeAgent methods.

Purpose: Establish the foundation for multi-agent support by ensuring no shared code assumes Claude-specific file names, paths, or conventions. This is a prerequisite for Plan 01-02's localSettings generalization and for Plan 01-03/04's service renaming.

Output: All services use CodeAgent methods for agent-specific behavior. No hardcoded `.claude-session`, `.claude-status`, or `Claude:` strings outside `src/codeAgents/`.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-refactoring/01-CONTEXT.md

@src/codeAgents/CodeAgent.ts
@src/codeAgents/ClaudeCodeAgent.ts
@src/ClaudeSessionProvider.ts
@src/services/SettingsService.ts
@src/services/TerminalService.ts
@src/services/SessionService.ts
@src/services/SessionProcessService.ts
@src/commands/sessionCommands.ts
@src/watchers.ts
@src/extension.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded file paths and terminal names with CodeAgent method calls</name>
  <files>
    src/ClaudeSessionProvider.ts
    src/services/SettingsService.ts
    src/commands/sessionCommands.ts
    src/watchers.ts
    src/codeAgents/CodeAgent.ts
    src/codeAgents/ClaudeCodeAgent.ts
  </files>
  <action>
    Replace all hardcoded `.claude-session`, `.claude-status`, and `Claude:` string literals in shared code with CodeAgent method calls. Do NOT rename any functions, classes, or files -- that is Plan 01-03/04's scope.

    **src/codeAgents/CodeAgent.ts:**
    - Add abstract method `getLocalSettingsFiles(): Array<{ dir: string; file: string }>` to the CodeAgent class. This enables localSettings.ts (Plan 01-02) to ask the agent what config files to propagate.

    **src/codeAgents/ClaudeCodeAgent.ts:**
    - Implement `getLocalSettingsFiles()`: `return [{ dir: '.claude', file: 'settings.local.json' }];`

    **src/ClaudeSessionProvider.ts:**
    - `getClaudeSessionPath()`: Replace the fallback `|| '.claude-session'` on line 118 with a call through `globalCodeAgent`. Extract a `DEFAULTS` constant at the top of the file documenting these are Claude defaults used only when no agent is configured: `const DEFAULTS = { sessionFileName: '.claude-session', statusFileName: '.claude-status' };`. Use: `globalCodeAgent?.getSessionFileName() || DEFAULTS.sessionFileName`.
    - `getClaudeStatusPath()`: Same treatment for `|| '.claude-status'` fallback on line 129.
    - `getClaudeStatus()`: The fallback JSON.parse branch (lines 234-236) that hardcodes VALID_STATUS_VALUES -- wrap with a comment noting this is the legacy fallback for backward compatibility. Keep the fallback but document it.

    **src/services/SettingsService.ts:**
    - `getStatusWatchPattern()`: Replace hardcoded `'**/.claude-status'` and `'.lanes/session_management/**/*/.claude-status'` (lines 101, 104) with patterns constructed from `getGlobalCodeAgent()?.getStatusFileName()`. Import `getGlobalCodeAgent` from ClaudeSessionProvider. Pattern: `const statusFileName = getGlobalCodeAgent()?.getStatusFileName() || DEFAULTS.statusFileName; return isGlobalStorageEnabled() ? '**/' + statusFileName : '.lanes/session_management/**/*/' + statusFileName;` (import or duplicate the DEFAULTS constant).
    - `getSessionWatchPattern()`: Same treatment for `.claude-session` patterns (lines 117, 120).

    **src/commands/sessionCommands.ts:**
    - `claudeWorktrees.deleteSession` handler (line 161): Replace `const termName = \`Claude: ${item.label}\`` with `const termName = codeAgent ? codeAgent.getTerminalName(item.label) : \`Claude: ${item.label}\``. The `codeAgent` is already destructured from `services` at line 40.
    - `claudeWorktrees.openInNewWindow` handler (line 273): Same pattern for terminal name construction.

    **src/watchers.ts:**
    - Lines 83, 95: Replace hardcoded `'**/.claude-status'` and `'**/.claude-session'` in global storage watchers with patterns from the `codeAgent` parameter (available via `services.codeAgent` at line 36). Use: `const statusFileName = codeAgent?.getStatusFileName() || '.claude-status'` and build pattern as `'**/' + statusFileName`. Same for session file.
  </action>
  <verify>
    **Absence check** -- no hardcoded strings remain:
    ```bash
    grep -r '\.claude-session\|\.claude-status' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v 'node_modules' | grep -v '\.test\.'
    ```
    Expected: Zero matches outside test files and codeAgents directory.

    ```bash
    grep -r '"Claude: "' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v '\.test\.'
    ```
    Expected: Zero matches.

    **Presence check** -- agent methods are actually used:
    ```bash
    grep -E 'getStatusFileName|getSessionFileName' src/services/SettingsService.ts src/watchers.ts
    ```
    Expected: At least one match per file confirming agent methods are called.

    ```bash
    grep 'getTerminalName' src/commands/sessionCommands.ts
    ```
    Expected: At least one match.

    **Compilation:**
    ```bash
    npm run compile
    ```
    Expected: Zero errors.
  </verify>
  <done>
    All hardcoded `.claude-session`, `.claude-status`, and `Claude:` string literals in non-test shared code (outside src/codeAgents/) are replaced with CodeAgent method calls. Agent method calls (getStatusFileName, getSessionFileName, getTerminalName) are confirmed present in consuming files. Fallback patterns exist only for backward compatibility when codeAgent is undefined. CodeAgent has new abstract method getLocalSettingsFiles() implemented in ClaudeCodeAgent.
  </done>
</task>

</tasks>

<verification>
After task completes:

1. **No hardcoded Claude paths in shared code:**
   ```bash
   grep -r '\.claude-session\|\.claude-status' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v 'node_modules' | grep -v '\.test\.'
   ```
   Expected: Zero results.

2. **No hardcoded terminal names:**
   ```bash
   grep -r '"Claude: "' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v '\.test\.'
   ```
   Expected: Zero results.

3. **Agent methods confirmed in use:**
   ```bash
   grep -cE 'getStatusFileName|getSessionFileName' src/services/SettingsService.ts src/watchers.ts src/ClaudeSessionProvider.ts
   ```
   Expected: Non-zero count for each file.

4. **Compilation clean:**
   ```bash
   npm run compile
   ```
   Expected: No errors.
</verification>

<success_criteria>
- All file path operations in shared code use CodeAgent method calls
- Watch patterns are constructed from agent methods, not hardcoded strings
- Terminal names are constructed via codeAgent.getTerminalName()
- CodeAgent has getLocalSettingsFiles() abstract method, implemented in ClaudeCodeAgent
- Compilation passes (tests may have temporary failures fixed in 01-02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-01-SUMMARY.md`
</output>
