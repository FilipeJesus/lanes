---
phase: 01-foundation-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ClaudeSessionProvider.ts
  - src/services/SettingsService.ts
  - src/services/TerminalService.ts
  - src/services/SessionService.ts
  - src/services/SessionProcessService.ts
  - src/commands/sessionCommands.ts
  - src/localSettings.ts
  - src/watchers.ts
  - src/extension.ts
  - src/codeAgents/CodeAgent.ts
autonomous: true

must_haves:
  truths:
    - "No hardcoded .claude-session or .claude-status string literals exist outside src/codeAgents/ directory"
    - "All file path operations use CodeAgent method calls (getSessionFileName, getStatusFileName, getDataDirectory)"
    - "Watch patterns for session and status files are constructed from CodeAgent methods, not string literals"
    - "localSettings.ts accepts a CodeAgent parameter and uses it to determine config directory and files to propagate"
    - "Terminal names are constructed via codeAgent.getTerminalName(), not hardcoded Claude: prefix"
    - "Delete session finds terminal by agent terminal name, not hardcoded Claude: prefix"
  artifacts:
    - path: "src/ClaudeSessionProvider.ts"
      provides: "Agent-agnostic path functions and session data operations"
      contains: "codeAgent.getSessionFileName"
    - path: "src/services/SettingsService.ts"
      provides: "Watch patterns from agent methods"
      contains: "codeAgent.getStatusFileName"
    - path: "src/localSettings.ts"
      provides: "Agent-aware settings propagation"
      contains: "codeAgent: CodeAgent"
    - path: "src/watchers.ts"
      provides: "Agent-agnostic global storage watch patterns"
      contains: "getStatusFileName"
  key_links:
    - from: "src/ClaudeSessionProvider.ts"
      to: "src/codeAgents/CodeAgent.ts"
      via: "getSessionFileName(), getStatusFileName() calls"
      pattern: "codeAgent\\.get(Session|Status)FileName"
    - from: "src/services/SettingsService.ts"
      to: "src/ClaudeSessionProvider.ts"
      via: "getStatusWatchPattern/getSessionWatchPattern use agent methods"
      pattern: "getStatusFileName|getSessionFileName"
    - from: "src/localSettings.ts"
      to: "src/codeAgents/CodeAgent.ts"
      via: "codeAgent.getDataDirectory() for config path"
      pattern: "codeAgent\\.getDataDirectory"
---

<objective>
Eliminate all hardcoded Claude-specific string literals from shared code. After this plan, every file path, watch pattern, and terminal name is constructed through CodeAgent method calls.

Purpose: Establish the foundation for multi-agent support by ensuring no shared code assumes Claude-specific file names, paths, or conventions. This is a prerequisite for Plan 01-02's service renaming and for Phase 2's agent factory.

Output: All services use CodeAgent methods for agent-specific behavior. No hardcoded `.claude-session`, `.claude-status`, or `Claude:` strings outside `src/codeAgents/`.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-refactoring/01-CONTEXT.md

@src/codeAgents/CodeAgent.ts
@src/ClaudeSessionProvider.ts
@src/services/SettingsService.ts
@src/services/TerminalService.ts
@src/services/SessionService.ts
@src/commands/sessionCommands.ts
@src/localSettings.ts
@src/watchers.ts
@src/extension.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded file paths with CodeAgent method calls</name>
  <files>
    src/ClaudeSessionProvider.ts
    src/services/SettingsService.ts
    src/services/SessionService.ts
    src/services/SessionProcessService.ts
    src/commands/sessionCommands.ts
    src/watchers.ts
    src/extension.ts
    src/codeAgents/CodeAgent.ts
  </files>
  <action>
    Replace all hardcoded `.claude-session`, `.claude-status`, and `Claude:` string literals in shared code with CodeAgent method calls. Specific changes:

    **src/ClaudeSessionProvider.ts:**
    - `getClaudeSessionPath()`: Change fallback from `'.claude-session'` to throwing an error or requiring codeAgent. The `globalCodeAgent` is always set during activation, so the fallback `|| '.claude-session'` on line 118 should use a clear constant imported from a defaults module OR simply assert globalCodeAgent exists. Per user decision (Claude's Discretion), keep the fallback pattern but extract the default values to a `DEFAULTS` constant at the top of the file that documents these are Claude defaults used as fallback only when no agent is configured.
    - `getClaudeStatusPath()`: Same treatment — replace `|| '.claude-status'` fallback on line 129.
    - `getClaudeStatus()`: The fallback JSON.parse branch (lines 234-236) that hardcodes VALID_STATUS_VALUES — wrap with a comment noting this is the legacy Claude fallback. Keep the fallback for backward compatibility but document it.

    **src/services/SettingsService.ts:**
    - `getStatusWatchPattern()`: Replace hardcoded `'**/.claude-status'` and `'.lanes/session_management/**/*/.claude-status'` (lines 101, 104) with patterns constructed from `globalCodeAgent.getStatusFileName()`. Import `getGlobalCodeAgent` from ClaudeSessionProvider. Pattern: `const statusFileName = getGlobalCodeAgent()?.getStatusFileName() || '.claude-status'; return isGlobalStorageEnabled() ? '**/' + statusFileName : '.lanes/session_management/**/*/' + statusFileName;`
    - `getSessionWatchPattern()`: Same treatment for `.claude-session` patterns (lines 117, 120).
    - `getOrCreateExtensionSettingsFile()`: Lines 242-243 already call `getClaudeStatusPath`/`getClaudeSessionPath` — these will be updated when those functions are renamed in Plan 01-02. No change needed here beyond the watch patterns.

    **src/commands/sessionCommands.ts:**
    - `claudeWorktrees.deleteSession` handler (line 161): Replace `const termName = \`Claude: ${item.label}\`` with `const termName = codeAgent ? codeAgent.getTerminalName(item.label) : \`Claude: ${item.label}\``. The `codeAgent` is already destructured from `services` at line 40.
    - `claudeWorktrees.openInNewWindow` handler (line 273): Same pattern — replace `const terminalName = \`Claude: ${item.label}\`` with `const termName = codeAgent ? codeAgent.getTerminalName(item.label) : \`Claude: ${item.label}\``.

    **src/watchers.ts:**
    - Lines 83, 95: Replace hardcoded `'**/.claude-status'` and `'**/.claude-session'` in global storage watchers with patterns constructed from the `codeAgent` parameter (already available via `services.codeAgent` at line 36). Use: `const statusFileName = codeAgent?.getStatusFileName() || '.claude-status'` and build pattern as `'**/' + statusFileName`. Same for session file.

    **src/extension.ts:**
    - Line 64: `SessionService.setOpenClaudeTerminal(TerminalService.openClaudeTerminal)` — This is just a function reference. The rename of `openClaudeTerminal` to `openAgentTerminal` happens in Plan 01-02. No change needed now.

    **src/codeAgents/CodeAgent.ts:**
    - Add a new method `getLocalSettingsFiles()` that returns an array of `{ dir: string, file: string }` objects. For Claude, this returns `[{ dir: '.claude', file: 'settings.local.json' }]`. This method enables localSettings.ts to ask the agent what config files to propagate. Add the abstract method to CodeAgent and implement it in ClaudeCodeAgent.

    **Do NOT rename any functions or classes yet** — that is Plan 01-02's scope.
  </action>
  <verify>
    Run: `grep -r '\.claude-session\|\.claude-status' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v 'node_modules' | grep -v '\.test\.'`

    Expected: Zero matches outside test files and codeAgents directory (except import paths which reference the filename `ClaudeSessionProvider` — that is Plan 01-02's scope).

    Run: `grep -r '"Claude: "' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v '\.test\.'`

    Expected: Zero matches (terminal name construction uses codeAgent.getTerminalName()).

    Run: `npm run compile` — must pass with no errors.
  </verify>
  <done>
    All hardcoded `.claude-session`, `.claude-status`, and `Claude:` string literals in non-test shared code (outside src/codeAgents/) are replaced with CodeAgent method calls. Fallback patterns exist only for backward compatibility when codeAgent is undefined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generalize localSettings.ts and update tests</name>
  <files>
    src/localSettings.ts
    src/codeAgents/ClaudeCodeAgent.ts
    src/services/SessionService.ts
    src/test/core/local-settings.test.ts
    src/test/session/session-status.test.ts
    src/test/session/session-provider.test.ts
    src/test/edgeCases.test.ts
  </files>
  <action>
    **src/localSettings.ts:**
    - Add `CodeAgent` import from `'./codeAgents'`.
    - Change function signature to accept `codeAgent?: CodeAgent` as 4th parameter.
    - Replace hardcoded `CLAUDE_DIR_NAME = '.claude'` and `SETTINGS_FILE_NAME = 'settings.local.json'` with agent-queried values: if `codeAgent` is provided, call `codeAgent.getLocalSettingsFiles()` and iterate over the returned array, propagating each file. If `codeAgent` is not provided, fall back to the current hardcoded values.
    - The core copy/symlink logic stays the same, just parameterized by dir and file name.

    **src/codeAgents/ClaudeCodeAgent.ts:**
    - Implement the `getLocalSettingsFiles()` method: `return [{ dir: '.claude', file: 'settings.local.json' }];`

    **src/services/SessionService.ts:**
    - Find the call to `propagateLocalSettings(baseRepoPath, worktreePath, mode)` and add the `codeAgent` parameter: `propagateLocalSettings(baseRepoPath, worktreePath, mode, codeAgent)`. The `codeAgent` is already available in the `createSession` function parameters.

    **Test updates:**
    - In test files that reference `getClaudeStatus`, `getClaudeSessionPath`, `getClaudeStatusPath`, `ClaudeStatus`, `ClaudeSessionData` — these types/functions have NOT been renamed yet (Plan 01-02 does that). However, if Task 1 changed any function signatures (added required parameters), update the test calls to match.
    - For `local-settings.test.ts`: Update test calls to `propagateLocalSettings` to pass a mock `CodeAgent` as the 4th parameter. Create a simple mock that returns `[{ dir: '.claude', file: 'settings.local.json' }]` from `getLocalSettingsFiles()`.
    - Run full test suite and fix any failures caused by signature changes from Task 1.
  </action>
  <verify>
    Run: `npm test` — all tests must pass.

    Run: `npm run compile` — must compile cleanly.

    Run: `npm run lint` — must pass linting.

    Verify localSettings.ts no longer has hardcoded CLAUDE_DIR_NAME when codeAgent is provided — check the function body uses agent methods.
  </verify>
  <done>
    localSettings.ts is agent-aware: accepts CodeAgent parameter and queries it for config directory/files to propagate. All tests pass. The function falls back to Claude defaults when no agent is provided for backward compatibility.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **No hardcoded Claude paths in shared code:**
   ```bash
   grep -r '\.claude-session\|\.claude-status' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v 'node_modules' | grep -v '\.test\.'
   ```
   Expected: Zero results (except any import paths referencing the filename `ClaudeSessionProvider.ts` which is renamed in Plan 01-02).

2. **No hardcoded terminal names:**
   ```bash
   grep -r '"Claude: "' src/ --include='*.ts' | grep -v 'src/codeAgents/' | grep -v '\.test\.'
   ```
   Expected: Zero results.

3. **Full test suite passes:**
   ```bash
   npm test
   ```
   Expected: All tests pass.

4. **Compilation clean:**
   ```bash
   npm run compile && npm run lint
   ```
   Expected: No errors.
</verification>

<success_criteria>
- All file path operations in shared code use CodeAgent method calls
- Watch patterns are constructed from agent methods, not hardcoded strings
- Terminal names are constructed via codeAgent.getTerminalName()
- localSettings.ts accepts CodeAgent and queries it for config files
- All tests compile and pass
- REQ-F1 is satisfied for non-test code
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-01-SUMMARY.md`
</output>
