---
phase: 01-foundation-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/localSettings.ts
  - src/services/SessionService.ts
  - src/test/core/local-settings.test.ts
  - src/test/session/session-status.test.ts
  - src/test/session/session-provider.test.ts
  - src/test/edgeCases.test.ts
autonomous: true

must_haves:
  truths:
    - "localSettings propagation works for any agent's config files, not just .claude/settings.local.json"
    - "Existing tests pass after signature changes from Plan 01-01"
  artifacts:
    - path: "src/localSettings.ts"
      provides: "Agent-aware settings propagation"
      contains: "codeAgent.getLocalSettingsFiles"
    - path: "src/services/SessionService.ts"
      provides: "Passes codeAgent to propagateLocalSettings"
      contains: "propagateLocalSettings.*codeAgent"
  key_links:
    - from: "src/localSettings.ts"
      to: "src/codeAgents/CodeAgent.ts"
      via: "codeAgent.getLocalSettingsFiles() for config path"
      pattern: "codeAgent\\.getLocalSettingsFiles"
    - from: "src/services/SessionService.ts"
      to: "src/localSettings.ts"
      via: "passes codeAgent as parameter"
      pattern: "propagateLocalSettings.*codeAgent"
---

<objective>
Generalize localSettings.ts to be agent-aware and fix any test failures caused by Plan 01-01's signature changes.

Purpose: Complete the path abstraction by making settings propagation agent-driven. Also stabilize the test suite after 01-01's changes so subsequent plans start from a green test baseline.

Output: Agent-aware localSettings.ts, all tests passing.
</objective>

<execution_context>
@/Users/filipejesus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/filipejesus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-refactoring/01-CONTEXT.md
@.planning/phases/01-foundation-refactoring/01-01-SUMMARY.md

@src/localSettings.ts
@src/services/SessionService.ts
@src/codeAgents/CodeAgent.ts
@src/test/core/local-settings.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generalize localSettings.ts and fix test suite</name>
  <files>
    src/localSettings.ts
    src/services/SessionService.ts
    src/test/core/local-settings.test.ts
    src/test/session/session-status.test.ts
    src/test/session/session-provider.test.ts
    src/test/edgeCases.test.ts
  </files>
  <action>
    **src/localSettings.ts:**
    - Add `CodeAgent` import from `'./codeAgents'`.
    - Change function signature of `propagateLocalSettings` to accept `codeAgent?: CodeAgent` as 4th parameter.
    - Replace hardcoded `CLAUDE_DIR_NAME = '.claude'` and `SETTINGS_FILE_NAME = 'settings.local.json'` with agent-queried values: if `codeAgent` is provided, call `codeAgent.getLocalSettingsFiles()` and iterate over the returned array, propagating each file. If `codeAgent` is not provided, fall back to the current hardcoded values for backward compatibility.
    - The core copy/symlink logic stays the same, just parameterized by dir and file name.

    **src/services/SessionService.ts:**
    - Find the call to `propagateLocalSettings(baseRepoPath, worktreePath, mode)` and add the `codeAgent` parameter: `propagateLocalSettings(baseRepoPath, worktreePath, mode, codeAgent)`. The `codeAgent` is already available in the `createSession` function parameters.

    **Test updates:**
    - For `local-settings.test.ts`: Update test calls to `propagateLocalSettings` to pass a mock `CodeAgent` as the 4th parameter. Create a simple mock that returns `[{ dir: '.claude', file: 'settings.local.json' }]` from `getLocalSettingsFiles()`.
    - Run full test suite (`npm test`) and fix any failures caused by signature changes from Plan 01-01. This may include:
      - Tests that directly construct hardcoded `.claude-session` or `.claude-status` paths and compare them against the now-dynamic output
      - Tests that need a mock `globalCodeAgent` to be set before calling `getClaudeSessionPath`/`getClaudeStatusPath`
    - Do NOT rename types or functions in tests -- that is Plan 01-03/04's scope.
  </action>
  <verify>
    Run: `npm test` -- all tests must pass.

    Run: `npm run compile` -- must compile cleanly.

    Run: `npm run lint` -- must pass linting.

    Verify localSettings.ts uses agent methods:
    ```bash
    grep 'getLocalSettingsFiles' src/localSettings.ts
    ```
    Expected: At least one match confirming agent method is called.

    Verify SessionService passes codeAgent:
    ```bash
    grep 'propagateLocalSettings.*codeAgent' src/services/SessionService.ts
    ```
    Expected: At least one match.
  </verify>
  <done>
    localSettings.ts is agent-aware: accepts CodeAgent parameter and queries it for config directory/files to propagate. All tests pass. The function falls back to Claude defaults when no agent is provided for backward compatibility. Full test suite is green.
  </done>
</task>

</tasks>

<verification>
After task completes:

1. **Agent-aware localSettings:**
   ```bash
   grep -c 'getLocalSettingsFiles\|codeAgent' src/localSettings.ts
   ```
   Expected: Multiple matches.

2. **Full test suite passes:**
   ```bash
   npm test
   ```
   Expected: All tests pass.

3. **Pre-commit checks pass:**
   ```bash
   npm run compile && npm run lint
   ```
   Expected: All pass.
</verification>

<success_criteria>
- localSettings.ts accepts CodeAgent and queries it for config files
- SessionService passes codeAgent to propagateLocalSettings
- All tests compile and pass
- No hardcoded Claude directory names in localSettings.ts when codeAgent is provided
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-02-SUMMARY.md`
</output>
