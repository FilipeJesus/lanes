# =============================================================================
# WORKFLOW TEMPLATE: Refactoring
# =============================================================================
#
# This is a TEMPLATE file for reference. Built-in workflows are not selectable
# in the workflow dropdown - only custom workflows appear there.
#
# TO USE THIS TEMPLATE:
# ---------------------
# 1. Copy this file to your project's .lanes/workflows/ directory
# 2. Customize the workflow for your project's needs
# 3. The workflow will appear in the "Custom" section of the dropdown
#
# AGENTS
# ------
# Agent names used in this workflow (in the `agents:` section and `agent:`
# fields on steps) must match agent definition files in your project's
# .claude/agents/ directory. For example:
#   - `agent: orchestrator` requires .claude/agents/orchestrator.md
#   - `agent: analyzer` requires .claude/agents/analyzer.md
#   - `agent: refactorer` requires .claude/agents/refactorer.md
#
# You can define agents inline in this file (as shown below) or reference
# external agent files. Inline definitions take precedence.
#
# OPTIONAL AGENT FIELD
# --------------------
# The `agent:` field on steps and sub-steps is OPTIONAL. If you omit it,
# the main Claude agent will handle that step directly instead of delegating
# to a specialized sub-agent. This is useful for simpler workflows or steps
# that don't require specialized capabilities.
#
# Example without agent (main Claude handles it):
#   - id: cleanup
#     instructions: |
#       Review all changes and prepare for commit...
#
# Example with agent (delegated to sub-agent):
#   - id: refactor
#     agent: refactorer
#     instructions: |
#       Refactor the code...
#
# WORKFLOW STRUCTURE
# ------------------
# This workflow implements a structured approach to code refactoring:
# 1. Analyze - identify refactoring opportunities
# 2. Define tasks - plan refactoring changes
# 3. Refactor cycle - refactor, test, review for each change
# 4. Final test - ensure all tests pass
# 5. Cleanup - prepare for commit
#
# REQUIRED vs OPTIONAL FIELDS
# ---------------------------
# Required:
#   - name: Unique identifier for the workflow
#   - description: Brief description of purpose
#   - steps: The main workflow sequence
#
# Optional:
#   - agents: Only needed for complex workflows with specialized sub-agents
#   - loops: Only needed for workflows that iterate over multiple tasks
#
# Simple workflows can omit agents and loops. When omitted, the main Claude
# agent handles all steps directly.
#
# =============================================================================

name: refactor
description: Refactor code for improved quality

agents:
  analyzer:
    description: Analyzes code for refactoring opportunities

  refactorer:
    description: Implements refactoring changes

  tester:
    description: Ensures refactoring preserves behavior

loops:
  refactor_cycle:
    - id: refactor
      agent: refactorer
      instructions: |
        Refactor: {task.title}
        Description: {task.description}

        1. Read the code to be refactored
        2. Plan the changes carefully
        3. Make the refactoring changes
        4. Preserve existing behavior

        IMPORTANT: Refactoring should NOT change functionality.

    - id: test
      agent: tester
      instructions: |
        Run tests after refactoring: {task.title}

        1. Run the full test suite
        2. Ensure all existing tests pass
        3. Verify no behavior changes occurred
        4. Check for any performance impacts
      on_fail: retry

    - id: review
      instructions: |
        Review the refactoring of: {task.title}

        1. Verify behavior is preserved
        2. Confirm the code is cleaner
        3. Check that the refactoring achieves its goal
        4. Ensure code style is consistent

steps:
  - id: analyze
    type: action
    agent: analyzer
    instructions: |
      Analyze the code for refactoring:

      1. Identify code smells (duplication, long methods, etc.)
      2. Find opportunities for improvement
      3. Plan the refactoring approach
      4. List files that will be affected

      Focus on changes that improve maintainability without changing behavior.

  - id: define_tasks
    type: action
    instructions: |
      Based on the analysis, define refactoring tasks.

      For each refactoring, define:
      - id: A unique identifier
      - title: Description of the refactoring
      - description: What will be changed and why

      Order tasks to minimize conflicts between changes.

      Call workflow_set_tasks('refactor_cycle', tasks) when done.

  - id: refactor_cycle
    type: loop

  - id: final_test
    type: action
    agent: tester
    instructions: |
      Run full test suite.

      1. Execute all tests in the project
      2. Verify all tests pass after refactoring
      3. Check for any performance regressions
      4. Confirm no functionality was changed

  - id: cleanup
    type: action
    instructions: |
      Review all changes and prepare for commit.

      1. Review the cumulative changes
      2. Ensure code is properly formatted
      3. Clean up any temporary files
      4. Summarize what was refactored and the improvements made
