# =============================================================================
# WORKFLOW TEMPLATE: Bug Fix
# =============================================================================
#
# This is a TEMPLATE file for reference. Built-in workflows are not selectable
# in the workflow dropdown - only custom workflows appear there.
#
# TO USE THIS TEMPLATE:
# ---------------------
# 1. Copy this file to your project's .lanes/workflows/ directory
# 2. Customize the workflow for your project's needs
# 3. The workflow will appear in the "Custom" section of the dropdown
#
# AGENTS
# ------
# Agent names used in this workflow (in the `agents:` section and `agent:`
# fields on steps) must match agent definition files in your project's
# .claude/agents/ directory. For example:
#   - `agent: orchestrator` requires .claude/agents/orchestrator.md
#   - `agent: investigator` requires .claude/agents/investigator.md
#   - `agent: fixer` requires .claude/agents/fixer.md
#
# You can define agents inline in this file (as shown below) or reference
# external agent files. Inline definitions take precedence.
#
# OPTIONAL AGENT FIELD
# --------------------
# The `agent:` field on steps and sub-steps is OPTIONAL. If you omit it,
# the main Claude agent will handle that step directly instead of delegating
# to a specialized sub-agent. This is useful for simpler workflows or steps
# that don't require specialized capabilities.
#
# Example without agent (main Claude handles it):
#   - id: cleanup
#     instructions: |
#       Clean up and prepare for commit...
#
# Example with agent (delegated to sub-agent):
#   - id: fix
#     agent: fixer
#     instructions: |
#       Fix the identified issue...
#
# WORKFLOW STRUCTURE
# ------------------
# This workflow implements a structured approach to fixing bugs:
# 1. Investigate - understand the root cause
# 2. Define fixes - plan the fix strategy
# 3. Fix cycle - fix, verify, review for each identified issue
# 4. Final verify - run full test suite
# 5. Cleanup - prepare for commit
#
# REQUIRED vs OPTIONAL FIELDS
# ---------------------------
# Required:
#   - name: Unique identifier for the workflow
#   - description: Brief description of purpose
#   - steps: The main workflow sequence
#
# Optional:
#   - agents: Only needed for complex workflows with specialized sub-agents
#   - loops: Only needed for workflows that iterate over multiple tasks
#
# Simple workflows can omit agents and loops. When omitted, the main Claude
# agent handles all steps directly.
#
# =============================================================================

name: bugfix
description: Investigate and fix a bug

agents:
  # The orchestrator has access to ALL tools by default.
  # It needs full access to coordinate work, spawn sub-agents, and handle
  # situations where sub-agents cannot complete tasks.
  orchestrator:
    description: Coordinates investigation and fix
    # No tool restrictions - orchestrator needs full access

  investigator:
    description: Investigates bug root cause
    tools:
      - Read
      - Glob
      - Grep
      - Bash
    cannot:
      - Write
      - Edit
      - commit

  fixer:
    description: Implements bug fixes
    tools:
      - Read
      - Write
      - Edit
      - Bash
      - Glob
      - Grep
    cannot:
      - commit
      - Task

  verifier:
    description: Verifies fixes work correctly
    tools:
      - Read
      - Bash
    cannot:
      - Write
      - Edit
      - commit

loops:
  fix_cycle:
    - id: fix
      agent: fixer
      instructions: |
        Fix: {task.title}
        Description: {task.description}

        1. Read the affected code
        2. Understand the issue context
        3. Implement the fix
        4. Verify the fix compiles

    - id: verify
      agent: verifier
      instructions: |
        Verify the fix for: {task.title}

        1. Run relevant tests
        2. Confirm the bug is resolved
        3. Check for regressions
        4. Test edge cases related to the fix
      on_fail: retry

    - id: review
      instructions: |
        Review the fix for: {task.title}

        1. Verify the fix is correct
        2. Check for side effects
        3. Ensure no regressions were introduced
        4. Confirm the root cause was addressed

steps:
  - id: investigate
    type: action
    agent: investigator
    instructions: |
      Investigate the bug:

      1. Reproduce the issue if possible
      2. Identify the root cause
      3. Document affected code paths
      4. Determine the scope of the fix needed

      Be thorough - understanding the bug is crucial to fixing it correctly.

  - id: define_fixes
    type: action
    agent: orchestrator
    instructions: |
      Based on the investigation, define fix tasks.

      For each fix needed, define:
      - id: A unique identifier
      - title: Description of the fix
      - description: Details about what to change and why

      Call workflow_set_tasks('fix_cycle', tasks) when done.

  - id: fix_cycle
    type: loop

  - id: final_verify
    type: action
    agent: verifier
    instructions: |
      Run full test suite to verify no regressions.

      1. Run all tests in the project
      2. Check edge cases related to the fix
      3. Verify the original bug is resolved
      4. Confirm no new issues were introduced

  - id: cleanup
    type: action
    instructions: |
      Clean up and prepare for commit.

      1. Remove any debug code
      2. Clean up temporary files
      3. Ensure code is properly formatted
      4. Summarize what was fixed and how
