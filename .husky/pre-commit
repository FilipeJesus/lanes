#!/bin/sh

echo "ğŸ” Running pre-commit checks..."

# Compile TypeScript
echo "ğŸ“¦ Compiling TypeScript..."
npm run compile || exit 1

# Run ESLint
echo "ğŸ§¹ Running ESLint..."
npm run lint || exit 1

# Run tests (use xvfb-run if available for headless environments)
echo "ğŸ§ª Running tests..."
if [ -f /.dockerenv ] || [ -f /run/.containerenv ]; then
    xvfb-run -a npm run test || exit 1
else
    npm run test || exit 1
fi

# Run IntelliJ plugin tests if plugin files changed
INTELLIJ_CHANGED=$(git diff --cached --name-only -- 'intellij-plugin/' | head -1)
if [ -n "$INTELLIJ_CHANGED" ]; then
    echo "ğŸ§ª Running IntelliJ plugin tests..."
    JAVA17_HOME="${JAVA17_HOME:-/home/linuxbrew/.linuxbrew/Cellar/openjdk@17/17.0.18/libexec}"
    if [ -d "$JAVA17_HOME" ]; then
        (cd intellij-plugin && JAVA_HOME="$JAVA17_HOME" ./gradlew test) || exit 1
    else
        echo "âš ï¸  Skipping IntelliJ tests: Java 17 not found at $JAVA17_HOME (set JAVA17_HOME to override)"
    fi
fi

# Rebuild docs.html if any docs source files changed
DOCS_CHANGED=$(git diff --cached --name-only -- 'docs/docs-shell.html' 'docs/sections/' | head -1)
if [ -n "$DOCS_CHANGED" ]; then
    echo "ğŸ“„ Rebuilding docs.html..."
    npm run build:docs --prefix docs || exit 1
    git add docs/docs.html
fi

echo "âœ… All checks passed!"
